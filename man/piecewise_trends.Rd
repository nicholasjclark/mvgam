% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/trend_system.R
\name{PW}
\alias{PW}
\title{Specify piecewise linear or logistic trends in \pkg{mvgam} models}
\usage{
PW(
  time = NA,
  series = NA,
  cap = NA,
  n_changepoints = 10,
  changepoint_range = 0.8,
  changepoint_scale = 0.05,
  growth = "linear",
  n_lv = NULL
)
}
\arguments{
\item{time}{The unquoted name of the variable that represents time in the
supplied \code{data}. This variable should be either a \code{numeric} or \code{integer}
variable. Defaults to \code{time} to align with brms conventions, allowing
flexible time variable naming without requiring explicit "time" columns.
When using the default, a one-time warning will be issued.}

\item{series}{The unquoted name of the variable that represents the series
identifier in the supplied \code{data}. This variable should be either a
\code{character} or \code{factor} variable. Defaults to \code{series} following mvgam
conventions, allowing flexible series variable naming. When using the
default, a one-time warning will be issued.}

\item{cap}{The unquoted name of the variable in \code{data} that specifies the
carrying capacity for logistic growth models. Required when \code{growth = 'logistic'}.
This variable should be numeric and can vary by time and series if necessary.
Defaults to \code{cap} when not specified, with a warning for logistic models.}

\item{n_changepoints}{A non-negative integer specifying the number of
potential changepoints. Potential changepoints are selected uniformly from
the first \code{changepoint_range} proportion of timepoints in \code{data}.
Default is \code{10}.}

\item{changepoint_range}{Proportion of history in \code{data} in which trend
changepoints will be estimated. Defaults to \code{0.8} for the first 80\%.}

\item{changepoint_scale}{Parameter modulating the flexibility of the
automatic changepoint selection by altering the scale parameter of a
Laplace distribution. The resulting prior will be
\code{double_exponential(0, changepoint_scale)}. Large values will allow many
changepoints and a more flexible trend, while small values will allow few
changepoints. Default is \code{0.05}.}

\item{growth}{Character string specifying either \code{'linear'} or \code{'logistic'}
growth of the trend. If \code{'logistic'}, the \code{cap} argument must specify the
variable containing maximum saturation points for the trend (see
details and examples in \code{\link{mvgam}} for more information). Default
is \code{'linear'}.}
}
\value{
An object of class \code{mvgam_trend}, which contains a list of
arguments to be interpreted by the parsing functions in \code{mvgam}.
}
\description{
Set up piecewise linear or logistic trend models in \code{mvgam}. These
functions do not evaluate their arguments – they exist purely to help set up
a model with particular piecewise trend models.
}
\details{
\emph{Offsets and intercepts}:
For each of these trend models, an offset parameter is included in the trend
estimation process. This parameter will be incredibly difficult to identify
if you also include an intercept in the observation formula. For that
reason, it is highly recommended that you drop the intercept from the
formula (i.e. \code{y ~ x + 0} or \code{y ~ x - 1}, where \code{x} are your optional
predictor terms).

\emph{Logistic growth and the cap variable}:
When forecasting growth, there is often some maximum achievable point that a
time series can reach. For example, total market size, total population size
or carrying capacity in population dynamics. It can be advantageous for the
forecast to saturate at or near this point so that predictions are more
sensible.

This function allows you to make forecasts using a logistic growth trend
model, with a specified carrying capacity. Note that this capacity does not
need to be static over time; it can vary with each series × timepoint
combination if necessary. But you must supply a \code{cap} value for each
observation in the data when using \code{growth = 'logistic'}.

For observation families that use a non-identity link function, the \code{cap}
value will be internally transformed to the link scale (i.e. your specified
\code{cap} will be log-transformed if you are using a \code{poisson()} or \code{nb()}
family). It is therefore important that you specify the \code{cap} values on the
scale of your outcome. Note also that no missing values are allowed in
\code{cap}.
}
\examples{
\donttest{
# Basic linear piecewise trend with defaults (will issue warnings)
set.seed(101)
linear_data <- data.frame(
  y = rnorm(50, mean = 1:50, sd = 2),
  time = 1:50,
  series = factor("series_1")
)

mod1 <- mvgam(
  y ~ 0,
  trend_model = PW(growth = "linear"),
  data = linear_data,
  chains = 2,
  silent = 2
)

# Custom variable names for time and series
growth_data <- data.frame(
  count = rpois(60, exp(seq(0, 2, length.out = 60))),
  week = 1:60,
  population = factor("pop_A"),
  carrying_capacity = 100
)

mod2 <- mvgam(
  count ~ 0,
  trend_model = PW(
    time = week,
    series = population,
    cap = carrying_capacity,
    growth = "logistic",
    n_changepoints = 5
  ),
  family = poisson(),
  data = growth_data,
  chains = 2,
  silent = 2
)

# Example of logistic growth with possible changepoints
dNt <- function(r, N, k) {
  r * N * (k - N)
}

Nt <- function(r, N, t, k) {
  for (i in 1:(t - 1)) {
    if (i \%in\% c(5, 15, 25, 41, 45, 60, 80)) {
      N[i + 1] <- max(
        1,
        N[i] + dNt(r + runif(1, -0.1, 0.1), N[i], k)
      )
    } else {
      N[i + 1] <- max(1, N[i] + dNt(r, N[i], k))
    }
  }
  N
}

set.seed(11)
expected <- Nt(0.004, 2, 100, 30)
plot(expected, xlab = "Time")

y <- rpois(100, expected)
plot(y, xlab = "Time")

mod_data <- data.frame(
  y = y,
  time = 1:100,
  cap = 35,
  series = as.factor("series_1")
)
plot_mvgam_series(data = mod_data)

mod3 <- mvgam(
  y ~ 0,
  trend_model = PW(growth = "logistic"),  # Uses default 'cap' variable
  family = poisson(),
  data = mod_data,
  chains = 2,
  silent = 2
)
summary(mod3)

hc <- hindcast(mod3)
plot(hc)

library(ggplot2)
mcmc_plot(mod3, variable = "delta_trend", regex = TRUE) +
  scale_y_discrete(labels = mod3$trend_model$changepoints) +
  labs(
    y = "Potential changepoint",
    x = "Rate change"
  )

how_to_cite(mod3)
}

}
\references{
Taylor, Sean J., and Benjamin Letham. "Forecasting at scale."
The American Statistician 72.1 (2018): 37–45.
}
\author{
Nicholas J Clark
}
