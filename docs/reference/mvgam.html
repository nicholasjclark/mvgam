<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function estimates the posterior distribution for Generalised Additive Models (GAMs) that can include
smooth spline functions, specified in the GAM formula, as well as latent temporal processes,
specified by trend_model. Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing observation-level effects.
Prior specifications are flexible and explicitly encourage users to apply
prior distributions that actually reflect their beliefs. In addition, model fits can easily be assessed and
compared with posterior predictive checks, forecast comparisons and leave-one-out / leave-future-out cross-validation."><title>Fit a Bayesian dynamic GAM to a univariate or multivariate set of time series — mvgam • mvgam</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit a Bayesian dynamic GAM to a univariate or multivariate set of time series — mvgam"><meta property="og:description" content="This function estimates the posterior distribution for Generalised Additive Models (GAMs) that can include
smooth spline functions, specified in the GAM formula, as well as latent temporal processes,
specified by trend_model. Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing observation-level effects.
Prior specifications are flexible and explicitly encourage users to apply
prior distributions that actually reflect their beliefs. In addition, model fits can easily be assessed and
compared with posterior predictive checks, forecast comparisons and leave-one-out / leave-future-out cross-validation."><meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit a Bayesian dynamic GAM to a univariate or multivariate set of time series</h1>
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/R/mvgam.R" class="external-link"><code>R/mvgam.R</code></a></small>
      <div class="d-none name"><code>mvgam.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function estimates the posterior distribution for Generalised Additive Models (GAMs) that can include
smooth spline functions, specified in the GAM formula, as well as latent temporal processes,
specified by <code>trend_model</code>. Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing observation-level effects.
Prior specifications are flexible and explicitly encourage users to apply
prior distributions that actually reflect their beliefs. In addition, model fits can easily be assessed and
compared with posterior predictive checks, forecast comparisons and leave-one-out / leave-future-out cross-validation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mvgam</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  <span class="va">trend_formula</span>,</span>
<span>  <span class="va">knots</span>,</span>
<span>  <span class="va">trend_knots</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">data_train</span>,</span>
<span>  <span class="va">newdata</span>,</span>
<span>  <span class="va">data_test</span>,</span>
<span>  run_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prior_simulation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_model_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  share_obs_params <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  use_lv <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">n_lv</span>,</span>
<span>  <span class="va">trend_map</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="st">"None"</span>,</span>
<span>  drift <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  noncentred <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">priors</span>,</span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  lfo <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  residuals <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  use_stan <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.backend"</span>, <span class="st">"cmdstanr"</span><span class="op">)</span>,</span>
<span>  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.algorithm"</span>, <span class="st">"sampling"</span><span class="op">)</span>,</span>
<span>  autoformat <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  save_all_pars <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  max_treedepth <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  adapt_delta <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">jags_path</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>A <code>character</code> string specifying the GAM observation model formula. These are exactly like the formula
for a GLM except that smooth terms, <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/t2.html" class="external-link">t2()</a></code>, as well as time-varying
<code><a href="dynamic.html">dynamic()</a></code> terms and nonparametric <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> terms, can be added to the right hand side
to specify that the linear predictor depends on smooth functions of predictors
(or linear functionals of these). In <code><a href="mvgam_families.html">nmix()</a></code> family models, the <code>formula</code> is used to
set up a linear predictor for the detection probability. Details of the formula syntax used by <span class="pkg">mvgam</span>
can be found in <code><a href="mvgam_formulae.html">mvgam_formulae</a></code></p></dd>


<dt>trend_formula</dt>
<dd><p>An optional <code>character</code> string specifying the GAM process model formula. If
supplied, a linear predictor will be modelled for the latent trends to capture process model evolution
separately from the observation model. Should not have a response variable specified on the left-hand side
of the formula (i.e. a valid option would be <code>~ season + s(year)</code>). Also note that you should not use
the identifier <code>series</code> in this formula to specify effects that vary across time series. Instead you should use
<code>trend</code>. This will ensure that models in which a <code>trend_map</code> is supplied will still work consistently
(i.e. by allowing effects to vary across process models, even when some time series share the same underlying
process model). This feature is only currently available for <code><a href="RW.html">RW()</a></code>, <code><a href="RW.html">AR()</a></code> and <code><a href="RW.html">VAR()</a></code> trend models.
In <code><a href="mvgam_families.html">nmix()</a></code> family models, the <code>trend_formula</code> is used to set up a linear predictor for the underlying
latent abundance. Be aware that it can be very challenging to simultaneously estimate intercept parameters
for both the observation mode (captured by <code>formula</code>) and the process model (captured by <code>trend_formula</code>).
Users are recommended to drop one of these using the <code>- 1</code> convention in the formula right hand side.</p></dd>


<dt>knots</dt>
<dd><p>An optional <code>list</code> containing user specified knot values to be used for basis construction.
For most bases the user simply supplies the knots to be used, which must match up with the <code>k</code> value supplied
(note that the number of knots is not always just <code>k</code>). Different terms can use different numbers of knots,
unless they share a covariate</p></dd>


<dt>trend_knots</dt>
<dd><p>As for <code>knots</code> above, this is an optional <code>list</code> of knot values for smooth
functions within the <code>trend_formula</code></p></dd>


<dt>data</dt>
<dd><p>A <code>dataframe</code> or <code>list</code> containing the model response variable and covariates
required by the GAM <code>formula</code> and optional <code>trend_formula</code>. Most models should include columns:</p><ul><li><p><code>series</code> (a <code>factor</code> index of the series IDs; the number of levels should be identical
to the number of unique series labels (i.e. <code>n_series = length(levels(data$series))</code>))</p></li>
<li><p><code>time</code> (<code>numeric</code> or <code>integer</code> index of the time point for each observation).
For most dynamic trend types available in <code>mvgam</code> (see argument <code>trend_model</code>), time should be
measured in discrete, regularly spaced intervals (i.e. <code>c(1, 2, 3, ...)</code>). However you can
use irregularly spaced intervals if using <code>trend_model = CAR(1)</code>, though note that any
temporal intervals that are exactly <code>0</code> will be adjusted to a very small number
(<code>1e-12</code>) to prevent sampling errors. See an example of <code><a href="RW.html">CAR()</a></code> trends in <code><a href="RW.html">CAR</a></code></p></li>
</ul><p>Note however that there are special cases where these identifiers are not needed. For
example, models with hierarchical temporal correlation processes (e.g. <code>AR(gr = region, subgr = species)</code>)
should NOT include a <code>series</code> identifier, as this will be constructed internally (see
<code><a href="mvgam_trends.html">mvgam_trends</a></code> and <code><a href="RW.html">AR</a></code> for details). <code>mvgam</code> can also fit models that do not
include a <code>time</code> variable if there are no temporal dynamic structures included (i.e. <code>trend_model = 'None'</code> or
<code>trend_model = ZMVN()</code>). <code>data</code> should also include any other variables to be included in
the linear predictor of <code>formula</code></p></dd>


<dt>data_train</dt>
<dd><p>Deprecated. Still works in place of <code>data</code> but users are recommended to use
<code>data</code> instead for more seamless integration into <code>R</code> workflows</p></dd>


<dt>newdata</dt>
<dd><p>Optional <code>dataframe</code> or <code>list</code> of test data containing the same variables
as in <code>data</code>. If included, the
observations in variable <code>y</code> will be set to <code>NA</code> when fitting the model so that posterior
simulations can be obtained</p></dd>


<dt>data_test</dt>
<dd><p>Deprecated. Still works in place of <code>newdata</code> but users are recommended to use
<code>newdata</code> instead for more seamless integration into <code>R</code> workflows</p></dd>


<dt>run_model</dt>
<dd><p><code>logical</code>. If <code>FALSE</code>, the model is not fitted but instead the function will
return the model file and the data / initial values that are needed to fit the model outside of <code>mvgam</code></p></dd>


<dt>prior_simulation</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, no observations are fed to the model, and instead
simulations from prior distributions are returned</p></dd>


<dt>return_model_data</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, the list of data that is needed to fit the
model is returned, along with the initial values for smooth and AR parameters, once the model is fitted.
This will be helpful if users wish to modify the model file to add
other stochastic elements that are not currently available in <code>mvgam</code>.
Default is <code>FALSE</code> to reduce
the size of the returned object, unless <code>run_model == FALSE</code></p></dd>


<dt>family</dt>
<dd><p><code>family</code> specifying the exponential observation family for the series. Currently supported
families are:</p><ul><li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code> for real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">betar()</a></code> for proportional data on <code>(0,1)</code></p></li>
<li><p><code><a href="mvgam_families.html">lognormal()</a></code> for non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">student_t()</a></code> for real-valued data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma()</a></code> for non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">bernoulli()</a></code> for binary data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code> for count data</p></li>
<li><p><code><a href="mvgam_families.html">nb()</a></code> for overdispersed count data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> for count data with imperfect detection when the number of trials is known;
note that the <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> function must be used to bind the discrete observations and the discrete number
of trials</p></li>
<li><p><code><a href="mvgam_families.html">beta_binomial()</a></code> as for <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> but allows for overdispersion</p></li>
<li><p><code><a href="mvgam_families.html">nmix()</a></code> for count data with imperfect detection when the number of trials
is unknown and should be modeled via a State-Space N-Mixture model.
The latent states are Poisson, capturing the 'true' latent
abundance, while the observation process is Binomial to account for
imperfect detection.
See <code><a href="mvgam_families.html">mvgam_families</a></code> for an example of how to use this family</p></li>
</ul><p>Note that only <code><a href="mvgam_families.html">nb()</a></code> and <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code> are available if using <code>JAGS</code> as the backend.
Default is <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code>.
See <code><a href="mvgam_families.html">mvgam_families</a></code> for more details</p></dd>


<dt>share_obs_params</dt>
<dd><p><code>logical</code>. If <code>TRUE</code> and the <code>family</code>
has additional family-specific observation parameters (e.g. variance components in
<code><a href="mvgam_families.html">student_t()</a></code> or <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code>, or dispersion parameters in <code><a href="mvgam_families.html">nb()</a></code> or <code><a href="mvgam_families.html">betar()</a></code>),
these parameters will be shared across all outcome variables. This is handy if you have multiple
outcomes (time series in most <code>mvgam</code> models) that you believe share some properties,
such as being from the same species over different spatial units. Default is <code>FALSE</code>.</p></dd>


<dt>use_lv</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, use dynamic factors to estimate series'
latent trends in a reduced dimension format. Only available for
<code><a href="RW.html">RW()</a></code>, <code><a href="RW.html">AR()</a></code> and <code><a href="GP.html">GP()</a></code> trend models. Defaults to <code>FALSE</code></p></dd>


<dt>n_lv</dt>
<dd><p><code>integer</code> the number of latent dynamic factors to use if <code>use_lv == TRUE</code>.
Cannot be <code>&gt; n_series</code>. Defaults arbitrarily to <code>min(2, floor(n_series / 2))</code></p></dd>


<dt>trend_map</dt>
<dd><p>Optional <code>data.frame</code> specifying which series should depend on which latent
trends. Useful for allowing multiple series to depend on the same latent trend process, but with
different observation processes. If supplied, a latent factor model is set up by setting
<code>use_lv = TRUE</code> and using the mapping to set up the shared trends. Needs to have column names
<code>series</code> and <code>trend</code>, with integer values in the <code>trend</code> column to state which trend each series
should depend on. The <code>series</code> column should have a single unique entry for each series in the
data (names should perfectly match factor levels of the <code>series</code> variable in <code>data</code>). Note that
if this is supplied, the intercept parameter in the process model will NOT be automatically suppressed.
See examples for details</p></dd>


<dt>trend_model</dt>
<dd><p><code>character</code> or  <code>function</code> specifying the time series dynamics for the latent trend. Options are:</p><ul><li><p><code>None</code> (no latent trend component; i.e. the GAM component is all that contributes to the linear predictor,
and the observation process is the only source of error; similarly to what is estimated by <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></code>)</p></li>
<li><p><code>ZMVN</code> or <code><a href="ZMVN.html">ZMVN()</a></code> (Zero-Mean Multivariate Normal; only available in <code>Stan</code>)</p></li>
<li><p><code>'RW'</code> or <code><a href="RW.html">RW()</a></code></p></li>
<li><p><code>'AR1'</code> or <code>AR(p = 1)</code></p></li>
<li><p><code>'AR2'</code> or <code>AR(p = 2)</code></p></li>
<li><p><code>'AR3'</code> or <code>AR(p = 3)</code></p></li>
<li><p><code>'CAR1'</code> or <code>CAR(p = 1)</code></p></li>
<li><p><code>'VAR1'</code>  or <code><a href="RW.html">VAR()</a></code>(only available in <code>Stan</code>)</p></li>
<li><p><code>'PWlogistic</code>, <code>'PWlinear'</code> or <code><a href="piecewise_trends.html">PW()</a></code> (only available in <code>Stan</code>)</p></li>
<li><p><code>'GP'</code> or <code><a href="GP.html">GP()</a></code> (Gaussian Process with squared exponential kernel;
only available in <code>Stan</code>)</p></li>
</ul><p>For all trend types apart from <code><a href="ZMVN.html">ZMVN()</a></code>, <code><a href="GP.html">GP()</a></code>, <code><a href="RW.html">CAR()</a></code> and <code><a href="piecewise_trends.html">PW()</a></code>, moving average and/or correlated
process error terms can also be estimated (for example, <code>RW(cor = TRUE)</code> will set up a
multivariate Random Walk if <code>n_series &gt; 1</code>). It is also possible for many multivariate trends
to estimate hierarchical correlations if the data are structured among levels of
a relevant grouping factor. See <a href="mvgam_trends.html">mvgam_trends</a> for more details and see <a href="ZMVN.html">ZMVN</a> for an example.</p></dd>


<dt>drift</dt>
<dd><p>Deprecated. If you wish to estimate drift parameters, include parametric fixed effects
of 'time' in your formulae instead.</p></dd>


<dt>noncentred</dt>
<dd><p><code>logical</code> Use the non-centred parameterisation for autoregressive
trend models? Setting to <code>TRUE</code> will reparameterise the model to avoid possible
degeneracies that can show up when estimating the latent dynamic random effects. For some
models, this can produce big gains in efficiency, meaning that fewer burnin and sampling
iterations are required for posterior exploration. But for other models, where the data
are highly informative about the latent dynamic processes, this can actually lead to worse
performance. Only available for certain trend models
(i.e. <code><a href="RW.html">RW()</a></code>, <code><a href="RW.html">AR()</a></code>, or <code><a href="RW.html">CAR()</a></code>, or for
<code>trend = 'None'</code> when using a <code>trend_formula</code>). Not yet available for moving average or
correlated error models</p></dd>


<dt>chains</dt>
<dd><p><code>integer</code> specifying the number of parallel chains for the model. Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>burnin</dt>
<dd><p><code>integer</code> specifying the number of warmup iterations of the Markov chain to run
to tune sampling algorithms. Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>samples</dt>
<dd><p><code>integer</code> specifying the number of post-warmup iterations of the Markov chain to run for
sampling the posterior distribution</p></dd>


<dt>thin</dt>
<dd><p>Thinning interval for monitors.  Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>parallel</dt>
<dd><p><code>logical</code> specifying whether multiple cores should be used for
generating MCMC simulations in parallel. If <code>TRUE</code>, the number of cores to use will be
<code>min(c(chains, parallel::detectCores() - 1))</code></p></dd>


<dt>threads</dt>
<dd><p><code>integer</code> Experimental option to use multithreading for within-chain
parallelisation in <code>Stan</code>. We recommend its use only if you are experienced with
<code>Stan</code>'s <code>reduce_sum</code> function and have a slow running model that cannot be sped
up by any other means. Currently works for all families apart from <code><a href="mvgam_families.html">nmix()</a></code> and
when using <code>Cmdstan</code> as the backend</p></dd>


<dt>priors</dt>
<dd><p>An optional <code>data.frame</code> with prior
definitions (in JAGS or Stan syntax) or, preferentially, If using Stan, a vector containing
objects of class <code>brmsprior</code> (see. <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></code> for details).
See <a href="get_mvgam_priors.html">get_mvgam_priors</a> and Details' for more information on changing default prior distributions</p></dd>


<dt>refit</dt>
<dd><p>Logical indicating whether this is a refit, called using <a href="update.mvgam.html">update.mvgam</a>. Users should leave
as <code>FALSE</code></p></dd>


<dt>lfo</dt>
<dd><p>Logical indicating whether this is part of a call to <a href="lfo_cv.mvgam.html">lfo_cv.mvgam</a>. Returns a
lighter version of the model with no residuals and fewer monitored parameters to speed up
post-processing. But other downstream functions will not work properly, so users should always
leave this set as <code>FALSE</code></p></dd>


<dt>residuals</dt>
<dd><p>Logical indicating whether to compute series-level randomized quantile residuals and include
them as part of the returned object. Defaults to <code>TRUE</code>, but you can set to <code>FALSE</code> to save
computational time and reduce the size of the returned object (users can always add residuals to
an object of class <code>mvgam</code> using <a href="add_residuals.mvgam.html">add_residuals</a>)</p></dd>


<dt>use_stan</dt>
<dd><p>Logical. If <code>TRUE</code>, the model will be compiled and sampled using
Hamiltonian Monte Carlo with a call to <code><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></code> or
a call to <code><a href="https://mc-stan.org/rstan/reference/stan.html" class="external-link">stan</a></code>. Note that
there are many more options when using <code>Stan</code> vs <code>JAGS</code></p></dd>


<dt>backend</dt>
<dd><p>Character string naming the package to use as the backend for fitting
the Stan model (if <code>use_stan = TRUE</code>). Options are "cmdstanr" (the default) or "rstan". Can be set globally
for the current R session via the <code>"brms.backend"</code> option (see <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></code>). Details on
the rstan and cmdstanr packages are available at https://mc-stan.org/rstan/ and
https://mc-stan.org/cmdstanr/, respectively</p></dd>


<dt>algorithm</dt>
<dd><p>Character string naming the estimation approach to use.
Options are <code>"sampling"</code> for MCMC (the default), <code>"meanfield"</code> for
variational inference with factorized normal distributions,
<code>"fullrank"</code> for variational inference with a multivariate normal
distribution, <code>"laplace"</code> for a Laplace approximation (only available
when using cmdstanr as the backend) or <code>"pathfinder"</code> for the pathfinder
algorithm (only currently available when using cmdstanr as the backend).
Can be set globally for the current <span style="R">R</span> session via the
<code>"brms.algorithm"</code> option (see <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></code>). Limited testing
suggests that <code>"meanfield"</code> performs best out of the non-MCMC approximations for
dynamic GAMs, possibly because of the difficulties estimating covariances among the
many spline parameters and latent trend parameters. But rigorous testing has not
been carried out</p></dd>


<dt>autoformat</dt>
<dd><p><code>Logical</code>. Use the <code>stanc</code> parser to automatically format the
<code>Stan</code> code and check for deprecations. Only for development purposes, so leave to <code>TRUE</code></p></dd>


<dt>save_all_pars</dt>
<dd><p><code>Logical</code> flag to indicate if draws from all
variables defined in Stan's <code>parameters</code> block should be saved
(default is <code>FALSE</code>).</p></dd>


<dt>max_treedepth</dt>
<dd><p>positive integer placing a cap on the number of simulation steps evaluated during each iteration when
<code>use_stan == TRUE</code>. Default is <code>12</code>. Increasing this value can sometimes help with exploration of complex
posterior geometries, but it is rarely fruitful to go above a <code>max_treedepth</code> of <code>14</code></p></dd>


<dt>adapt_delta</dt>
<dd><p>positive numeric between <code>0</code> and <code>1</code> defining the target average proposal acceptance probability
during Stan's adaptation period, if <code>use_stan == TRUE</code>. Default is <code>0.8</code>. In general you should not need to change adapt_delta
unless you see a warning message about divergent transitions, in which case you can increase adapt_delta from the default
to a value closer to <code>1</code> (e.g. from <code>0.95</code> to <code>0.99</code>, or from <code>0.99</code> to <code>0.999</code>, etc).
The step size used by the numerical integrator is a function of <code>adapt_delta</code> in that increasing
<code>adapt_delta</code> will result in a smaller step size and fewer divergences. Increasing <code>adapt_delta</code> will
typically result in a slower sampler, but it will always lead to a more robust sampler</p></dd>


<dt>silent</dt>
<dd><p>Verbosity level between <code>0</code> and <code>2</code>. If <code>1</code> (the default), most of the informational
messages of compiler and sampler are suppressed. If <code>2</code>, even more messages are suppressed. The
actual sampling progress is still printed. Set <code>refresh = 0</code> to turn this off as well. If using
<code>backend = "rstan"</code> you can also set open_progress = FALSE to prevent opening additional
progress bars.</p></dd>


<dt>jags_path</dt>
<dd><p>Optional character vector specifying the path to the location of the <code>JAGS</code> executable (.exe) to use
for modelling if <code>use_stan == FALSE</code>. If missing, the path will be recovered from a call to <code>findjags</code></p></dd>


<dt>...</dt>
<dd><p>Further arguments passed to Stan.
For <code>backend = "rstan"</code> the arguments are passed to
<code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></code> or <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html" class="external-link">vb</a></code>.
For <code>backend = "cmdstanr"</code> the arguments are passed to the
<code><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">cmdstanr::sample</a></code>, <code><a href="https://mc-stan.org/cmdstanr/reference/model-method-variational.html" class="external-link">cmdstanr::variational</a></code>,
<code><a href="https://mc-stan.org/cmdstanr/reference/model-method-laplace.html" class="external-link">cmdstanr::laplace</a></code> or
<code><a href="https://mc-stan.org/cmdstanr/reference/model-method-pathfinder.html" class="external-link">cmdstanr::pathfinder</a></code> method</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>list</code> object of class <code>mvgam</code> containing model output, the text representation of the model file,
the mgcv model output (for easily generating simulations at
unsampled covariate values), Dunn-Smyth residuals for each series and key information needed
for other functions in the package. See <code><a href="mvgam-class.html">mvgam-class</a></code> for details.
Use <code>methods(class = "mvgam")</code> for an overview on available methods.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Dynamic GAMs are useful when we wish to predict future values from time series that show temporal dependence
but we do not want to rely on extrapolating from a smooth term (which can sometimes lead to unpredictable and unrealistic behaviours).
In addition, smooths can often try to wiggle excessively to capture any autocorrelation that is present in a time series,
which exacerbates the problem of forecasting ahead. As GAMs are very naturally viewed through a Bayesian lens, and we often
must model time series that show complex distributional features and missing data, parameters for <code>mvgam</code> models are estimated
in a Bayesian framework using Markov Chain Monte Carlo by default. A general overview is provided
in the primary vignettes: <code><a href="../articles/mvgam_overview.html">vignette("mvgam_overview")</a></code> and <code><a href="../articles/data_in_mvgam.html">vignette("data_in_mvgam")</a></code>.
For a full list of available vignettes see <code>vignette(package = "mvgam")</code>
<br><br><em>Formula syntax</em>: Details of the formula syntax used by <span class="pkg">mvgam</span> can be found in
<code><a href="mvgam_formulae.html">mvgam_formulae</a></code>. Note that it is possible to supply an empty formula where
there are no predictors or intercepts in the observation model (i.e. <code>y ~ 0</code> or <code>y ~ -1</code>).
In this case, an intercept-only observation model will be set up but the intercept coefficient
will be fixed at zero. This can be handy if you wish to fit pure State-Space models where
the variation in the dynamic trend controls the average expectation, and/or where intercepts
are non-identifiable (as in piecewise trends, see examples below)
<br><br><em>Families and link functions</em>: Details of families supported by <span class="pkg">mvgam</span> can be found in
<code><a href="mvgam_families.html">mvgam_families</a></code>.
<br><br><em>Trend models</em>: Details of latent error process models supported by <span class="pkg">mvgam</span> can be found in
<code><a href="mvgam_trends.html">mvgam_trends</a></code>.
<br><br><em>Priors</em>: Default priors for intercepts and any scale parameters are generated
using the same practice as <span class="pkg">brms</span>. Prior distributions for most important model parameters can be
altered by the user to inspect model
sensitivities to given priors (see <code><a href="get_mvgam_priors.html">get_mvgam_priors</a></code> for details).
Note that latent trends are estimated on the link scale so choose priors
accordingly. However more control over the model specification can be accomplished by first using <code>mvgam</code> as a
baseline, then editing the returned model accordingly. The model file can be edited and run outside
of <code>mvgam</code> by setting <code>run_model = FALSE</code> and this is encouraged for complex
modelling tasks. Note, no priors are
formally checked to ensure they are in the right syntax for the respective
probabilistic modelling framework, so it is
up to the user to ensure these are correct (i.e. use <code>dnorm</code> for normal
densities in <code>JAGS</code>, with the mean and precision
parameterisation; but use <code>normal</code> for normal densities in <code>Stan</code>, with the mean
and standard deviation parameterisation)
<br><br><em>Random effects</em>: For any smooth terms using the random effect basis (<code><a href="https://rdrr.io/pkg/mgcv/man/smooth.construct.re.smooth.spec.html" class="external-link">smooth.construct.re.smooth.spec</a></code>),
a non-centred parameterisation is automatically employed to avoid degeneracies that are common in hierarchical models.
Note however that centred versions may perform better for series that are particularly informative, so as with any
foray into Bayesian modelling, it is worth building an understanding of the model's assumptions and limitations by following a
principled workflow. Also note that models are parameterised using <code>drop.unused.levels = FALSE</code> in <code><a href="https://rdrr.io/pkg/mgcv/man/jagam.html" class="external-link">jagam</a></code>
to ensure predictions can be made for all levels of the supplied factor variable
<br><br><em>Observation level parameters</em>: When more than one series is included in <code>data</code> and an
observation family that contains more than one parameter is used, additional observation family parameters
(i.e. <code>phi</code> for <code><a href="mvgam_families.html">nb()</a></code> or <code>sigma</code> for <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code>) are
by default estimated independently for each series. But if you wish for the series to share
the same observation parameters, set <code>share_obs_params = TRUE</code>
<br><br><em>Factor regularisation</em>: When using a dynamic factor model for the trends with <code>JAGS</code> factor precisions are given
regularized penalty priors to theoretically allow some factors to be dropped from the model by squeezing increasing
factors' variances to zero. This is done to help protect against selecting too many latent factors than are needed to
capture dependencies in the data, so it can often be advantageous to set <code>n_lv</code> to a slightly larger number. However
larger numbers of factors do come with additional computational costs so these should be balanced as well. When using
<code>Stan</code>, all factors are parameterised with fixed variance parameters
<br><br><em>Residuals</em>: For each series, randomized quantile (i.e. Dunn-Smyth) residuals are calculated for inspecting model diagnostics
If the fitted model is appropriate then Dunn-Smyth residuals will be standard normal in distribution and no
autocorrelation will be evident. When a particular observation is missing, the residual is calculated by comparing independent
draws from the model's posterior distribution
<br><br><em>Using Stan</em>: <code>mvgam</code> is primarily designed to use Hamiltonian Monte Carlo for parameter estimation
via the software <code>Stan</code> (using either the <code>cmdstanr</code> or <code>rstan</code> interface).
There are great advantages when using <code>Stan</code> over Gibbs / Metropolis Hastings samplers, which includes the option
to estimate nonlinear effects via <a href="https://arxiv.org/abs/2004.11408" class="external-link">Hilbert space approximate Gaussian Processes</a>,
the availability of a variety of inference algorithms (i.e. variational inference, laplacian inference etc...) and
<a href="https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648" class="external-link">capabilities to enforce stationarity for complex Vector Autoregressions</a>.
Because of the many advantages of <code>Stan</code> over <code>JAGS</code>,
<em>further development of the package will only be applied to <code>Stan</code></em>. This includes the planned addition
of more response distributions, plans to handle zero-inflation, and plans to incorporate a greater
variety of trend models. Users are strongly encouraged to opt for <code>Stan</code> over <code>JAGS</code> in any proceeding workflows
<br><br><em>How to start?</em>: The <a href="https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.pdf" class="external-link"><code>mvgam</code> cheatsheet</a> is a
good starting place if you are just learning to use the package. It gives an overview of the package's key functions and objects,
as well as providing a reasonable workflow that new users can follow. In general it is recommended to</p><ul><li><p>1. Check that your time series data are in a suitable long format for <code>mvgam</code> modeling (see the <a href="https://nicholasjclark.github.io/mvgam/articles/data_in_mvgam.html">data formatting vignette</a> for guidance)</p></li>
<li><p>2. Inspect features of the data using <code><a href="plot_mvgam_series.html">plot_mvgam_series</a></code>. Now is also a good time to familiarise yourself
with the package's example workflows that are detailed in the vignettes. In particular,
the <a href="https://nicholasjclark.github.io/mvgam/articles/shared_states.html">getting started vignette</a>,
the <a href="https://nicholasjclark.github.io/mvgam/articles/shared_states.html">shared latent states vignette</a>,
the <a href="https://nicholasjclark.github.io/mvgam/articles/time_varying_effects.html">time-varying effects vignette</a> and
the <a href="https://nicholasjclark.github.io/mvgam/articles/trend_formulas.html">State-Space models vignette</a> all provide
detailed information about how to structure, fit and interrogate Dynamic Generalized Additive Models in <code>mvgam</code>. Some
more specialized how-to articles include
<a href="https://ecogambler.netlify.app/blog/time-varying-seasonality/" class="external-link">"Incorporating time-varying seasonality in forecast models"</a>
and <a href="https://ecogambler.netlify.app/blog/autocorrelated-gams/" class="external-link">"Temporal autocorrelation in GAMs and the <code>mvgam</code> package"</a></p></li>
<li><p>3. Carefully think about how to structure linear predictor effects (i.e. smooth terms using <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></code>,
<code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></code> or <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></code>, GPs using <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp</a></code>, dynamic time-varying effects using <code><a href="dynamic.html">dynamic</a></code>, and parametric terms), latent temporal trend components (see <code><a href="mvgam_trends.html">mvgam_trends</a></code>) and the appropriate
observation family (see <code><a href="mvgam_families.html">mvgam_families</a></code>). Use <code><a href="get_mvgam_priors.html">get_mvgam_priors</a></code> to see default prior distributions
for stochastic parameters</p></li>
<li><p>4. Change default priors using appropriate prior knowledge (see <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></code>)</p></li>
<li><p>5. Fit the model using either Hamiltonian Monte Carlo or an approximation algorithm (i.e. change the <code>backend</code> argument)
and use <code><a href="summary.mvgam.html">summary.mvgam</a></code>, <code><a href="conditional_effects.mvgam.html">conditional_effects.mvgam</a></code>, <code><a href="mcmc_plot.mvgam.html">mcmc_plot.mvgam</a></code>, <code><a href="pp_check.mvgam.html">pp_check.mvgam</a></code> and
<code><a href="plot.mvgam.html">plot.mvgam</a></code> to inspect / interrogate the model</p></li>
<li><p>6. Update the model as needed and use <code><a href="loo.mvgam.html">loo_compare.mvgam</a></code> for in-sample model comparisons, or alternatively
use <code><a href="forecast.mvgam.html">forecast.mvgam</a></code> and <code><a href="score.mvgam_forecast.html">score.mvgam_forecast</a></code> to compare models based on out-of-sample forecasts (see the <a href="https://nicholasjclark.github.io/mvgam/articles/forecast_evaluation.html">forecast evaluation vignette</a> for guidance)</p></li>
<li><p>7. When satisfied with the model structure, use <code><a href="predict.mvgam.html">predict.mvgam</a></code>,
<code><a href="https://rdrr.io/pkg/marginaleffects/man/plot_predictions.html" class="external-link">plot_predictions</a></code> and/or <code><a href="https://rdrr.io/pkg/marginaleffects/man/plot_slopes.html" class="external-link">plot_slopes</a></code> for
more targeted inferences (see <a href="https://ecogambler.netlify.app/blog/interpreting-gams/" class="external-link">"How to interpret and report nonlinear effects from Generalized Additive Models"</a> for some guidance on interpreting GAMs)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Nicholas J Clark &amp; Konstans Wells (2020). Dynamic generalised additive models (DGAMs) for forecasting discrete ecological time series.
Methods in Ecology and Evolution. 14:3, 771-784.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/pkg/mgcv/man/jagam.html" class="external-link">jagam</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/gam.models.html" class="external-link">gam.models</a></code>,
<code><a href="get_mvgam_priors.html">get_mvgam_priors</a></code>, <code><a href="jsdgam.html">jsdgam</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Nicholas J Clark</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Simulate a collection of three time series that have shared seasonal dynamics</span></span></span>
<span class="r-in"><span><span class="co"># and independent AR1 trends, with a Poisson observation process</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span>T <span class="op">=</span> <span class="fl">80</span>,</span></span>
<span class="r-in"><span>                n_series <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>                mu <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>                trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                prop_missing <span class="op">=</span> <span class="fl">0.1</span>,</span></span>
<span class="r-in"><span>                prop_trend <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot key summary statistics for a single series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot all series together</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>, series <span class="op">=</span> <span class="st">'all'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Formulate a model using Stan where series share a cyclic smooth for</span></span></span>
<span class="r-in"><span><span class="co"># seasonality and each series has an independent AR1 temporal process.</span></span></span>
<span class="r-in"><span><span class="co"># Note that 'noncentred = TRUE' will likely give performance gains.</span></span></span>
<span class="r-in"><span><span class="co"># Set run_model = FALSE to inspect the returned objects</span></span></span>
<span class="r-in"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">'cc'</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>             trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>             use_stan <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>             run_model <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View the model code in Stan language</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">stancode</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // Stan model code generated by package mvgam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; total_obs; // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n; // number of timepoints per series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_sp; // number of smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_series; // number of series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] zero; // prior locations for basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[4, 4] S1; // mgcv smooth penalty matrix S1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; flat_ys; // flattened nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n_nonmissing, num_basis] flat_xs; // X values for nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; obs_ind; // indices of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // raw basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // latent trend AR1 terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=-1, upper=1&gt;[n_series] ar1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // latent trend variance parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[n_series] sigma;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // raw latent trends</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] trend_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[n_sp] lambda;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // latent trends</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] trend;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   trend = trend_raw .* rep_matrix(sigma', rows(trend_raw));</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     trend[2 : n, s] += ar1[s] * trend[1 : (n - 1), s];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b[1 : num_basis] = b_raw[1 : num_basis];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for (Intercept)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[1] ~ student_t(3, 1.9, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[2 : 5] ~ multi_normal_prec(zero[2 : 5], S1[1 : 4, 1 : 4] * lambda[1]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for AR parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ar1 ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lambda ~ normal(5, 30);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for latent trend variance parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   sigma ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   to_vector(trend_raw) ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     // likelihood functions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     vector[n_nonmissing] flat_trends;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     flat_trends = to_vector(trend)[obs_ind];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     flat_ys ~ poisson_log_glm(append_col(flat_xs, flat_trends), 0.0,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                               append_row(b, 1.0));</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[total_obs] eta;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] mus;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[n_sp] rho;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[n_series] tau;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int ypred;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   rho = log(lambda);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     tau[s] = pow(sigma[s], -2.0);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // posterior predictions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   eta = X * b;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     mus[1 : n, s] = eta[ytimes[1 : n, s]] + trend[1 : n, s];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ypred[1 : n, s] = poisson_log_rng(mus[1 : n, s]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View the data objects needed to fit the model in Stan</span></span></span>
<span class="r-in"><span><span class="va">sdata1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/standata.html" class="external-link">standata</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">sdata1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> List of 18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ y           : num [1:60, 1:3] 12 17 12 31 30 8 0 1 3 5 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ n           : int 60</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ X           : num [1:180, 1:5] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..$ : chr [1:5] "X.Intercept." "V2" "V3" "V4" ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ S1          : num [1:4, 1:4] 1.244 -0.397 0.384 0.619 -0.397 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ zero        : num [1:5] 0 0 0 0 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ p_coefs     : Named num 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "names")= chr "(Intercept)"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ p_taus      : num 1.09</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ ytimes      : int [1:60, 1:3] 1 4 7 10 13 16 19 22 25 28 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ n_series    : int 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ sp          : Named num 0.368</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "names")= chr "s(season)"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ y_observed  : num [1:60, 1:3] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ total_obs   : int 180</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ num_basis   : int 5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ n_sp        : num 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ n_nonmissing: int 161</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ obs_ind     : int [1:161] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ flat_ys     : num [1:161] 12 17 12 31 30 8 0 1 3 5 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ flat_xs     : num [1:161, 1:5] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..$ : chr [1:5] "X.Intercept." "V2" "V3" "V4" ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "trend_model")= chr "AR1"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now fit the model</span></span></span>
<span class="r-in"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">'cc'</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>              data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>              trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>              noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>              chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Compiling Stan program using cmdstanr</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c3b5e6c17.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Start sampling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running MCMC with 2 parallel chains...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 finished in 0.9 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 finished in 0.9 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Both chains finished successfully.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mean chain execution time: 0.9 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total execution time: 1.1 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract the model summary</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM formula:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> y ~ s(season, bs = "cc", k = 6)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x0000021ebbca2828&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Family:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> poisson</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Link function:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> log</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Trend model:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> AR()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N series:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N timepoints:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 60 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Status:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fitted using Stan </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 chains, each with iter = 1000; warmup = 500; thin = 1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total post-warmup draws = 1000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM coefficient (beta) estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              2.5%    50%   97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)  1.80  2.000  2.1000 1.01   350</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(season).1  0.15  0.370  0.6000 1.01   199</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(season).2 -0.33 -0.091  0.1400 1.00   404</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(season).3 -1.00 -0.710 -0.4500 1.01   372</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(season).4 -0.52 -0.270 -0.0059 1.01   528</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Approximate significance of GAM smooths:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            edf Ref.df Chi.sq p-value    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(season) 3.69      4   26.7 1.1e-06 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Latent trend parameter AR estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             2.5%   50% 97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ar1[1]    0.2400  0.73  0.98 1.01   274</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ar1[2]   -0.9300 -0.36  0.18 1.01   147</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ar1[3]    0.0021  0.38  0.92 1.02   149</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sigma[1]  0.3900  0.53  0.73 1.00   314</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sigma[2]  0.3900  0.55  0.77 1.00   267</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sigma[3]  0.4300  0.59  0.78 1.00   309</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Stan MCMC diagnostics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> n_eff / iter looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Rhat looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0 of 1000 iterations ended with a divergence (0%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0 of 1000 iterations saturated the maximum tree depth of 12 (0%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> E-FMI indicated no pathological behavior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Samples were drawn using NUTS(diag_e) at Wed Nov 13 8:46:32 AM 2024.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> and Rhat is the potential scale reduction factor on split MCMC chains</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (at convergence, Rhat = 1)</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the estimated historical trend and forecast for one series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Residual diagnostics</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-5.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">resids</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  num [1:180, 1:4] 0.0319 -0.06 0.1531 0.5229 -0.0881 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ : chr [1:4] "Estimate" "Est.Error" "Q2.5" "Q97.5"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute the forecast using covariate information in data_test</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">mod1</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> List of 16</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ call              :Class 'formula'  language y ~ s(season, bs = "cc", k = 6)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..- attr(*, ".Environment")=&lt;environment: 0x0000021ebbca2828&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ trend_call        : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ family            : chr "poisson"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ family_pars       : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ trend_model       :List of 7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ trend_model: chr "AR1"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ ma         : logi FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ cor        : logi FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ unit       : chr "time"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ gr         : chr "NA"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ subgr      : chr "series"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ label      : language AR()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..- attr(*, "class")= chr "mvgam_trend"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ drift             : logi FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ use_lv            : logi FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ fit_engine        : chr "stan"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ type              : chr "response"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ series_names      : Factor w/ 3 levels "series_1","series_2",..: 1 2 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ train_observations:List of 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_1: int [1:60] 12 17 12 31 30 8 0 1 3 5 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_2: int [1:60] 8 8 21 7 6 NA 1 8 9 3 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_3: int [1:60] 10 NA 7 2 1 11 4 NA 5 4 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ train_times       : int [1:60] 1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ test_observations :List of 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_1: int [1:20] 4 9 5 6 4 11 NA 3 8 11 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_2: int [1:20] 19 51 19 10 3 6 7 1 6 4 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_3: int [1:20] 10 NA 8 5 16 13 0 0 3 2 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ test_times        : int [1:20] 61 62 63 64 65 66 67 68 69 70 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ hindcasts         :List of 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_1: num [1:1000, 1:60] 22 9 10 1 18 15 11 19 10 15 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : chr [1:60] "ypred[1,1]" "ypred[2,1]" "ypred[3,1]" "ypred[4,1]" ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_2: num [1:1000, 1:60] 12 13 5 5 12 7 16 12 6 9 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : chr [1:60] "ypred[1,2]" "ypred[2,2]" "ypred[3,2]" "ypred[4,2]" ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_3: num [1:1000, 1:60] 5 11 9 9 6 15 5 6 14 12 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. ..- attr(*, "dimnames")=List of 2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   .. .. ..$ : chr [1:60] "ypred[1,3]" "ypred[2,3]" "ypred[3,3]" "ypred[4,3]" ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ forecasts         :List of 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_1: int [1:1000, 1:20] 6 8 9 2 14 4 6 4 17 6 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_2: int [1:1000, 1:20] 10 13 12 11 8 9 1 9 25 5 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ..$ series_3: int [1:1000, 1:20] 43 18 33 11 9 26 13 10 6 3 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  - attr(*, "class")= chr "mvgam_forecast"</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Out of sample DRPS:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 55.270817</span>
<span class="r-plt img"><img src="mvgam-6.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the estimated seasonal smooth function</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'smooths'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot estimated first derivatives of the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'smooths'</span>, derivatives <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-8.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot partial residuals of the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'smooths'</span>, residuals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-9.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot posterior realisations for the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">'smooths'</span>, realisations <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-10.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot conditional response predictions using marginaleffects</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/" class="external-link">marginaleffects</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-11.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod1</span>, condition <span class="op">=</span> <span class="st">'season'</span>, points <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Removed 19 rows containing missing values or values outside the scale range</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> (`geom_point()`).</span>
<span class="r-plt img"><img src="mvgam-12.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate posterior predictive checks using bayesplot</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Using 10 posterior draws for ppc type 'dens_overlay' by default.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>NA responses are not shown in 'pp_check'.</span>
<span class="r-plt img"><img src="mvgam-13.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract observation model beta coefficient draws as a data.frame</span></span></span>
<span class="r-in"><span><span class="va">beta_draws_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod1</span>, variable <span class="op">=</span> <span class="st">'betas'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">beta_draws_df</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   (Intercept) s(season).1 s(season).2 s(season).3 s(season).4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1     1.94416    0.394466 -0.06900860   -0.783359   -0.426288</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2     1.92798    0.271471 -0.00850006   -0.685065   -0.244868</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3     1.90193    0.230704 -0.04661740   -0.676646   -0.314741</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4     1.88637    0.430494 -0.30333200   -0.634353   -0.345208</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5     1.97914    0.322658  0.15346600   -0.703236   -0.263105</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6     2.02798    0.407478  0.05122050   -0.581718   -0.361806</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">beta_draws_df</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 'data.frame':	1000 obs. of  5 variables:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ (Intercept): num  1.94 1.93 1.9 1.89 1.98 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ s(season).1: num  0.394 0.271 0.231 0.43 0.323 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ s(season).2: num  -0.069 -0.0085 -0.0466 -0.3033 0.1535 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ s(season).3: num  -0.783 -0.685 -0.677 -0.634 -0.703 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  $ s(season).4: num  -0.426 -0.245 -0.315 -0.345 -0.263 ...</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Investigate model fit</span></span></span>
<span class="r-in"><span><span class="va">mc.cores.def</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">'mc.cores'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed from 1000 by 161 log-likelihood matrix.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate   SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> elpd_loo   -452.2  8.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> p_loo        91.6  4.8</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> looic       904.4 17.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE of elpd_loo is NA.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE and ESS estimates assume MCMC draws (r_eff in [0.3, 1.6]).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Pareto k diagnostic values:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           Count Pct.    Min. ESS</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (-Inf, 0.67]   (good)     67    41.6%   85      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    (0.67, 1]   (bad)      79    49.1%   &lt;NA&gt;    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     (1, Inf)   (very bad) 15     9.3%   &lt;NA&gt;    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> See help('pareto-k-diagnostic') for details.</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="va">mc.cores.def</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example of supplying a trend_map so that some series can share</span></span></span>
<span class="r-in"><span><span class="co"># latent trend processes</span></span></span>
<span class="r-in"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span>n_series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mod_data</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">data_train</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Here, we specify only two latent trends; series 1 and 2 share a trend,</span></span></span>
<span class="r-in"><span><span class="co"># while series 3 has it's own unique latent trend</span></span></span>
<span class="r-in"><span><span class="va">trend_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mod_data</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                       trend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit the model using AR1 trends</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">'cc'</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             trend_map <span class="op">=</span> <span class="va">trend_map</span>,</span></span>
<span class="r-in"><span>             trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">mod_data</span>,</span></span>
<span class="r-in"><span>             return_model_data <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>             chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Compiling Stan program using cmdstanr</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c47d355d4.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Start sampling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running MCMC with 2 parallel chains...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 finished in 1.1 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 finished in 2.0 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Both chains finished successfully.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mean chain execution time: 1.6 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total execution time: 2.2 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The mapping matrix is now supplied as data to the model in the 'Z' element</span></span></span>
<span class="r-in"><span><span class="va">mod</span><span class="op">$</span><span class="va">model_data</span><span class="op">$</span><span class="va">Z</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    1    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    1    0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [3,]    0    1</span>
<span class="r-in"><span><span class="fu"><a href="code.html">code</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // Stan model code generated by package mvgam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; total_obs; // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n; // number of timepoints per series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_lv; // number of dynamic factors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_sp; // number of smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_series; // number of series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n_series, n_lv] Z; // matrix mapping series to latent trends</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] zero; // prior locations for basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[4, 4] S1; // mgcv smooth penalty matrix S1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; flat_ys; // flattened nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n_nonmissing, num_basis] flat_xs; // X values for nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; obs_ind; // indices of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // raw basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // latent factor SD terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[n_lv] sigma;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // latent factor AR1 terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=-1, upper=1&gt;[n_lv] ar1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // dynamic factors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_lv] LV;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[n_sp] lambda;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // trends and dynamic factor loading matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] trend;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b[1 : num_basis] = b_raw[1 : num_basis];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // derived latent trends</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 1 : n) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       trend[i, s] = dot_product(Z[s,  : ], LV[i,  : ]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for (Intercept)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[1] ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[2 : 5] ~ multi_normal_prec(zero[2 : 5], S1[1 : 4, 1 : 4] * lambda[1]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for AR parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ar1 ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lambda ~ normal(5, 30);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for factor SD parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   sigma ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // dynamic factor estimates</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   LV[1, 1 : n_lv] ~ normal(0, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (j in 1 : n_lv) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     LV[2 : n, j] ~ normal(ar1[j] * LV[1 : (n - 1), j], sigma[j]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     // likelihood functions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     vector[n_nonmissing] flat_trends;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     flat_trends = to_vector(trend)[obs_ind];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     flat_ys ~ poisson_log_glm(append_col(flat_xs, flat_trends), 0.0,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                               append_row(b, 1.0));</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[total_obs] eta;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] mus;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[n_sp] rho;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[n_lv] penalty;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int ypred;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   rho = log(lambda);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   penalty = 1.0 / (sigma .* sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n_series, n_lv] lv_coefs = Z;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // posterior predictions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   eta = X * b;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     mus[1 : n, s] = eta[ytimes[1 : n, s]] + trend[1 : n, s];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ypred[1 : n, s] = poisson_log_rng(mus[1 : n, s]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The first two series share an identical latent trend; the third is different</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-14.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-15.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-16.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example of how to use dynamic coefficients</span></span></span>
<span class="r-in"><span><span class="co"># Simulate a time-varying coefficient for the effect of temperature</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span></span></span>
<span class="r-in"><span><span class="va">beta_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">beta_temp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.4</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span> <span class="va">beta_temp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="va">beta_temp</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.0025</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">beta_temp</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-17.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a covariate called 'temp'</span></span></span>
<span class="r-in"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate some noisy Gaussian observations</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="fl">4</span> <span class="op">+</span> <span class="va">beta_temp</span> <span class="op">*</span> <span class="va">temp</span>,</span></span>
<span class="r-in"><span>             sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Gather necessary data into a data.frame; split into training / testing</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">temp</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">180</span>,<span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">data_test</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">181</span><span class="op">:</span><span class="fl">200</span>,<span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit the model using the dynamic() formula helper</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span><span class="va">out</span> <span class="op">~</span></span></span>
<span class="r-in"><span>              <span class="fu"><a href="dynamic.html">dynamic</a></span><span class="op">(</span><span class="va">temp</span>,</span></span>
<span class="r-in"><span>                      scale <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>                      k <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">data_train</span>,</span></span>
<span class="r-in"><span>             newdata <span class="op">=</span> <span class="va">data_test</span>,</span></span>
<span class="r-in"><span>             chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Compiling Stan program using cmdstanr</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c9b418f5.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Start sampling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running MCMC with 2 parallel chains...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 finished in 0.8 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 finished in 0.8 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Both chains finished successfully.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mean chain execution time: 0.8 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total execution time: 0.9 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect the model summary, forecast and time-varying coefficient distribution</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM formula:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> out ~ gp(time, by = temp, c = 5/4, k = 40, scale = FALSE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x0000021ebbca2828&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Family:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gaussian</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Link function:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> identity</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Trend model:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> None</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N series:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N timepoints:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 200 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Status:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fitted using Stan </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 chains, each with iter = 1000; warmup = 500; thin = 1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total post-warmup draws = 1000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Observation error parameter estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              2.5%  50% 97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sigma_obs[1] 0.44 0.49  0.55    1  1301</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM coefficient (beta) estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    2.5%      50% 97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)       4.000  4.0e+00 4.100 1.00  1985</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.1   0.430  3.2e+00 6.700 1.00   962</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.2  -3.300  1.5e+00 6.500 1.00   969</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.3  -6.200 -1.4e+00 3.300 1.00  1060</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.4  -5.700 -1.5e+00 2.800 1.00   952</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.5  -3.700  2.0e-01 3.800 1.00  1123</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.6  -2.500  6.1e-01 4.700 1.00  1104</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.7  -3.200 -1.9e-01 2.900 1.00   831</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.8  -2.700 -4.8e-02 2.300 1.00  1025</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.9  -1.600  5.8e-01 3.200 1.00   863</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.10 -2.100 -5.0e-02 1.800 1.00  1422</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.11 -2.500 -4.5e-01 1.000 1.00   904</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.12 -1.400  7.1e-02 1.900 1.00  1162</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.13 -0.890  1.7e-01 1.900 1.00  1547</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.14 -1.600 -2.3e-02 1.200 1.00  1174</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.15 -1.600 -1.6e-02 1.000 1.00  1062</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.16 -0.850  1.7e-03 1.500 1.00  1316</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.17 -0.950  4.3e-04 1.300 1.00  1338</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.18 -1.100 -1.8e-15 0.910 1.00  1409</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.19 -0.980 -2.4e-08 0.930 1.00  1809</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.20 -0.970 -3.8e-05 0.690 1.00  1603</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.21 -0.510  3.2e-06 0.860 1.00  1660</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.22 -0.370  3.0e-04 0.950 1.00   799</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.23 -0.700 -5.4e-08 0.480 1.00  1358</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.24 -0.850 -6.9e-07 0.290 1.00   939</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.25 -0.330  5.3e-10 0.680 1.01   872</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.26 -0.380 -6.0e-40 0.560 1.00  1064</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.27 -0.600 -1.6e-09 0.260 1.00  1177</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.28 -0.460 -1.6e-23 0.460 1.00  1112</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.29 -0.230  2.7e-12 0.490 1.00   895</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.30 -0.280 -2.5e-40 0.230 1.00  1522</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.31 -0.610 -2.6e-21 0.200 1.00   934</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.32 -0.240  3.5e-33 0.350 1.00  1125</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.33 -0.200  5.5e-56 0.330 1.00  1734</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.34 -0.210 -4.6e-36 0.150 1.00  1047</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.35 -0.210  1.2e-44 0.230 1.00  1183</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.36 -0.180  2.6e-29 0.190 1.00  1430</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.37 -0.120 -4.7e-53 0.180 1.00  1225</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.38 -0.160 -3.0e-57 0.082 1.00  1136</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.39 -0.180 -5.8e-37 0.068 1.00   964</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> gp(time):temp.40 -0.043  9.7e-43 0.160 1.00   728</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM gp term marginal deviation (alpha) and length scale (rho) estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     2.5%   50% 97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> alpha_gp(time):temp 0.18  0.33  0.78 1.00   508</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> rho_gp(time):temp   9.30 29.00 90.00 1.01   382</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Stan MCMC diagnostics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> n_eff / iter looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Rhat looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 29 of 1000 iterations ended with a divergence (2.9%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  *Try running with larger adapt_delta to remove the divergences</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0 of 1000 iterations saturated the maximum tree depth of 12 (0%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> E-FMI indicated no pathological behavior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Samples were drawn using NUTS(diag_e) at Wed Nov 13 8:47:47 AM 2024.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> and Rhat is the potential scale reduction factor on split MCMC chains</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (at convergence, Rhat = 1)</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'smooths'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-18.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Out of sample CRPS:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 6.43188275110833</span>
<span class="r-plt img"><img src="mvgam-19.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Propagating the smooth term shows how the coefficient is expected to evolve</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">mod</span>, smooth <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">180</span>, lty <span class="op">=</span> <span class="st">'dashed'</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">beta_temp</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-20.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example showing how to incorporate an offset; simulate some count data</span></span></span>
<span class="r-in"><span><span class="co"># with different means per series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span>prop_trend <span class="op">=</span> <span class="fl">0</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                 seasonality <span class="op">=</span> <span class="st">'hierarchical'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Add offset terms to the training and testing data</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a model that includes the offset in the linear predictor as well as</span></span></span>
<span class="r-in"><span><span class="co"># hierarchical seasonal smooths</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">offset</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>              <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">series</span>, bs <span class="op">=</span> <span class="st">'re'</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>              <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">'cc'</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>              <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, by <span class="op">=</span> <span class="va">series</span>, m <span class="op">=</span> <span class="fl">1</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>             chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Compiling Stan program using cmdstanr</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c3dc259d2.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Start sampling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running MCMC with 2 parallel chains...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 finished in 3.8 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 finished in 5.0 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Both chains finished successfully.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mean chain execution time: 4.4 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total execution time: 5.1 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect the model file to see the modification to the linear predictor</span></span></span>
<span class="r-in"><span><span class="co"># (eta)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="code.html">code</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // Stan model code generated by package mvgam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; total_obs; // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n; // number of timepoints per series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_sp; // number of smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_series; // number of series</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] zero; // prior locations for basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[total_obs] off_set; // offset vector</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[8, 8] S1; // mgcv smooth penalty matrix S1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[4, 4] S2; // mgcv smooth penalty matrix S2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[4, 4] S3; // mgcv smooth penalty matrix S3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[4, 4] S4; // mgcv smooth penalty matrix S4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; flat_ys; // flattened nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n_nonmissing, num_basis] flat_xs; // X values for nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n_nonmissing] int&lt;lower=0&gt; obs_ind; // indices of nonmissing observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // raw basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // random effect variances</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[1] sigma_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // random effect means</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[1] mu_raw;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector&lt;lower=0&gt;[n_sp] lambda;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // basis coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[num_basis] b;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b[1 : 21] = b_raw[1 : 21];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b[22 : 24] = mu_raw[1] + b_raw[22 : 24] * sigma_raw[1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for random effect population variances</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   sigma_raw ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for random effect population means</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   mu_raw ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for (Intercept)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[1] ~ student_t(3, 1.4, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[2 : 9] ~ multi_normal_prec(zero[2 : 9], S1[1 : 8, 1 : 8] * lambda[1]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season):seriesseries_1...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[10 : 13] ~ multi_normal_prec(zero[10 : 13],</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                      S2[1 : 4, 1 : 4] * lambda[2]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season):seriesseries_2...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[14 : 17] ~ multi_normal_prec(zero[14 : 17],</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                      S3[1 : 4, 1 : 4] * lambda[3]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior for s(season):seriesseries_3...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[18 : 21] ~ multi_normal_prec(zero[18 : 21],</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                      S4[1 : 4, 1 : 4] * lambda[4]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior (non-centred) for s(series)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   b_raw[22 : 24] ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors for smoothing parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lambda ~ normal(5, 30);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     // likelihood functions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     flat_ys ~ poisson_log_glm(flat_xs, off_set[obs_ind], b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[total_obs] eta;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[n, n_series] mus;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[n_sp] rho;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[n, n_series] int ypred;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   rho = log(lambda);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // posterior predictions</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   eta = X * b + off_set;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (s in 1 : n_series) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     mus[1 : n, s] = eta[ytimes[1 : n, s]];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ypred[1 : n, s] = poisson_log_rng(mus[1 : n, s]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Forecasts for the first two series will differ in magnitude</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span>, series <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Out of sample DRPS:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 22.781273</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span>, series <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Out of sample DRPS:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 77.61833</span>
<span class="r-plt img"><img src="mvgam-21.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Changing the offset for the testing data should lead to changes in</span></span></span>
<span class="r-in"><span><span class="co"># the forecast</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">-</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Out of sample DRPS:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 38.523539</span>
<span class="r-plt img"><img src="mvgam-22.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Relative Risks can be computed by fixing the offset to the same value</span></span></span>
<span class="r-in"><span><span class="co"># for each series</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">preds_rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'link'</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span>,</span></span>
<span class="r-in"><span>                    summary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">series1_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span> <span class="op">==</span> <span class="st">'series_1'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">series2_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span> <span class="op">==</span> <span class="st">'series_2'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Relative Risks are now more comparable among series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="fl">1</span>, <span class="va">series1_inds</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, col <span class="op">=</span> <span class="st">'grey75'</span>,</span></span>
<span class="r-in"><span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     ylab <span class="op">=</span> <span class="st">'Series1 Relative Risk'</span>, xlab <span class="op">=</span> <span class="st">'Time'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="va">i</span>, <span class="va">series1_inds</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'grey75'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="fl">1</span>, <span class="va">series2_inds</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">'l'</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span></span>
<span class="r-in"><span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     ylab <span class="op">=</span> <span class="st">'Series2 Relative Risk'</span>, xlab <span class="op">=</span> <span class="st">'Time'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="va">i</span>, <span class="va">series2_inds</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'darkred'</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="op">}</span></span></span>
<span class="r-plt img"><img src="mvgam-23.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example showcasing how cbind() is needed for Binomial observations</span></span></span>
<span class="r-in"><span><span class="co"># Simulate two time series of Binomial trials</span></span></span>
<span class="r-in"><span><span class="va">trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">detprob1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.9</span><span class="op">*</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">detprob2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">-</span><span class="fl">0.7</span><span class="op">*</span><span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">detprob1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                        time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>                        series <span class="op">=</span> <span class="st">'series1'</span>,</span></span>
<span class="r-in"><span>                        x <span class="op">=</span> <span class="va">x</span>,</span></span>
<span class="r-in"><span>                        ntrials <span class="op">=</span> <span class="va">trials</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">detprob2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                        time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>                        series <span class="op">=</span> <span class="st">'series2'</span>,</span></span>
<span class="r-in"><span>                        x <span class="op">=</span> <span class="va">x</span>,</span></span>
<span class="r-in"><span>                        ntrials <span class="op">=</span> <span class="va">trials</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dat</span>, series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">time</span>, <span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, series <span class="op">=</span> <span class="st">'all'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-24.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a model using the binomial() family; must specify observations</span></span></span>
<span class="r-in"><span><span class="co"># and number of trials in the cbind() wrapper</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">ntrials</span><span class="op">)</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             data <span class="op">=</span> <span class="va">dat</span>,</span></span>
<span class="r-in"><span>             chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Binomial and Beta-binomial families require cbind(n_successes, n_trials)</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> in the formula left-hand side. Do not use cbind(n_successes, n_failures)!</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">This warning is displayed once per session.</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Compiling Stan program using cmdstanr</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c5b973bb6.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Start sampling</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Running MCMC with 2 parallel chains...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 100 / 1000 [ 10%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 200 / 1000 [ 20%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 300 / 1000 [ 30%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 400 / 1000 [ 40%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 500 / 1000 [ 50%]  (Warmup) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 600 / 1000 [ 60%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 700 / 1000 [ 70%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 800 / 1000 [ 80%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 900 / 1000 [ 90%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 2 finished in 0.9 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Chain 1 finished in 1.1 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Both chains finished successfully.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mean chain execution time: 1.0 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total execution time: 1.2 seconds.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM formula:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cbind(y, ntrials) ~ series + s(x, by = series)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;environment: 0x0000021ebbca2828&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Family:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> binomial</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Link function:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> logit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Trend model:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> None</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N series:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N timepoints:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 50 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Status:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Fitted using Stan </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 chains, each with iter = 1000; warmup = 500; thin = 1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Total post-warmup draws = 1000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> GAM coefficient (beta) estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                        2.5%      50%  97.5% Rhat n_eff</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)          -0.280 -0.17000 -0.036 1.00   592</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> seriesseries2        -0.320 -0.15000  0.028 1.00   577</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.1 -0.120  0.02100  0.380 1.01   176</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.2 -0.190  0.00420  0.260 1.00   222</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.3 -0.088 -0.00440  0.063 1.00   307</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.4 -0.150 -0.00084  0.150 1.00   250</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.5 -0.064  0.00330  0.092 1.00   232</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.6 -0.120 -0.00120  0.130 1.00   253</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.7 -0.036 -0.00051  0.028 1.00   364</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.8 -0.440  0.00740  0.500 1.00   223</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1.9  0.280  0.70000  0.920 1.01   171</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.1 -0.650 -0.07300  0.070 1.02    76</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.2 -0.270  0.02900  0.520 1.03   138</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.3 -0.068  0.01300  0.170 1.02   191</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.4 -0.160  0.02600  0.340 1.03   142</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.5 -0.180 -0.01700  0.055 1.03   127</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.6 -0.120  0.02400  0.310 1.03   130</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.7 -0.031  0.00420  0.079 1.00   374</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.8 -0.430  0.12000  1.200 1.03   117</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2.9 -0.800 -0.58000  0.013 1.02    89</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Approximate significance of GAM smooths:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                     edf Ref.df Chi.sq p-value    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries1 2.12      9   27.4 &lt; 2e-16 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> s(x):seriesseries2 1.77      9   38.8 0.00017 ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Stan MCMC diagnostics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> n_eff / iter looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Rhat looks reasonable for all parameters</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0 of 1000 iterations ended with a divergence (0%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0 of 1000 iterations saturated the maximum tree depth of 12 (0%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> E-FMI indicated no pathological behavior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Samples were drawn using NUTS(diag_e) at Wed Nov 13 8:48:51 AM 2024.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> and Rhat is the potential scale reduction factor on split MCMC chains</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (at convergence, Rhat = 1)</span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"bars_grouped"</span>,</span></span>
<span class="r-in"><span>         group <span class="op">=</span> <span class="st">"series"</span>, ndraws <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-25.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"ecdf_overlay_grouped"</span>,</span></span>
<span class="r-in"><span>         group <span class="op">=</span> <span class="st">"series"</span>, ndraws <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-26.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'link'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mvgam-27.png" alt="" width="700" height="433"></span>
<span class="r-plt img"><img src="mvgam-28.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

