<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function sets up a Joint Species Distribution Model whereby the residual associations among
species can be modelled in a reduced-rank format using a set of latent factors. The factor
specification is extremely flexible, allowing users to include spatial, temporal or any other type
of predictor effects to more efficiently capture unmodelled residual associations, while the
observation model can also be highly flexible (including all smooth, GP and other effects that
mvgam can handle)"><title>Fit Joint Species Distribution Models in mvgam — jsdgam • mvgam</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit Joint Species Distribution Models in mvgam — jsdgam"><meta property="og:description" content="This function sets up a Joint Species Distribution Model whereby the residual associations among
species can be modelled in a reduced-rank format using a set of latent factors. The factor
specification is extremely flexible, allowing users to include spatial, temporal or any other type
of predictor effects to more efficiently capture unmodelled residual associations, while the
observation model can also be highly flexible (including all smooth, GP and other effects that
mvgam can handle)"><meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit Joint Species Distribution Models in <span class="pkg">mvgam</span></h1>
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/R/jsdgam.R" class="external-link"><code>R/jsdgam.R</code></a></small>
      <div class="d-none name"><code>jsdgam.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function sets up a Joint Species Distribution Model whereby the residual associations among
species can be modelled in a reduced-rank format using a set of latent factors. The factor
specification is extremely flexible, allowing users to include spatial, temporal or any other type
of predictor effects to more efficiently capture unmodelled residual associations, while the
observation model can also be highly flexible (including all smooth, GP and other effects that
<span class="pkg">mvgam</span> can handle)</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">jsdgam</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  factor_formula <span class="op">=</span> <span class="op">~</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="va">knots</span>,</span>
<span>  <span class="va">factor_knots</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">newdata</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  unit <span class="op">=</span> <span class="va">time</span>,</span>
<span>  species <span class="op">=</span> <span class="va">series</span>,</span>
<span>  share_obs_params <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">priors</span>,</span>
<span>  n_lv <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  max_treedepth <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  adapt_delta <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>  backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.backend"</span>, <span class="st">"cmdstanr"</span><span class="op">)</span>,</span>
<span>  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.algorithm"</span>, <span class="st">"sampling"</span><span class="op">)</span>,</span>
<span>  run_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_model_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>A <code>character</code> string specifying the GAM observation model formula. These are exactly like the formula
for a GLM except that smooth terms, <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/t2.html" class="external-link">t2()</a></code>, as well as time-varying
<code><a href="dynamic.html">dynamic()</a></code> terms and nonparametric <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> terms, can be added to the right hand side
to specify that the linear predictor depends on smooth functions of predictors
(or linear functionals of these). Details of the formula syntax used by <span class="pkg">mvgam</span>
can be found in <code><a href="mvgam_formulae.html">mvgam_formulae</a></code></p></dd>


<dt>factor_formula</dt>
<dd><p>A <code>character</code> string specifying the linear predictor
effects for the latent factors. Use <code>by = trend</code> within calls to functional terms
(i.e. <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/t2.html" class="external-link">t2()</a></code>, <code><a href="dynamic.html">dynamic()</a></code>, or <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code>) to ensure that each factor
captures a different axis of variation. See the example below as an illustration</p></dd>


<dt>knots</dt>
<dd><p>An optional <code>list</code> containing user specified knot values to be used for basis construction.
For most bases the user simply supplies the knots to be used, which must match up with the <code>k</code> value supplied
(note that the number of knots is not always just <code>k</code>). Different terms can use different numbers of knots,
unless they share a covariate</p></dd>


<dt>factor_knots</dt>
<dd><p>An optional <code>list</code> containing user specified knot values to
be used for basis construction of any smooth terms in <code>factor_formula</code>.
For most bases the user simply supplies the knots to be used, which must match up with the <code>k</code> value supplied
(note that the number of knots is not always just <code>k</code>). Different terms can use different numbers of knots,
unless they share a covariate</p></dd>


<dt>data</dt>
<dd><p>A <code>dataframe</code> or <code>list</code> containing the model response variable and covariates
required by the GAM <code>formula</code> and <code>factor_formula</code> objects</p></dd>


<dt>newdata</dt>
<dd><p>Optional <code>dataframe</code> or <code>list</code> of test data containing the same variables
as in <code>data</code>. If included, the
observations in variable <code>y</code> will be set to <code>NA</code> when fitting the model so that posterior
simulations can be obtained</p></dd>


<dt>family</dt>
<dd><p><code>family</code> specifying the observation family for the outcomes. Currently supported
families are:</p><ul><li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code> for real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">betar()</a></code> for proportional data on <code>(0,1)</code></p></li>
<li><p><code><a href="mvgam_families.html">lognormal()</a></code> for non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">student_t()</a></code> for real-valued data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma()</a></code> for non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">bernoulli()</a></code> for binary data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code> for count data</p></li>
<li><p><code><a href="mvgam_families.html">nb()</a></code> for overdispersed count data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> for count data with imperfect detection when the number of trials is known;
note that the <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> function must be used to bind the discrete observations and the discrete number
of trials</p></li>
<li><p><code><a href="mvgam_families.html">beta_binomial()</a></code> as for <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> but allows for overdispersion</p></li>
</ul><p>Default is <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code>. See <code><a href="mvgam_families.html">mvgam_families</a></code> for more details</p></dd>


<dt>unit</dt>
<dd><p>The unquoted name of the variable that represents the unit of analysis in <code>data</code> over
which latent residuals should be correlated. This variable should be either a
<code>numeric</code> or <code>integer</code> variable in the supplied <code>data</code>.
Defaults to <code>time</code> to be consistent with other functionalities
in <span class="pkg">mvgam</span>, though note that the data need not be time series in this case. See examples below
for further details and explanations</p></dd>


<dt>species</dt>
<dd><p>The unquoted name of the <code>factor</code> variable that indexes
the different response units in <code>data</code> (usually <code>'species'</code> in a JSDM).
Defaults to <code>series</code> to be consistent with other <code>mvgam</code> models</p></dd>


<dt>share_obs_params</dt>
<dd><p><code>logical</code>. If <code>TRUE</code> and the <code>family</code>
has additional family-specific observation parameters (e.g. variance components in
<code><a href="mvgam_families.html">student_t()</a></code> or <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code>, or dispersion parameters in <code><a href="mvgam_families.html">nb()</a></code> or <code><a href="mvgam_families.html">betar()</a></code>),
these parameters will be shared across all outcome variables. This is handy if you have multiple
outcomes (time series in most <code>mvgam</code> models) that you believe share some properties,
such as being from the same species over different spatial units. Default is <code>FALSE</code>.</p></dd>


<dt>priors</dt>
<dd><p>An optional <code>data.frame</code> with prior
definitions (in Stan syntax) or, preferentially, a vector containing
objects of class <code>brmsprior</code> (see. <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></code> for details).
See <a href="get_mvgam_priors.html">get_mvgam_priors</a> and for more information on changing default prior distributions</p></dd>


<dt>n_lv</dt>
<dd><p><code>integer</code> the number of latent factors to use for modelling
residual associations.
Cannot be <code>&gt; n_species</code>. Defaults arbitrarily to <code>2</code></p></dd>


<dt>chains</dt>
<dd><p><code>integer</code> specifying the number of parallel chains for the model. Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>burnin</dt>
<dd><p><code>integer</code> specifying the number of warmup iterations of the Markov chain to run
to tune sampling algorithms. Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>samples</dt>
<dd><p><code>integer</code> specifying the number of post-warmup iterations of the Markov chain to run for
sampling the posterior distribution</p></dd>


<dt>thin</dt>
<dd><p>Thinning interval for monitors.  Ignored
if <code>algorithm %in% c('meanfield', 'fullrank', 'pathfinder', 'laplace')</code></p></dd>


<dt>parallel</dt>
<dd><p><code>logical</code> specifying whether multiple cores should be used for
generating MCMC simulations in parallel. If <code>TRUE</code>, the number of cores to use will be
<code>min(c(chains, parallel::detectCores() - 1))</code></p></dd>


<dt>threads</dt>
<dd><p><code>integer</code> Experimental option to use multithreading for within-chain
parallelisation in <code>Stan</code>. We recommend its use only if you are experienced with
<code>Stan</code>'s <code>reduce_sum</code> function and have a slow running model that cannot be sped
up by any other means. Currently works for all families when using <code>Cmdstan</code>
as the backend</p></dd>


<dt>silent</dt>
<dd><p>Verbosity level between <code>0</code> and <code>2</code>. If <code>1</code> (the default), most of the informational
messages of compiler and sampler are suppressed. If <code>2</code>, even more messages are suppressed. The
actual sampling progress is still printed. Set <code>refresh = 0</code> to turn this off as well. If using
<code>backend = "rstan"</code> you can also set open_progress = FALSE to prevent opening additional
progress bars.</p></dd>


<dt>max_treedepth</dt>
<dd><p>positive integer placing a cap on the number of simulation steps evaluated during each iteration when
<code>use_stan == TRUE</code>. Default is <code>12</code>. Increasing this value can sometimes help with exploration of complex
posterior geometries, but it is rarely fruitful to go above a <code>max_treedepth</code> of <code>14</code></p></dd>


<dt>adapt_delta</dt>
<dd><p>positive numeric between <code>0</code> and <code>1</code> defining the target average proposal acceptance probability
during Stan's adaptation period, if <code>use_stan == TRUE</code>. Default is <code>0.8</code>. In general you should not need to change adapt_delta
unless you see a warning message about divergent transitions, in which case you can increase adapt_delta from the default
to a value closer to <code>1</code> (e.g. from <code>0.95</code> to <code>0.99</code>, or from <code>0.99</code> to <code>0.999</code>, etc).
The step size used by the numerical integrator is a function of <code>adapt_delta</code> in that increasing
<code>adapt_delta</code> will result in a smaller step size and fewer divergences. Increasing <code>adapt_delta</code> will
typically result in a slower sampler, but it will always lead to a more robust sampler</p></dd>


<dt>backend</dt>
<dd><p>Character string naming the package to use as the backend for fitting
the Stan model (if <code>use_stan = TRUE</code>). Options are "cmdstanr" (the default) or "rstan". Can be set globally
for the current R session via the <code>"brms.backend"</code> option (see <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></code>). Details on
the rstan and cmdstanr packages are available at https://mc-stan.org/rstan/ and
https://mc-stan.org/cmdstanr/, respectively</p></dd>


<dt>algorithm</dt>
<dd><p>Character string naming the estimation approach to use.
Options are <code>"sampling"</code> for MCMC (the default), <code>"meanfield"</code> for
variational inference with factorized normal distributions,
<code>"fullrank"</code> for variational inference with a multivariate normal
distribution, <code>"laplace"</code> for a Laplace approximation (only available
when using cmdstanr as the backend) or <code>"pathfinder"</code> for the pathfinder
algorithm (only currently available when using cmdstanr as the backend).
Can be set globally for the current <span style="R">R</span> session via the
<code>"brms.algorithm"</code> option (see <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></code>). Limited testing
suggests that <code>"meanfield"</code> performs best out of the non-MCMC approximations for
dynamic GAMs, possibly because of the difficulties estimating covariances among the
many spline parameters and latent trend parameters. But rigorous testing has not
been carried out</p></dd>


<dt>run_model</dt>
<dd><p><code>logical</code>. If <code>FALSE</code>, the model is not fitted but instead the function will
return the model file and the data / initial values that are needed to fit the model outside of <code>mvgam</code></p></dd>


<dt>return_model_data</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, the list of data that is needed to fit the
model is returned, along with the initial values for smooth and AR parameters, once the model is fitted.
This will be helpful if users wish to modify the model file to add
other stochastic elements that are not currently available in <code>mvgam</code>.
Default is <code>FALSE</code> to reduce
the size of the returned object, unless <code>run_model == FALSE</code></p></dd>


<dt>...</dt>
<dd><p>Other arguments to pass to <a href="mvgam.html">mvgam</a></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>list</code> object of class <code>mvgam</code> containing model output,
the text representation of the model file,
the mgcv model output (for easily generating simulations at
unsampled covariate values), Dunn-Smyth residuals for each species and key information needed
for other functions in the package. See <code><a href="mvgam-class.html">mvgam-class</a></code> for details.
Use <code>methods(class = "mvgam")</code> for an overview on available methods</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Joint Species Distribution Models allow for responses of multiple species to be
learned hierarchically, whereby responses to environmental variables in <code>formula</code> can be partially
pooled and any latent, unmodelled residual associations can also be learned. In <span class="pkg">mvgam</span>, both of
these effects can be modelled with the full power of latent factor Hierarchical GAMs, providing unmatched
flexibility to model full communities of species. When calling jsdgam, an initial State-Space model using
<code>trend = 'None'</code> is set up and then modified to include the latent factors and their linear predictors.
Consequently, you can inspect priors for these models using <a href="get_mvgam_priors.html">get_mvgam_priors</a> by supplying the relevant
<code>formula</code>, <code>factor_formula</code>, <code>data</code> and <code>family</code> arguments and keeping the default <code>trend = 'None'</code>.</p>
<p>In a JSDGAM, the expectation of response \(Y_{ij}\) is modelled with</p>
<p>$$g(\mu_{ij}) = X_i\beta + u_i\theta_j,$$</p>
<p>where \(g(.)\) is a known link function,
\(X\) is a design matrix of linear predictors (with associated \(\beta\) coefficients),
\(u\) are \(n_{lv}\)-variate latent factors
(\(n_{lv}\)&lt;&lt;\(n_{species}\)) and
\(\theta_j\) are species-specific loadings on the latent factors, respectively. The design matrix
\(X\) and \(\beta\) coefficients are constructed and modelled using <code>formula</code> and can contain
any of <code>mvgam</code>'s predictor effects, including random intercepts and slopes, multidimensional penalized
smooths, GP effects etc... The factor loadings \(\theta_j\) are constrained for identifiability but can
be used to reconstruct an estimate of the species' residual variance-covariance matrix
using \(\Theta \Theta'\) (see the example below and <code><a href="residual_cor.jsdgam.html">residual_cor()</a></code> for details).
The latent factors are further modelled using:
$$
u_i \sim \text{Normal}(Q_i\beta_{factor}, 1) \quad
$$
where the second design matrix \(Q\) and associated \(\beta_{factor}\) coefficients are
constructed and modelled using <code>factor_formula</code>. Again, the effects that make up this linear
predictor can contain any of <code>mvgam</code>'s allowed predictor effects, providing enormous flexibility for
modelling species' communities.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Nicholas J Clark &amp; Konstans Wells (2020). Dynamic generalised additive models (DGAMs) for forecasting discrete ecological time series.
Methods in Ecology and Evolution. 14:3, 771-784.
<br><br>
David I Warton, F Guillaume Blanchet, Robert B O’Hara, Otso Ovaskainen, Sara Taskinen, Steven C
Walker &amp; Francis KC Hui (2015). So many variables: joint modeling in community ecology.
Trends in Ecology &amp; Evolution 30:12, 766-779.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="mvgam.html">mvgam()</a></code>, <code><a href="residual_cor.jsdgam.html">residual_cor()</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Nicholas J Clark</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Simulate latent count data for 500 spatial locations and 10 species</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N_points</span> <span class="op">&lt;-</span> <span class="fl">500</span></span></span>
<span class="r-in"><span><span class="va">N_species</span> <span class="op">&lt;-</span> <span class="fl">10</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Species-level intercepts (on the log scale)</span></span></span>
<span class="r-in"><span><span class="va">alphas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_species</span>, <span class="fl">2</span>, <span class="fl">2.25</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a covariate and species-level responses to it</span></span></span>
<span class="r-in"><span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N_points</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_species</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate points uniformly over a space</span></span></span>
<span class="r-in"><span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_points</span>, min <span class="op">=</span> <span class="fl">150</span>, max <span class="op">=</span> <span class="fl">155</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N_points</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">20</span>, max <span class="op">=</span> <span class="op">-</span><span class="fl">19</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Set up spatial basis functions as a tensor product of lat and lon</span></span></span>
<span class="r-in"><span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/smoothCon.html" class="external-link">smoothCon</a></span><span class="op">(</span><span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                      knots <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The design matrix for this smooth is in the 'X' slot</span></span></span>
<span class="r-in"><span><span class="va">des_mat</span> <span class="op">&lt;-</span> <span class="va">sm</span><span class="op">$</span><span class="va">X</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">des_mat</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 500  25</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Function to generate a random covariance matrix where all variables</span></span></span>
<span class="r-in"><span><span class="co"># have unit variance (i.e. diagonals are all 1)</span></span></span>
<span class="r-in"><span><span class="va">random_Sigma</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">L_Omega</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span>, <span class="va">N</span><span class="op">)</span>;</span></span>
<span class="r-in"><span>  <span class="va">L_Omega</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>;</span></span>
<span class="r-in"><span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span> <span class="op">:</span> <span class="va">N</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">bound</span> <span class="op">&lt;-</span> <span class="fl">1</span>;</span></span>
<span class="r-in"><span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">L_Omega</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">bound</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">bound</span><span class="op">)</span><span class="op">)</span>;</span></span>
<span class="r-in"><span>      <span class="va">bound</span> <span class="op">&lt;-</span> <span class="va">bound</span> <span class="op">-</span> <span class="va">L_Omega</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">^</span> <span class="fl">2</span>;</span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>    <span class="va">L_Omega</span><span class="op">[</span><span class="va">i</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">bound</span><span class="op">)</span>;</span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="va">L_Omega</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">L_Omega</span><span class="op">)</span>;</span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a variance-covariance matrix for the correlations among</span></span></span>
<span class="r-in"><span><span class="co"># basis coefficients</span></span></span>
<span class="r-in"><span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu">random_Sigma</span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">des_mat</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now simulate the species-level basis coefficients hierarchically, where</span></span></span>
<span class="r-in"><span><span class="co"># spatial basis function correlations are a convex sum of a base correlation</span></span></span>
<span class="r-in"><span><span class="co"># matrix and a species-level correlation matrix</span></span></span>
<span class="r-in"><span><span class="va">basis_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">N_species</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">base_field</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/rmvn.html" class="external-link">rmvn</a></span><span class="op">(</span><span class="fl">1</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span>, V <span class="op">=</span> <span class="va">Sigma</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_species</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">corOmega</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>                 <span class="op">(</span><span class="fl">0.3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="fu">random_Sigma</span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">des_mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">basis_coefs</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/rmvn.html" class="external-link">rmvn</a></span><span class="op">(</span><span class="fl">1</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span>, V <span class="op">=</span> <span class="va">corOmega</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate the latent spatial processes</span></span></span>
<span class="r-in"><span><span class="va">st_process</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">N_species</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="va">lat</span>,</span></span>
<span class="r-in"><span>             lon <span class="op">=</span> <span class="va">lon</span>,</span></span>
<span class="r-in"><span>             species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'species_'</span>, <span class="va">t</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             temperature <span class="op">=</span> <span class="va">temperature</span>,</span></span>
<span class="r-in"><span>             process <span class="op">=</span> <span class="va">alphas</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">+</span></span></span>
<span class="r-in"><span>               <span class="va">betas</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">*</span> <span class="va">temperature</span> <span class="op">+</span></span></span>
<span class="r-in"><span>               <span class="va">des_mat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">basis_coefs</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now take noisy observations at some of the points (60)</span></span></span>
<span class="r-in"><span><span class="va">obs_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_points</span>, size <span class="op">=</span> <span class="fl">60</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obs_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="va">lat</span><span class="op">[</span><span class="va">obs_points</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                         lon <span class="op">=</span> <span class="va">lon</span><span class="op">[</span><span class="va">obs_points</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>                         site <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">60</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Keep only the process data at these points</span></span></span>
<span class="r-in"><span><span class="va">st_process</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">obs_points</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lat'</span>, <span class="st">'lon'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="co"># now take noisy Poisson observations of the process</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">process</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span>,</span></span>
<span class="r-in"><span>                                 levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'species_'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N_species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">lon</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">dat</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View the count distributions for each species</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>package ‘ggplot2’ was built under R version 4.3.3</span>
<span class="r-in"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">species</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="r-plt img"><img src="jsdgam-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lat</span>, y <span class="op">=</span> <span class="va">lon</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2.25</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">species</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect default priors for a joint species model with three spatial factors</span></span></span>
<span class="r-in"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span></span></span>
<span class="r-in"><span>                            <span class="co"># Environmental model includes random slopes for</span></span></span>
<span class="r-in"><span>                            <span class="co"># a linear effect of temperature</span></span></span>
<span class="r-in"><span>                            <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">species</span>, bs <span class="op">=</span> <span class="st">'re'</span>, by <span class="op">=</span> <span class="va">temperature</span><span class="op">)</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>                          <span class="co"># Each factor estimates a different nonlinear spatial process, using</span></span></span>
<span class="r-in"><span>                          <span class="co"># 'by = trend' as in other mvgam State-Space models</span></span></span>
<span class="r-in"><span>                          factor_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">lon</span>, k <span class="op">=</span> <span class="fl">6</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>                          n_lv <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>                          <span class="co"># The data and grouping variables</span></span></span>
<span class="r-in"><span>                          data <span class="op">=</span> <span class="va">dat</span>,</span></span>
<span class="r-in"><span>                          unit <span class="op">=</span> <span class="va">site</span>,</span></span>
<span class="r-in"><span>                          species <span class="op">=</span> <span class="va">species</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>                          <span class="co"># Poisson observations</span></span></span>
<span class="r-in"><span>                          family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>gp effects in mvgam cannot yet handle autogrouping</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> resetting all instances of 'gr = TRUE' to 'gr = FALSE'</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span style="color: #555555;">This warning is displayed once per session.</span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">priors</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                            param_name param_length</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1                                         (Intercept)            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2                                   vector[1] mu_raw;            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3                       vector&lt;lower=0&gt;[1] sigma_raw;            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 real&lt;lower=0&gt; alpha_gp_trend(lat, lon):trendtrend1;            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 real&lt;lower=0&gt; alpha_gp_trend(lat, lon):trendtrend2;            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 real&lt;lower=0&gt; alpha_gp_trend(lat, lon):trendtrend3;            1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                    param_info</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1                                 (Intercept)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2             s(species):temperature pop mean</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3               s(species):temperature pop sd</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 gp(lat, lon):trendtrend1 marginal deviation</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 gp(lat, lon):trendtrend2 marginal deviation</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 gp(lat, lon):trendtrend3 marginal deviation</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                                          prior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1                        (Intercept) ~ student_t(3, 2.1, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2                                       mu_raw ~ std_normal();</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3                            sigma_raw ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 alpha_gp_trend(lat, lon):trendtrend1 ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 alpha_gp_trend(lat, lon):trendtrend2 ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 alpha_gp_trend(lat, lon):trendtrend3 ~ student_t(3, 0, 2.5);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                            example_change new_lowerbound</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1                             (Intercept) ~ normal(0, 1);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2                            mu_raw ~ normal(0.65, 0.15);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3                          sigma_raw ~ exponential(0.27);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 alpha_gp_trend(lat, lon):trendtrend1 ~ normal(0, 0.86);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 alpha_gp_trend(lat, lon):trendtrend2 ~ normal(0, 0.84);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 alpha_gp_trend(lat, lon):trendtrend3 ~ normal(0, 0.78);           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   new_upperbound</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5           &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6           &lt;NA&gt;</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a JSDM that estimates hierarchical temperature responses</span></span></span>
<span class="r-in"><span><span class="co"># and that uses three latent spatial factors</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">jsdgam</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span></span></span>
<span class="r-in"><span>                <span class="co"># Environmental model includes random slopes for a</span></span></span>
<span class="r-in"><span>                <span class="co"># linear effect of temperature</span></span></span>
<span class="r-in"><span>                <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">species</span>, bs <span class="op">=</span> <span class="st">'re'</span>, by <span class="op">=</span> <span class="va">temperature</span><span class="op">)</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>              <span class="co"># Each factor estimates a different nonlinear spatial process, using</span></span></span>
<span class="r-in"><span>              <span class="co"># 'by = trend' as in other mvgam State-Space models</span></span></span>
<span class="r-in"><span>              factor_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">lon</span>, k <span class="op">=</span> <span class="fl">6</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span></span>
<span class="r-in"><span>              n_lv <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>              <span class="co"># Change default priors for fixed random effect variances and</span></span></span>
<span class="r-in"><span>              <span class="co"># factor P marginal deviations to standard normal</span></span></span>
<span class="r-in"><span>              priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                               class <span class="op">=</span> <span class="va">sigma_raw</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                               class <span class="op">=</span> <span class="va">`alpha_gp_trend(lat, lon):trendtrend1`</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                               class <span class="op">=</span> <span class="va">`alpha_gp_trend(lat, lon):trendtrend2`</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                               class <span class="op">=</span> <span class="va">`alpha_gp_trend(lat, lon):trendtrend3`</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>              <span class="co"># The data and the grouping variables</span></span></span>
<span class="r-in"><span>              data <span class="op">=</span> <span class="va">dat</span>,</span></span>
<span class="r-in"><span>              unit <span class="op">=</span> <span class="va">site</span>,</span></span>
<span class="r-in"><span>              species <span class="op">=</span> <span class="va">species</span>,</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>              <span class="co"># Poisson observations</span></span></span>
<span class="r-in"><span>              family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>              chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>              silent <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/prim.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math/rev.hpp:16,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/lib/stan_math/stan/math.hpp:19,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from stan/src/stan/model/model_header.hpp:4,</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>                  from C:/Users/uqnclar2/AppData/Local/Temp/RtmpYHBavU/model-46c143d437f.hpp:2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t&lt;T_x, T_sigma, T_l&gt; stan::math::von_mises_cdf(const T_x&amp;, const T_mu&amp;, const T_k&amp;)':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   194 |       if (cdf_n &lt; 0.0)</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>       | </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot species-level intercept estimates</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">'species'</span>,</span></span>
<span class="r-in"><span>                 type <span class="op">=</span> <span class="st">'link'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot species' hierarchical responses to temperature</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'temperature'</span>, <span class="st">'species'</span>, <span class="st">'species'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                 type <span class="op">=</span> <span class="st">'link'</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot posterior median estimates of the latent spatial factors</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'smooths'</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-5.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Or using gratia, if you have it installed</span></span></span>
<span class="r-in"><span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">'gratia'</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu">gratia</span><span class="fu">::</span><span class="fu"><a href="https://gavinsimpson.github.io/gratia/reference/draw.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">mod</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-plt img"><img src="jsdgam-6.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate residual spatial correlations</span></span></span>
<span class="r-in"><span><span class="va">post_cors</span> <span class="op">&lt;-</span> <span class="fu"><a href="residual_cor.jsdgam.html">residual_cor</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="index-mvgam.html">names</a></span><span class="op">(</span><span class="va">post_cors</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "cor"        "cor_lower"  "cor_upper"  "sig_cor"    "cov"       </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [6] "prec"       "prec_lower" "prec_upper" "sig_prec"   "trace"     </span>
<span class="r-in"><span><span class="co"># Look at lower and upper credible interval estimates for</span></span></span>
<span class="r-in"><span><span class="co"># some of the estimated correlations</span></span></span>
<span class="r-in"><span><span class="va">post_cors</span><span class="op">$</span><span class="va">cor</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            species_1  species_2   species_3  species_4   species_5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_1  1.0000000  0.7241949  0.73684086  0.7457915 -0.13435003</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_2  0.7241949  1.0000000  0.21425039  0.4452864 -0.51051466</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_3  0.7368409  0.2142504  1.00000000  0.9023762 -0.07856604</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_4  0.7457915  0.4452864  0.90237623  1.0000000 -0.46019481</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_5 -0.1343500 -0.5105147 -0.07856604 -0.4601948  1.00000000</span>
<span class="r-in"><span><span class="va">post_cors</span><span class="op">$</span><span class="va">cor_upper</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           species_1  species_2 species_3  species_4  species_5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_1 1.0000000  0.9171006 0.9449505  0.9312935  0.2409464</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_2 0.9171006  1.0000000 0.5343373  0.7384645 -0.1915665</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_3 0.9449505  0.5343373 1.0000000  0.9794676  0.2658064</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_4 0.9312935  0.7384645 0.9794676  1.0000000 -0.1021403</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_5 0.2409464 -0.1915665 0.2658064 -0.1021403  1.0000000</span>
<span class="r-in"><span><span class="va">post_cors</span><span class="op">$</span><span class="va">cor_lower</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            species_1   species_2  species_3   species_4  species_5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_1  1.0000000  0.43343762  0.3751937  0.38757498 -0.4910372</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_2  0.4334376  1.00000000 -0.1631833  0.05268693 -0.7453554</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_3  0.3751937 -0.16318325  1.0000000  0.75827725 -0.4048371</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_4  0.3875750  0.05268693  0.7582772  1.00000000 -0.7210223</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> species_5 -0.4910372 -0.74535539 -0.4048371 -0.72102229  1.0000000</span>
<span class="r-in"><span><span class="co"># A quick and dirty plot of the posterior median correlations</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">post_cors</span><span class="op">$</span><span class="va">cor</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Posterior predictive checks and ELPD-LOO can ascertain model fit</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"pit_ecdf_grouped"</span>,</span></span>
<span class="r-in"><span>         group <span class="op">=</span> <span class="st">"species"</span>, ndraws <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-8.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed from 1000 by 600 log-likelihood matrix.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Estimate    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> elpd_loo  -2188.4  50.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> p_loo       421.2  26.6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> looic      4376.8 101.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE of elpd_loo is NA.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> MCSE and ESS estimates assume MCMC draws (r_eff in [0.1, 1.8]).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Pareto k diagnostic values:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                           Count Pct.    Min. ESS</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (-Inf, 0.67]   (good)     443   73.8%   12      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    (0.67, 1]   (bad)      125   20.8%   &lt;NA&gt;    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     (1, Inf)   (very bad)  32    5.3%   &lt;NA&gt;    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> See help('pareto-k-diagnostic') for details.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Forecast log(counts) for entire region (site value doesn't matter as long</span></span></span>
<span class="r-in"><span><span class="co"># as each spatial location has a different and unique site identifier);</span></span></span>
<span class="r-in"><span><span class="co"># note this calculation takes a few minutes because of the need to calculate</span></span></span>
<span class="r-in"><span><span class="co"># draws from the stochastic latent factors</span></span></span>
<span class="r-in"><span><span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">st_process</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span>,</span></span>
<span class="r-in"><span>                                                  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'species_'</span>,</span></span>
<span class="r-in"><span>                                                                  <span class="fl">1</span><span class="op">:</span><span class="va">N_species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">lon</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>site <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the median log(count) predictions on a grid</span></span></span>
<span class="r-in"><span><span class="va">newdata</span><span class="op">$</span><span class="va">log_count</span> <span class="op">&lt;-</span> <span class="va">preds</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">newdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lat</span>, y <span class="op">=</span> <span class="va">lon</span>, col <span class="op">=</span> <span class="va">log_count</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">species</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="jsdgam-9.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

