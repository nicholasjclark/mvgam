<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>Formatting data for use in mvgam • mvgam</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Formatting data for use in mvgam">
<meta property="og:description" content="mvgam">
<meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.53</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Formatting data for use in mvgam</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2025-03-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/data_in_mvgam.Rmd" class="external-link"><code>vignettes/data_in_mvgam.Rmd</code></a></small>
      <div class="d-none name"><code>data_in_mvgam.Rmd</code></div>
    </div>

    
    
<p>This vignette gives an example of how to take raw data and format it
for use in <code>mvgam</code>. This is not an exhaustive example, as
data can be recorded and stored in a variety of ways, which requires
different approaches to wrangle the data into the necessary format for
<code>mvgam</code>. For full details on the basic <code>mvgam</code>
functionality, please see <a href="https://nicholasjclark.github.io/mvgam/articles/mvgam_overview.html">the
introductory vignette</a> and <a href="https://www.youtube.com/playlist?list=PLzFHNoUxkCvsFIg6zqogylUfPpaxau_a3&amp;si=lyg7qUrMLbD-tHCB" class="external-link">the
growing set of walk through video tutorials on <code>mvgam</code>
applications</a>.</p>
<div class="section level2">
<h2 id="required-tidy-data-format">Required <em>tidy</em> data format<a class="anchor" aria-label="anchor" href="#required-tidy-data-format"></a>
</h2>
<p>Manipulating the data into a ‘long’ format (i.e. <em>tidy</em>
format) is necessary for modelling in <code>mvgam</code>. By ‘long’
format, we mean that each <code>series x time</code> observation needs
to have its own entry in the <code>dataframe</code> or <code>list</code>
object that we wish to pass as data for to the two primary modelling
functions, <code><a href="../reference/mvgam.html">mvgam()</a></code> and <code><a href="../reference/jsdgam.html">jsdgam()</a></code>. A simple
example can be viewed by simulating data using the
<code><a href="../reference/sim_mvgam.html">sim_mvgam()</a></code> function. See <code><a href="../reference/sim_mvgam.html">?sim_mvgam</a></code> for more
details</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span></span>
<span>  n_series <span class="op">=</span> <span class="fl">4</span>, </span>
<span>  T <span class="op">=</span> <span class="fl">24</span>, </span>
<span>  prop_missing <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>, <span class="fl">16</span><span class="op">)</span></span>
<span><span class="co">#&gt;    y season year   series time</span></span>
<span><span class="co">#&gt; 1  0      1    1 series_1    1</span></span>
<span><span class="co">#&gt; 2  3      1    1 series_2    1</span></span>
<span><span class="co">#&gt; 3  3      1    1 series_3    1</span></span>
<span><span class="co">#&gt; 4  1      1    1 series_4    1</span></span>
<span><span class="co">#&gt; 5  3      2    1 series_1    2</span></span>
<span><span class="co">#&gt; 6  1      2    1 series_2    2</span></span>
<span><span class="co">#&gt; 7  4      2    1 series_3    2</span></span>
<span><span class="co">#&gt; 8  0      2    1 series_4    2</span></span>
<span><span class="co">#&gt; 9  1      3    1 series_1    3</span></span>
<span><span class="co">#&gt; 10 0      3    1 series_2    3</span></span>
<span><span class="co">#&gt; 11 1      3    1 series_3    3</span></span>
<span><span class="co">#&gt; 12 1      3    1 series_4    3</span></span>
<span><span class="co">#&gt; 13 0      4    1 series_1    4</span></span>
<span><span class="co">#&gt; 14 0      4    1 series_2    4</span></span>
<span><span class="co">#&gt; 15 0      4    1 series_3    4</span></span>
<span><span class="co">#&gt; 16 2      4    1 series_4    4</span></span></code></pre></div>
<div class="section level3">
<h3 id="series-as-a-factor-variable">
<code>series</code> as a <code>factor</code> variable<a class="anchor" aria-label="anchor" href="#series-as-a-factor-variable"></a>
</h3>
<p>Notice how we have four different time series in these simulated
data, and we have identified the series-level indicator as a
<code>factor</code> variable.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "factor"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "series_1" "series_2" "series_3" "series_4"</span></span></code></pre></div>
<p>It is important that the number of levels matches the number of
unique series in the data to ensure indexing across series works
properly in the underlying modelling functions. Several of the main
workhorse functions in the package (including <code><a href="../reference/mvgam.html">mvgam()</a></code> and
<code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code>) will give an error if this is not the
case, but it may be worth checking anyway:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Note that you can technically supply data that does not have a
<code>series</code> indicator, and the package will generally assume
that you are only using a single time series. There are exceptions to
this, for example if you have grouped data and would like to estimate
hierarchical dependencies (see an example of hierarchical process error
correlations in the <code><a href="../reference/RW.html">?AR</a></code> documentation) or if you would like
to set up a Joint Species Distribution Model (JSDM) using a Zero-Mean
Multivariate Gaussian distribution for the latent residuals (see
examples in the <code><a href="../reference/ZMVN.html">?ZMVN</a></code> documentation).</p>
</div>
<div class="section level3">
<h3 id="a-single-outcome-variable">A single outcome variable<a class="anchor" aria-label="anchor" href="#a-single-outcome-variable"></a>
</h3>
<p>You may also have notices that we do not spread the
<code>numeric / integer</code>-classed outcome variable into different
columns. Rather, there is only a single column for the outcome variable,
labelled <code>y</code> in these simulated data (though the outcome does
not have to be labelled <code>y</code>). This is another important
requirement in <code>mvgam</code>, but it shouldn’t be too unfamiliar to
<code>R</code> users who frequently use modelling packages such as
<code>lme4</code>, <code>mgcv</code>, <code>brms</code> or the many
other regression modelling packages out there. The advantage of this
format is that it is now very easy to specify effects that vary among
time series:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>  data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; glm(formula = y ~ series + time, family = poisson(), data = simdat$data_train)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    -0.63755    0.40343  -1.580 0.114037    </span></span>
<span><span class="co">#&gt; seriesseries_2  0.52233    0.42213   1.237 0.215949    </span></span>
<span><span class="co">#&gt; seriesseries_3  1.23795    0.37608   3.292 0.000996 ***</span></span>
<span><span class="co">#&gt; seriesseries_4  0.45028    0.43429   1.037 0.299822    </span></span>
<span><span class="co">#&gt; time            0.01284    0.02257   0.569 0.569442    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (Dispersion parameter for poisson family taken to be 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Null deviance: 101.652  on 59  degrees of freedom</span></span>
<span><span class="co">#&gt; Residual deviance:  86.252  on 55  degrees of freedom</span></span>
<span><span class="co">#&gt;   (12 observations deleted due to missingness)</span></span>
<span><span class="co">#&gt; AIC: 182.44</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Fisher Scoring iterations: 5</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">time</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: poisson </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; y ~ series + s(time, by = series)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;                Estimate Std. Error z value Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; (Intercept)     -0.5484     0.3456  -1.587  0.11258   </span></span>
<span><span class="co">#&gt; seriesseries_2   0.5130     0.4357   1.177  0.23903   </span></span>
<span><span class="co">#&gt; seriesseries_3   1.1818     0.3934   3.004  0.00266 **</span></span>
<span><span class="co">#&gt; seriesseries_4 -21.5347   110.5452  -0.195  0.84555   </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                          edf Ref.df Chi.sq p-value  </span></span>
<span><span class="co">#&gt; s(time):seriesseries_1 1.135  1.258  0.948  0.3480  </span></span>
<span><span class="co">#&gt; s(time):seriesseries_2 2.186  2.715  2.786  0.4972  </span></span>
<span><span class="co">#&gt; s(time):seriesseries_3 2.464  3.048  7.190  0.0676 .</span></span>
<span><span class="co">#&gt; s(time):seriesseries_4 7.834  7.986  5.992  0.6466  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.387   Deviance explained = 51.4%</span></span>
<span><span class="co">#&gt; UBRE = 0.41091  Scale est. = 1         n = 60</span></span></code></pre></div>
<p>Depending on the observation families you plan to use when building
models, there may be some restrictions that need to be satisfied within
the outcome variable. For example, a Beta regression can only handle
proportional data, so values <code>&gt;= 1</code> or
<code>&lt;= 0</code> are not allowed. Likewise, a Poisson regression can
only handle non-negative integers. Most regression functions in
<code>R</code> will assume the user knows all of this and so will not
issue any warnings or errors if you choose the wrong distribution, but
often this ends up leading to some unhelpful error from an optimizer
that is difficult to interpret and diagnose. <code>mvgam</code> will
attempt to provide some errors if you do something that is simply not
allowed. For example, we can simulate data from a zero-centred Gaussian
distribution (ensuring that some of our values will be
<code>&lt; 1</code>) and attempt a Beta regression in <code>mvgam</code>
using the <code>betar</code> family:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gauss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"series1"</span>,</span>
<span>    levels <span class="op">=</span> <span class="st">"series1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gauss_dat</span></span>
<span><span class="co">#&gt;         outcome  series time</span></span>
<span><span class="co">#&gt; 1  -0.314772157 series1    1</span></span>
<span><span class="co">#&gt; 2  -0.005381841 series1    2</span></span>
<span><span class="co">#&gt; 3  -1.358302802 series1    3</span></span>
<span><span class="co">#&gt; 4   1.572927578 series1    4</span></span>
<span><span class="co">#&gt; 5  -1.199384161 series1    5</span></span>
<span><span class="co">#&gt; 6  -0.072655731 series1    6</span></span>
<span><span class="co">#&gt; 7  -0.024083976 series1    7</span></span>
<span><span class="co">#&gt; 8   1.584497498 series1    8</span></span>
<span><span class="co">#&gt; 9   0.005675627 series1    9</span></span>
<span><span class="co">#&gt; 10 -0.648204484 series1   10</span></span></code></pre></div>
<p>A call to <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam()</a></code> using the <code>mgcv</code> package
leads to a model that actually fits (though it does give an unhelpful
warning message):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">betar</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gauss_dat</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Beta regression(0.084) </span></span>
<span><span class="co">#&gt; Link function: logit </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; outcome ~ time</span></span>
<span><span class="co">#&gt; Total model degrees of freedom 2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML score: -237.6676</span></span></code></pre></div>
<p>But the same call to <code><a href="../reference/mvgam.html">mvgam()</a></code> gives us something more
useful:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">betar</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gauss_dat</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Values &lt;= 0 not allowed for beta responses</span></span></code></pre></div>
<p>Please see <code><a href="../reference/mvgam_families.html">?mvgam_families</a></code> for more information on the
types of responses that the package can handle and their
restrictions</p>
</div>
<div class="section level3">
<h3 id="a-time-variable">A <code>time</code> variable<a class="anchor" aria-label="anchor" href="#a-time-variable"></a>
</h3>
<p>The other requirement for most models that can be fit in
<code>mvgam</code> is a <code>numeric / integer</code>-classed variable
labelled <code>time</code>. This ensures the modelling software knows
how to arrange the time series when building models. This setup still
allows us to formulate multivariate time series models. If you plan to
use any of the autoregressive dynamic trend functions available in
<code>mvgam</code> (see <code><a href="../reference/mvgam_trends.html">?mvgam_trends</a></code> for details of
available dynamic processes), you will need to ensure your time series
are entered with a fixed sampling interval (i.e. the time between
timesteps 1 and 2 should be the same as the time between timesteps 2 and
3, etc…). But note that you can have missing observations for some (or
all) series. <code><a href="../reference/mvgam.html">mvgam()</a></code> will check this for you, but again it
is useful to ensure you have no missing timepoint x series combinations
in your data. You can generally do this with a simple <code>dplyr</code>
call:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A function to ensure all timepoints within a sequence are identical</span></span>
<span><span class="va">all_times_avail</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">min_time</span>, <span class="va">max_time</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">min_time</span>, to <span class="op">=</span> <span class="va">max_time</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Get min and max times from the data</span></span>
<span><span class="va">min_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">max_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that all times are recorded for each series</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  series <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span>,</span>
<span>  time <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>all_there <span class="op">=</span> <span class="fu">all_times_avail</span><span class="op">(</span></span>
<span>    <span class="va">time</span>,</span>
<span>    <span class="va">min_time</span>,</span>
<span>    <span class="va">max_time</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">checked_times</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">checked_times</span><span class="op">$</span><span class="va">all_there</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"One or more series in is missing observations for one or more timepoints"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"All series have observations at all timepoints :)"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; All series have observations at all timepoints :)</span></span></code></pre></div>
<p>Note that models which use dynamic components will assume that
smaller values of <code>time</code> are <em>older</em>
(i.e. <code>time = 1</code> came <em>before</em> <code>time = 2</code>,
etc…)</p>
</div>
<div class="section level3">
<h3 id="irregular-sampling-intervals">Irregular sampling intervals?<a class="anchor" aria-label="anchor" href="#irregular-sampling-intervals"></a>
</h3>
<p>Most <code>mvgam</code> dynamic trend models expect <code>time</code>
to be measured in discrete, evenly-spaced intervals (i.e. one
measurement per week, or one per year, for example; though missing
values are allowed). But please note that irregularly sampled time
intervals are allowed, in which case the <code><a href="../reference/RW.html">CAR()</a></code> trend model
(continuous time autoregressive) is appropriate. You can see an example
of this kind of model in the <strong>Examples</strong> section in
<code><a href="../reference/RW.html">?CAR</a></code>. You can also use <code>trend_model = 'None'</code>
(the default in <code><a href="../reference/mvgam.html">mvgam()</a></code>) and instead use a Gaussian Process
to model temporal variation for irregularly-sampled time series. See the
<code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">?brms::gp</a></code> for details. But to reiterate the point from
above, if you do not have time series data (or don’t want to estimate
latent temporal dynamics) but you would like to estimate correlated
latent residuals among multivariate outcomes, you can set up models that
use <code>trend_model = ZMVN(...)</code> without the need for a
<code>time</code> variable (see <code><a href="../reference/ZMVN.html">?ZMVN</a></code> for details).</p>
</div>
</div>
<div class="section level2">
<h2 id="checking-data-with-get_mvgam_priors">Checking data with <code>get_mvgam_priors()</code><a class="anchor" aria-label="anchor" href="#checking-data-with-get_mvgam_priors"></a>
</h2>
<p>The <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code> function is designed to return
information about the parameters in a model whose prior distributions
can be modified by the user. But in doing so, it will perform a series
of checks to ensure the data are formatted properly. It can therefore be
very useful to new users for ensuring there isn’t anything strange going
on in the data setup. For example, we can replicate the steps taken
above (to check factor levels and timepoint x series combinations) with
a single call to <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code>. Here we first simulate
some data in which some of the timepoints in the <code>time</code>
variable are not included in the data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"series_1"</span><span class="op">)</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bad_times</span></span>
<span><span class="co">#&gt;   time   series     outcome</span></span>
<span><span class="co">#&gt; 1    1 series_1  1.85866321</span></span>
<span><span class="co">#&gt; 2    3 series_1  0.82830318</span></span>
<span><span class="co">#&gt; 3    5 series_1  1.19903527</span></span>
<span><span class="co">#&gt; 4    7 series_1  0.60005124</span></span>
<span><span class="co">#&gt; 5    9 series_1  0.05876012</span></span>
<span><span class="co">#&gt; 6   11 series_1 -1.28976353</span></span>
<span><span class="co">#&gt; 7   13 series_1 -0.12633386</span></span>
<span><span class="co">#&gt; 8   15 series_1  0.38398762</span></span></code></pre></div>
<p>Next we call <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code> by simply specifying an
intercept-only model, which is enough to trigger all the checks:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bad_times</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: One or more series in data is missing observations for one or more timepoints</span></span></code></pre></div>
<p>This error is useful as it tells us where the problem is. There are
many ways to fill in missing timepoints, so the correct way will have to
be left up to the user. But if you don’t have any covariates, it should
be pretty easy using <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_times</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">good_times</span></span>
<span><span class="va">good_times</span></span>
<span><span class="co">#&gt;    time   series     outcome</span></span>
<span><span class="co">#&gt; 1     1 series_1  1.85866321</span></span>
<span><span class="co">#&gt; 2     2 series_1          NA</span></span>
<span><span class="co">#&gt; 3     3 series_1  0.82830318</span></span>
<span><span class="co">#&gt; 4     4 series_1          NA</span></span>
<span><span class="co">#&gt; 5     5 series_1  1.19903527</span></span>
<span><span class="co">#&gt; 6     6 series_1          NA</span></span>
<span><span class="co">#&gt; 7     7 series_1  0.60005124</span></span>
<span><span class="co">#&gt; 8     8 series_1          NA</span></span>
<span><span class="co">#&gt; 9     9 series_1  0.05876012</span></span>
<span><span class="co">#&gt; 10   10 series_1          NA</span></span>
<span><span class="co">#&gt; 11   11 series_1 -1.28976353</span></span>
<span><span class="co">#&gt; 12   12 series_1          NA</span></span>
<span><span class="co">#&gt; 13   13 series_1 -0.12633386</span></span>
<span><span class="co">#&gt; 14   14 series_1          NA</span></span>
<span><span class="co">#&gt; 15   15 series_1  0.38398762</span></span></code></pre></div>
<p>Now the call to <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code>, using our filled in
data, should work:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">good_times</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                             param_name param_length           param_info</span></span>
<span><span class="co">#&gt; 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">#&gt; 2 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">#&gt;                                   prior                  example_change</span></span>
<span><span class="co">#&gt; 1 (Intercept) ~ student_t(3, 0.5, 2.5);     (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 2  sigma_obs ~ inv_gamma(1.418, 0.452); sigma_obs ~ normal(0.77, 0.45);</span></span>
<span><span class="co">#&gt;   new_lowerbound new_upperbound</span></span>
<span><span class="co">#&gt; 1             NA             NA</span></span>
<span><span class="co">#&gt; 2             NA             NA</span></span></code></pre></div>
<p>This function should also pick up on misaligned factor levels for the
<code>series</code> variable. We can check this by again simulating,
this time adding an additional factor level that is not included in the
data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,</span>
<span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"series_1"</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"series_1"</span>,</span>
<span>      <span class="st">"series_2"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "series_1" "series_2"</span></span></code></pre></div>
<p>Another call to <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code> brings up a useful
error:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bad_levels</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Mismatch between factor levels of "series" and unique values of "series"</span></span>
<span><span class="co">#&gt; Use</span></span>
<span><span class="co">#&gt;   `setdiff(levels(data$series), unique(data$series))` </span></span>
<span><span class="co">#&gt; and</span></span>
<span><span class="co">#&gt;   `intersect(levels(data$series), unique(data$series))`</span></span>
<span><span class="co">#&gt; for guidance</span></span></code></pre></div>
<p>Following the message’s advice tells us there is a level for
<code>series_2</code> in the <code>series</code> variable, but there are
no observations for this series in the data:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "series_2"</span></span></code></pre></div>
<p>Re-assigning the levels fixes the issue:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_levels</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">good_levels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">good_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "series_1"</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">good_levels</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                             param_name param_length           param_info</span></span>
<span><span class="co">#&gt; 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">#&gt; 2 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">#&gt;                                  prior                  example_change</span></span>
<span><span class="co">#&gt; 1  (Intercept) ~ student_t(3, 0, 2.5);     (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 2 sigma_obs ~ inv_gamma(1.418, 0.452); sigma_obs ~ normal(0.12, 0.87);</span></span>
<span><span class="co">#&gt;   new_lowerbound new_upperbound</span></span>
<span><span class="co">#&gt; 1             NA             NA</span></span>
<span><span class="co">#&gt; 2             NA             NA</span></span></code></pre></div>
<div class="section level3">
<h3 id="covariates-with-no-nas">Covariates with no <code>NA</code>s<a class="anchor" aria-label="anchor" href="#covariates-with-no-nas"></a>
</h3>
<p>Covariates can be used in models just as you would when using
<code>mgcv</code> (see <code><a href="https://rdrr.io/pkg/mgcv/man/formula.gam.html" class="external-link">?formula.gam</a></code> for details of the
formula syntax). But although the outcome variable can have
<code>NA</code>s, covariates cannot. Most regression software will
silently drop any raws in the model matrix that have <code>NA</code>s,
which is not helpful when debugging. Both the <code><a href="../reference/mvgam.html">mvgam()</a></code> and
<code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code> functions will run some simple checks
for you, and hopefully will return useful errors if it finds in missing
values:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">miss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"series1"</span>,</span>
<span>    levels <span class="op">=</span> <span class="st">"series1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">miss_dat</span></span>
<span><span class="co">#&gt;        outcome          cov  series time</span></span>
<span><span class="co">#&gt; 1  -1.43332110           NA series1    1</span></span>
<span><span class="co">#&gt; 2  -0.01030332 -2.177576028 series1    2</span></span>
<span><span class="co">#&gt; 3  -0.21223603 -0.117860143 series1    3</span></span>
<span><span class="co">#&gt; 4  -0.90634018  0.112294787 series1    4</span></span>
<span><span class="co">#&gt; 5  -2.10215248  0.007886198 series1    5</span></span>
<span><span class="co">#&gt; 6   1.89336046  1.877743872 series1    6</span></span>
<span><span class="co">#&gt; 7  -0.96812584  2.158756554 series1    7</span></span>
<span><span class="co">#&gt; 8  -0.10260304  0.709714522 series1    8</span></span>
<span><span class="co">#&gt; 9   0.23995957  0.766983379 series1    9</span></span>
<span><span class="co">#&gt; 10  0.06089889 -0.308211421 series1   10</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="va">outcome</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>  data <span class="op">=</span> <span class="va">miss_dat</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                             param_name param_length           param_info</span></span>
<span><span class="co">#&gt; 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">#&gt; 2                                  cov            1     cov fixed effect</span></span>
<span><span class="co">#&gt; 3 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">#&gt;                                    prior                  example_change</span></span>
<span><span class="co">#&gt; 1 (Intercept) ~ student_t(3, -0.2, 2.5);     (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 2              cov ~ student_t(3, 0, 2);             cov ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 3   sigma_obs ~ inv_gamma(1.418, 0.452); sigma_obs ~ normal(-0.3, 0.11);</span></span>
<span><span class="co">#&gt;   new_lowerbound new_upperbound</span></span>
<span><span class="co">#&gt; 1             NA             NA</span></span>
<span><span class="co">#&gt; 2             NA             NA</span></span>
<span><span class="co">#&gt; 3             NA             NA</span></span></code></pre></div>
<p>Just like with the <code>mgcv</code> package, <code>mvgam</code> can
also accept data as a <code>list</code> object. This is useful if you
want to set up <a href="https://rdrr.io/cran/mgcv/man/linear.functional.terms.html" class="external-link">linear
functional predictors</a> or even distributed lag predictors. The checks
run by <code>mvgam</code> should still work on these data. Here we
change the <code>cov</code> predictor to be a <code>matrix</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">miss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"series1"</span>,</span>
<span>    levels <span class="op">=</span> <span class="st">"series1"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">miss_dat</span><span class="op">$</span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">5</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">miss_dat</span><span class="op">$</span><span class="va">cov</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>A call to <code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code> returns the same error:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="va">outcome</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>  data <span class="op">=</span> <span class="va">miss_dat</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;                             param_name param_length           param_info</span></span>
<span><span class="co">#&gt; 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">#&gt; 2                                 cov1            1    cov1 fixed effect</span></span>
<span><span class="co">#&gt; 3                                 cov2            1    cov2 fixed effect</span></span>
<span><span class="co">#&gt; 4                                 cov3            1    cov3 fixed effect</span></span>
<span><span class="co">#&gt; 5                                 cov4            1    cov4 fixed effect</span></span>
<span><span class="co">#&gt; 6                                 cov5            1    cov5 fixed effect</span></span>
<span><span class="co">#&gt; 7 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">#&gt;                                   prior                   example_change</span></span>
<span><span class="co">#&gt; 1 (Intercept) ~ student_t(3, 0.2, 2.5);      (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 2            cov1 ~ student_t(3, 0, 2);             cov1 ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 3            cov2 ~ student_t(3, 0, 2);             cov2 ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 4            cov3 ~ student_t(3, 0, 2);             cov3 ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 5            cov4 ~ student_t(3, 0, 2);             cov4 ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 6            cov5 ~ student_t(3, 0, 2);             cov5 ~ normal(0, 1);</span></span>
<span><span class="co">#&gt; 7  sigma_obs ~ inv_gamma(1.418, 0.452); sigma_obs ~ normal(-0.61, 0.83);</span></span>
<span><span class="co">#&gt;   new_lowerbound new_upperbound</span></span>
<span><span class="co">#&gt; 1             NA             NA</span></span>
<span><span class="co">#&gt; 2             NA             NA</span></span>
<span><span class="co">#&gt; 3             NA             NA</span></span>
<span><span class="co">#&gt; 4             NA             NA</span></span>
<span><span class="co">#&gt; 5             NA             NA</span></span>
<span><span class="co">#&gt; 6             NA             NA</span></span>
<span><span class="co">#&gt; 7             NA             NA</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="plotting-with-plot_mvgam_series">Plotting with <code>plot_mvgam_series()</code><a class="anchor" aria-label="anchor" href="#plotting-with-plot_mvgam_series"></a>
</h2>
<p>Plotting the data is a useful way to ensure everything looks ok, once
you’ve gone throug the above checks on factor levels and timepoint x
series combinations. The <code><a href="../reference/plot_mvgam_series.html">plot_mvgam_series()</a></code> function will
take supplied data and plot either a series of line plots (if you choose
<code>series = 'all'</code>) or a set of plots to describe the
distribution for a single time series. For example, to plot all of the
time series in our data, and highlight a single series in each plot, we
can use:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  series <span class="op">=</span> <span class="st">"all"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-24-1.png" alt="Plotting time series features for GAM models in mvgam" width="60%" style="display: block; margin: auto;"></p>
<p>Or we can look more closely at the distribution for the first time
series:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  series <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-25-1.png" alt="Plotting time series features for GAM models in mvgam" width="60%" style="display: block; margin: auto;"></p>
<p>If you have split your data into training and testing folds (i.e. for
forecast evaluation), you can include the test data in your plots:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_test</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  series <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-26-1.png" alt="Plotting time series features for GAM models in mvgam" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="example-with-neon-tick-data">Example with NEON tick data<a class="anchor" aria-label="anchor" href="#example-with-neon-tick-data"></a>
</h2>
<p>To give one example of how data can be reformatted for
<code>mvgam</code> modelling, we will use observations from the National
Ecological Observatory Network (NEON) tick drag cloth samples.
<em>Ixodes scapularis</em> is a widespread tick species capable of
transmitting a diversity of parasites to animals and humans, many of
which are zoonotic. Due to the medical and ecological importance of this
tick species, a common goal is to understand factors that influence
their abundances. The NEON field team carries out standardised <a href="https://www.neonscience.org/data-collection/ticks" target="_blank" class="external-link">long-term monitoring of tick abundances as well as other
important indicators of ecological change</a>. Nymphal abundance of
<em>I. scapularis</em> is routinely recorded across NEON plots using a
field sampling method called drag cloth sampling, which is a common
method for sampling ticks in the landscape. Field researchers sample
ticks by dragging a large cloth behind themselves through terrain that
is suspected of harboring ticks, usually working in a grid-like pattern.
The sites have been sampled since 2014, resulting in a rich dataset of
nymph abundance time series. These tick time series show strong
seasonality and incorporate many of the challenging features associated
with ecological data including overdispersion, high proportions of
missingness and irregular sampling in time, making them useful for
exploring the utility of dynamic GAMs.</p>
<p>We begin by loading NEON tick data for the years 2014 - 2021, which
were downloaded from NEON and prepared as described in <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13974" target="_blank" class="external-link">Clark &amp; Wells 2022</a>. You can read a bit about the
data using the call <code><a href="../reference/all_neon_tick_data.html">?all_neon_tick_data</a></code></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"all_neon_tick_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="va">all_neon_tick_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; tibble [3,505 × 24] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">#&gt;  $ Year                : num [1:3505] 2015 2015 2015 2015 2015 ...</span></span>
<span><span class="co">#&gt;  $ epiWeek             : chr [1:3505] "37" "38" "39" "40" ...</span></span>
<span><span class="co">#&gt;  $ yearWeek            : chr [1:3505] "201537" "201538" "201539" "201540" ...</span></span>
<span><span class="co">#&gt;  $ plotID              : chr [1:3505] "BLAN_005" "BLAN_005" "BLAN_005" "BLAN_005" ...</span></span>
<span><span class="co">#&gt;  $ siteID              : chr [1:3505] "BLAN" "BLAN" "BLAN" "BLAN" ...</span></span>
<span><span class="co">#&gt;  $ nlcdClass           : chr [1:3505] "deciduousForest" "deciduousForest" "deciduousForest" "deciduousForest" ...</span></span>
<span><span class="co">#&gt;  $ decimalLatitude     : num [1:3505] 39.1 39.1 39.1 39.1 39.1 ...</span></span>
<span><span class="co">#&gt;  $ decimalLongitude    : num [1:3505] -78 -78 -78 -78 -78 ...</span></span>
<span><span class="co">#&gt;  $ elevation           : num [1:3505] 168 168 168 168 168 ...</span></span>
<span><span class="co">#&gt;  $ totalSampledArea    : num [1:3505] 162 NA NA NA 162 NA NA NA NA 164 ...</span></span>
<span><span class="co">#&gt;  $ amblyomma_americanum: num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ ixodes_scapularis   : num [1:3505] 2 NA NA NA 0 NA NA NA NA 0 ...</span></span>
<span><span class="co">#&gt;  $ time                : Date[1:3505], format: "2015-09-13" "2015-09-20" ...</span></span>
<span><span class="co">#&gt;  $ RHMin_precent       : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ RHMin_variance      : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ RHMax_precent       : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ RHMax_variance      : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ airTempMin_degC     : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ airTempMin_variance : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ airTempMax_degC     : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ airTempMax_variance : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;  $ soi                 : num [1:3505] -18.4 -17.9 -23.5 -28.4 -25.9 ...</span></span>
<span><span class="co">#&gt;  $ cum_sdd             : num [1:3505] 173 173 173 173 173 ...</span></span>
<span><span class="co">#&gt;  $ cum_gdd             : num [1:3505] 1129 1129 1129 1129 1129 ...</span></span></code></pre></div>
<p>For this exercise, we will use the <code>epiWeek</code> variable as
an index of seasonality, and we will only work with observations from a
few sampling plots (labelled in the <code>plotID</code> column):</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"SCBI_013"</span>, <span class="st">"SCBI_002"</span>,</span>
<span>  <span class="st">"SERC_001"</span>, <span class="st">"SERC_005"</span>,</span>
<span>  <span class="st">"SERC_006"</span>, <span class="st">"SERC_012"</span>,</span>
<span>  <span class="st">"BLAN_012"</span>, <span class="st">"BLAN_005"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can select the target species we want (<em>I.
scapularis</em>), filter to the correct plot IDs and convert the
<code>epiWeek</code> variable from <code>character</code> to
<code>numeric</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op">&lt;-</span> <span class="va">all_neon_tick_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">ixodes_scapularis</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">plotID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">plotIDs</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span>, <span class="va">plotID</span>, <span class="va">target</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>epiWeek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">epiWeek</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now is the tricky part: we need to fill in missing observations with
<code>NA</code>s. The tick data are sparse in that field observers do
not go out and sample in each possible <code>epiWeek</code>. So there
are many particular weeks in which observations are not included in the
data. But we can use <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> again to take care of
this:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Create all possible combos of plotID, Year and epiWeek;</span></span>
<span>  <span class="co"># missing outcomes will be filled in as NA</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>    plotID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">plotID</span><span class="op">)</span>,</span>
<span>    Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>    epiWeek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">52</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># left_join back to original data so plotID and siteID will</span></span>
<span>  <span class="co"># match up, in case you need the siteID for anything else later on</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">all_neon_tick_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">siteID</span>, <span class="va">plotID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span></span></code></pre></div>
<p>Create the <code>series</code> variable needed for <code>mvgam</code>
modelling:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    series <span class="op">=</span> <span class="va">plotID</span>,</span>
<span>    y <span class="op">=</span> <span class="va">target</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    siteID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">siteID</span><span class="op">)</span>,</span>
<span>    series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target</span>, <span class="op">-</span><span class="va">plotID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span>, <span class="va">series</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span></span></code></pre></div>
<p>Now create the <code>time</code> variable, which needs to track
<code>Year</code> and <code>epiWeek</code> for each unique series. The
<code>n</code> function from <code>dplyr</code> is often useful if
generating a <code>time</code> index for grouped dataframes:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span></span></code></pre></div>
<p>Check factor levels for the <code>series</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "BLAN_005" "BLAN_012" "SCBI_002" "SCBI_013" "SERC_001" "SERC_005" "SERC_006"</span></span>
<span><span class="co">#&gt; [8] "SERC_012"</span></span></code></pre></div>
<p>This looks good, as does a more rigorous check using
<code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">model_dat</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    param_name param_length  param_info                                  prior</span></span>
<span><span class="co">#&gt; 1 (Intercept)            1 (Intercept) (Intercept) ~ student_t(3, -2.3, 2.5);</span></span>
<span><span class="co">#&gt;                example_change new_lowerbound new_upperbound</span></span>
<span><span class="co">#&gt; 1 (Intercept) ~ normal(0, 1);             NA             NA</span></span></code></pre></div>
<p>We can also set up a model in <code><a href="../reference/mvgam.html">mvgam()</a></code> but use
<code>run_model = FALSE</code> to further ensure all of the necessary
steps for creating the modelling code and objects will run. It is
recommended that you use the <code>cmdstanr</code> backend if possible,
as the auto-formatting options available in this package are very useful
for checking the package-generated <code>Stan</code> code for any
inefficiencies that can be fixed to lead to sampling performance
improvements:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">epiWeek</span>, by <span class="op">=</span> <span class="va">series</span>, bs <span class="op">=</span> <span class="st">"cc"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">series</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">model_dat</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">"cmdstanr"</span>,</span>
<span>  run_model <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This call runs without issue, and the resulting object now contains
the model code and data objects that are needed to initiate
sampling:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">testmod</span><span class="op">$</span><span class="va">model_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 25</span></span>
<span><span class="co">#&gt;  $ y           : num [1:416, 1:8] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...</span></span>
<span><span class="co">#&gt;  $ n           : int 416</span></span>
<span><span class="co">#&gt;  $ X           : num [1:3328, 1:73] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:3328] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:73] "X.Intercept." "V2" "V3" "V4" ...</span></span>
<span><span class="co">#&gt;  $ S1          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ zero        : num [1:73] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ S2          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S3          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S4          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S5          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S6          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S7          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ S8          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">#&gt;  $ p_coefs     : Named num 0</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr "(Intercept)"</span></span>
<span><span class="co">#&gt;  $ p_taus      : num 0.933</span></span>
<span><span class="co">#&gt;  $ ytimes      : int [1:416, 1:8] 1 9 17 25 33 41 49 57 65 73 ...</span></span>
<span><span class="co">#&gt;  $ n_series    : int 8</span></span>
<span><span class="co">#&gt;  $ sp          : Named num [1:9] 0.368 0.368 0.368 0.368 0.368 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr [1:9] "s(epiWeek):seriesBLAN_005" "s(epiWeek):seriesBLAN_012" "s(epiWeek):seriesSCBI_002" "s(epiWeek):seriesSCBI_013" ...</span></span>
<span><span class="co">#&gt;  $ y_observed  : num [1:416, 1:8] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ total_obs   : int 3328</span></span>
<span><span class="co">#&gt;  $ num_basis   : int 73</span></span>
<span><span class="co">#&gt;  $ n_sp        : num 9</span></span>
<span><span class="co">#&gt;  $ n_nonmissing: int 400</span></span>
<span><span class="co">#&gt;  $ obs_ind     : int [1:400] 89 93 98 101 115 118 121 124 127 130 ...</span></span>
<span><span class="co">#&gt;  $ flat_ys     : num [1:400] 2 0 0 0 0 0 0 25 36 14 ...</span></span>
<span><span class="co">#&gt;  $ flat_xs     : num [1:400, 1:73] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:400] "705" "737" "777" "801" ...</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:73] "X.Intercept." "V2" "V3" "V4" ...</span></span>
<span><span class="co">#&gt;  - attr(*, "trend_model")= chr "AR1"</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">stancode</a></span><span class="op">(</span><span class="va">testmod</span><span class="op">)</span></span>
<span><span class="co">#&gt; // Stan model code generated by package mvgam</span></span>
<span><span class="co">#&gt; data {</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; total_obs; // total number of observations</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n; // number of timepoints per series</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_sp; // number of smoothing parameters</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_series; // number of series</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis] zero; // prior locations for basis coefficients</span></span>
<span><span class="co">#&gt;   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span></span>
<span><span class="co">#&gt;   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S1; // mgcv smooth penalty matrix S1</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S2; // mgcv smooth penalty matrix S2</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S3; // mgcv smooth penalty matrix S3</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S4; // mgcv smooth penalty matrix S4</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S5; // mgcv smooth penalty matrix S5</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S6; // mgcv smooth penalty matrix S6</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S7; // mgcv smooth penalty matrix S7</span></span>
<span><span class="co">#&gt;   matrix[8, 8] S8; // mgcv smooth penalty matrix S8</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span></span>
<span><span class="co">#&gt;   array[n_nonmissing] int&lt;lower=0&gt; flat_ys; // flattened nonmissing observations</span></span>
<span><span class="co">#&gt;   matrix[n_nonmissing, num_basis] flat_xs; // X values for nonmissing observations</span></span>
<span><span class="co">#&gt;   array[n_nonmissing] int&lt;lower=0&gt; obs_ind; // indices of nonmissing observations</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   // raw basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis] b_raw;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // random effect variances</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[1] sigma_raw;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // random effect means</span></span>
<span><span class="co">#&gt;   vector[1] mu_raw;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent trend AR1 terms</span></span>
<span><span class="co">#&gt;   vector&lt;lower=-1, upper=1&gt;[n_series] ar1;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent trend variance parameters</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[n_series] sigma;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent trends</span></span>
<span><span class="co">#&gt;   matrix[n, n_series] trend;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // smoothing parameters</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[n_sp] lambda;</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed parameters {</span></span>
<span><span class="co">#&gt;   // basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis] b;</span></span>
<span><span class="co">#&gt;   b[1 : 65] = b_raw[1 : 65];</span></span>
<span><span class="co">#&gt;   b[66 : 73] = mu_raw[1] + b_raw[66 : 73] * sigma_raw[1];</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; model {</span></span>
<span><span class="co">#&gt;   // prior for random effect population variances</span></span>
<span><span class="co">#&gt;   sigma_raw ~ inv_gamma(1.418, 0.452);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for random effect population means</span></span>
<span><span class="co">#&gt;   mu_raw ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for (Intercept)...</span></span>
<span><span class="co">#&gt;   b_raw[1] ~ student_t(3, -2.3, 2.5);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesBLAN_005...</span></span>
<span><span class="co">#&gt;   b_raw[2 : 9] ~ multi_normal_prec(zero[2 : 9], S1[1 : 8, 1 : 8] * lambda[1]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesBLAN_012...</span></span>
<span><span class="co">#&gt;   b_raw[10 : 17] ~ multi_normal_prec(zero[10 : 17],</span></span>
<span><span class="co">#&gt;                                      S2[1 : 8, 1 : 8] * lambda[2]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSCBI_002...</span></span>
<span><span class="co">#&gt;   b_raw[18 : 25] ~ multi_normal_prec(zero[18 : 25],</span></span>
<span><span class="co">#&gt;                                      S3[1 : 8, 1 : 8] * lambda[3]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSCBI_013...</span></span>
<span><span class="co">#&gt;   b_raw[26 : 33] ~ multi_normal_prec(zero[26 : 33],</span></span>
<span><span class="co">#&gt;                                      S4[1 : 8, 1 : 8] * lambda[4]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSERC_001...</span></span>
<span><span class="co">#&gt;   b_raw[34 : 41] ~ multi_normal_prec(zero[34 : 41],</span></span>
<span><span class="co">#&gt;                                      S5[1 : 8, 1 : 8] * lambda[5]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSERC_005...</span></span>
<span><span class="co">#&gt;   b_raw[42 : 49] ~ multi_normal_prec(zero[42 : 49],</span></span>
<span><span class="co">#&gt;                                      S6[1 : 8, 1 : 8] * lambda[6]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSERC_006...</span></span>
<span><span class="co">#&gt;   b_raw[50 : 57] ~ multi_normal_prec(zero[50 : 57],</span></span>
<span><span class="co">#&gt;                                      S7[1 : 8, 1 : 8] * lambda[7]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(epiWeek):seriesSERC_012...</span></span>
<span><span class="co">#&gt;   b_raw[58 : 65] ~ multi_normal_prec(zero[58 : 65],</span></span>
<span><span class="co">#&gt;                                      S8[1 : 8, 1 : 8] * lambda[8]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior (non-centred) for s(series)...</span></span>
<span><span class="co">#&gt;   b_raw[66 : 73] ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // priors for AR parameters</span></span>
<span><span class="co">#&gt;   ar1 ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // priors for smoothing parameters</span></span>
<span><span class="co">#&gt;   lambda ~ normal(5, 30);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // priors for latent trend variance parameters</span></span>
<span><span class="co">#&gt;   sigma ~ inv_gamma(1.418, 0.452);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // trend estimates</span></span>
<span><span class="co">#&gt;   trend[1, 1 : n_series] ~ normal(0, sigma);</span></span>
<span><span class="co">#&gt;   for (s in 1 : n_series) {</span></span>
<span><span class="co">#&gt;     trend[2 : n, s] ~ normal(ar1[s] * trend[1 : (n - 1), s], sigma[s]);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt;   {</span></span>
<span><span class="co">#&gt;     // likelihood functions</span></span>
<span><span class="co">#&gt;     vector[n_nonmissing] flat_trends;</span></span>
<span><span class="co">#&gt;     flat_trends = to_vector(trend)[obs_ind];</span></span>
<span><span class="co">#&gt;     flat_ys ~ poisson_log_glm(append_col(flat_xs, flat_trends), 0.0,</span></span>
<span><span class="co">#&gt;                               append_row(b, 1.0));</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; generated quantities {</span></span>
<span><span class="co">#&gt;   vector[total_obs] eta;</span></span>
<span><span class="co">#&gt;   matrix[n, n_series] mus;</span></span>
<span><span class="co">#&gt;   vector[n_sp] rho;</span></span>
<span><span class="co">#&gt;   vector[n_series] tau;</span></span>
<span><span class="co">#&gt;   array[n, n_series] int ypred;</span></span>
<span><span class="co">#&gt;   rho = log(lambda);</span></span>
<span><span class="co">#&gt;   for (s in 1 : n_series) {</span></span>
<span><span class="co">#&gt;     tau[s] = pow(sigma[s], -2.0);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // posterior predictions</span></span>
<span><span class="co">#&gt;   eta = X * b;</span></span>
<span><span class="co">#&gt;   for (s in 1 : n_series) {</span></span>
<span><span class="co">#&gt;     mus[1 : n, s] = eta[ytimes[1 : n, s]] + trend[1 : n, s];</span></span>
<span><span class="co">#&gt;     ypred[1 : n, s] = poisson_log_rng(mus[1 : n, s]);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>The following papers and resources offer useful material about
Dynamic GAMs and how they can be applied in practice:</p>
<p>Clark, Nicholas J. and Wells, K. <a href="https://doi.org/10.1111/2041-210X.13974" class="external-link">Dynamic Generalized
Additive Models (DGAMs) for forecasting discrete ecological time
series</a>. <em>Methods in Ecology and Evolution</em>. (2023): 14,
771-784.</p>
<p>Clark, Nicholas J., et al. <a href="https://peerj.com/articles/18929/" class="external-link">Beyond single-species models:
leveraging multispecies forecasts to navigate the dynamics of ecological
predictability</a>. <em>PeerJ</em>. (2025): 13:e18929</p>
<p>de Sousa, Heitor C., et al. <a href="https://doi.org/10.1111/1365-2656.14188" class="external-link">Severe fire regimes
decrease resilience of ectothermic populations</a>. <em>Journal of
Animal Ecology</em> (2024): 93(11), 1656-1669.</p>
<p>Hannaford, Naomi E., et al. <a href="https://doi.org/10.1016/j.csda.2022.107659" class="external-link">A sparse Bayesian
hierarchical vector autoregressive model for microbial dynamics in a
wastewater treatment plant.</a> <em>Computational Statistics &amp; Data
Analysis</em> (2023): 179, 107659.</p>
<p>Karunarathna, K.A.N.K., et al. <a href="https://doi.org/10.1016/j.ecolmodel.2024.110648" class="external-link">Modelling
nonlinear responses of a desert rodent species to environmental change
with hierarchical dynamic generalized additive models</a>.
<em>Ecological Modelling</em> (2024): 490, 110648.</p>
<p>Zhu, L., et al. <a href="https://doi.org/10.1111/1365-2435.14711" class="external-link">Responses of a widespread
pest insect to extreme high temperatures are stage-dependent and
divergent among seasonal cohorts</a>. <em>Functional Ecology</em>
(2025): 39, 165–180. <a href="https://doi.org/10.1111/1365-2435.14711" class="external-link uri">https://doi.org/10.1111/1365-2435.14711</a></p>
</div>
<div class="section level2">
<h2 id="interested-in-contributing">Interested in contributing?<a class="anchor" aria-label="anchor" href="#interested-in-contributing"></a>
</h2>
<p>I’m actively seeking PhD students and other researchers to work in
the areas of ecological forecasting, multivariate model evaluation and
development of <code>mvgam</code>. Please see <a href="https://ecogambler.netlify.app/opportunities/" class="external-link">this small list of
opportunities on my website</a> and do reach out if you are interested
(n.clark’at’uq.edu.au)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
