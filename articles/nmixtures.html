<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>N-mixtures in mvgam • mvgam</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="N-mixtures in mvgam">
<meta property="og:description" content="mvgam">
<meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.51</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>N-mixtures in mvgam</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2025-03-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/nmixtures.Rmd" class="external-link"><code>vignettes/nmixtures.Rmd</code></a></small>
      <div class="d-none name"><code>nmixtures.Rmd</code></div>
    </div>

    
    
<p>The purpose of this vignette is to show how the <code>mvgam</code>
package can be used to fit and interrogate N-mixture models for
population abundance counts made with imperfect detection.</p>
<div class="section level2">
<h2 id="n-mixture-models">N-mixture models<a class="anchor" aria-label="anchor" href="#n-mixture-models"></a>
</h2>
<p>An N-mixture model is a fairly recent addition to the ecological
modeller’s toolkit that is designed to make inferences about variation
in the abundance of species when observations are imperfect (<a href="https://onlinelibrary.wiley.com/doi/10.1111/j.0006-341X.2004.00142.x" target="_blank" class="external-link">Royle 2004</a>). Briefly, assume <span class="math inline">\(\boldsymbol{Y_{i,r}}\)</span> is the number of
individuals recorded at site <span class="math inline">\(i\)</span>
during replicate sampling observation <span class="math inline">\(r\)</span> (recorded as a non-negative integer).
If multiple replicate surveys are done within a short enough period to
satisfy the assumption that the population remained closed (i.e. there
was no substantial change in true population size between replicate
surveys), we can account for the fact that observations aren’t perfect.
This is done by assuming that these replicate observations are Binomial
random variables that are parameterized by the true “latent” abundance
<span class="math inline">\(N\)</span> and a detection probability <span class="math inline">\(p\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\boldsymbol{Y_{i,r}} &amp; \sim \text{Binomial}(N_i, p_r) \\
N_{i} &amp; \sim \text{Poisson}(\lambda_i)  \end{align*}\]</span></p>
<p>Using a set of linear predictors, we can estimate effects of
covariates <span class="math inline">\(\boldsymbol{X}\)</span> on the
expected latent abundance (with a log link for <span class="math inline">\(\lambda\)</span>) and, jointly, effects of
possibly different covariates (call them <span class="math inline">\(\boldsymbol{Q}\)</span>) on detection probability
(with a logit link for <span class="math inline">\(p\)</span>):</p>
<p><span class="math display">\[\begin{align*}
log(\lambda) &amp; = \beta \boldsymbol{X} \\
logit(p) &amp; = \gamma \boldsymbol{Q}\end{align*}\]</span></p>
<p><code>mvgam</code> can handle this type of model because it is
designed to propagate unobserved temporal processes that evolve
independently of the observation process in a State-space format. This
setup adapts well to N-mixture models because they can be thought of as
State-space models in which the latent state is a discrete variable
representing the “true” but unknown population size. This is very
convenient because we can incorporate any of the package’s diverse
effect types (i.e. multidimensional splines, time-varying effects,
monotonic effects, random effects etc…) into the linear predictors. All
that is required for this to work is a marginalization trick that allows
<code>Stan</code>’s sampling algorithms to handle discrete parameters
(see more about how this method of “integrating out” discrete parameters
works in <a href="https://mbjoseph.github.io/posts/2020-04-28-a-step-by-step-guide-to-marginalizing-over-discrete-parameters-for-ecologists-using-stan/" target="_blank" class="external-link">this nice blog post by Maxwell Joseph</a>).</p>
<p>The family <code><a href="../reference/mvgam_families.html">nmix()</a></code> is used to set up N-mixture models in
<code>mvgam</code>, but we still need to do a little bit of data
wrangling to ensure the data are set up in the correct format (this is
especially true when we have more than one replicate survey per time
period). The most important aspects are: (1) how we set up the
observation <code>series</code> and <code>trend_map</code> arguments to
ensure replicate surveys are mapped to the correct latent abundance
model and (2) the inclusion of a <code>cap</code> variable that defines
the maximum possible integer value to use for each observation when
estimating latent abundance. The two examples below give a reasonable
overview of how this can be done.</p>
</div>
<div class="section level2">
<h2 id="example-1-a-two-species-system-with-nonlinear-trends">Example 1: a two-species system with nonlinear trends<a class="anchor" aria-label="anchor" href="#example-1-a-two-species-system-with-nonlinear-trends"></a>
</h2>
<p>First we will use a simple simulation in which multiple replicate
observations are taken at each timepoint for two different species. The
simulation produces observations at a single site over six years, with
five replicate surveys per year. Each species is simulated to have
different nonlinear temporal trends and different detection
probabilities. For now, detection probability is fixed (i.e. it does not
change over time or in association with any covariates). Notice that we
add the <code>cap</code> variable, which does not need to be static, to
define the maximum possible value that we think the latent abundance
could be for each timepoint. This simply needs to be large enough that
we get a reasonable idea of which latent N values are most likely,
without adding too much computational cost:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span></span>
<span><span class="co"># Simulate observations for species 1, which shows a declining trend and 0.7 detection probability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  site <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># five replicates per year; six years</span></span>
<span>  replicate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  species <span class="op">=</span> <span class="st">"sp_1"</span>,</span>
<span>  <span class="co"># true abundance declines nonlinearly</span></span>
<span>  truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">26</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">23</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># observations are taken with detection prob = 0.7</span></span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">28</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">26</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">23</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">14</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">14</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># add 'series' information, which is an identifier of site, replicate and species</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"site_"</span>, <span class="va">site</span>,</span>
<span>      <span class="st">"_"</span>, <span class="va">species</span>,</span>
<span>      <span class="st">"_rep_"</span>, <span class="va">replicate</span></span>
<span>    <span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,</span>
<span>    <span class="co"># add a 'cap' variable that defines the maximum latent N to</span></span>
<span>    <span class="co"># marginalize over when estimating latent abundance; in other words</span></span>
<span>    <span class="co"># how large do we realistically think the true abundance could be?</span></span>
<span>    cap <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">replicate</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">testdat</span></span>
<span></span>
<span><span class="co"># Now add another species that has a different temporal trend and a smaller</span></span>
<span><span class="co"># detection probability (0.45 for this species)</span></span>
<span><span class="va">testdat</span> <span class="op">&lt;-</span> <span class="va">testdat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    site <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    replicate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    species <span class="op">=</span> <span class="st">"sp_2"</span>,</span>
<span>    truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">16</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">19</span>, <span class="fl">0.45</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">18</span>, <span class="fl">0.45</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>        <span class="st">"site_"</span>, <span class="va">site</span>,</span>
<span>        <span class="st">"_"</span>, <span class="va">species</span>,</span>
<span>        <span class="st">"_rep_"</span>, <span class="va">replicate</span></span>
<span>      <span class="op">)</span>,</span>
<span>      time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,</span>
<span>      cap <span class="op">=</span> <span class="fl">50</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">replicate</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This data format isn’t too difficult to set up, but it does differ
from the traditional multidimensional array setup that is commonly used
for fitting N-mixture models in other software packages. Next we ensure
that species and series IDs are included as factor variables, in case
we’d like to allow certain effects to vary by species</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testdat</span><span class="op">$</span><span class="va">species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">testdat</span><span class="op">$</span><span class="va">species</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">testdat</span><span class="op">$</span><span class="va">species</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">testdat</span><span class="op">$</span><span class="va">series</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">testdat</span><span class="op">$</span><span class="va">series</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">testdat</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Preview the dataset to get an idea of how it is structured:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">testdat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 60</span></span>
<span><span class="co">#&gt; Columns: 7</span></span>
<span><span class="co">#&gt; $ site    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span></span>
<span><span class="co">#&gt; $ time    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5,…</span></span>
<span><span class="co">#&gt; $ species <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp…</span></span>
<span><span class="co">#&gt; $ truth   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 28, 28, 28, 28, 28, 26, 26, 26, 26, 26, 23, 23, 23, 23, 23, 16…</span></span>
<span><span class="co">#&gt; $ obs     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 20, 19, 23, 17, 18, 21, 18, 21, 19, 18, 17, 16, 20, 11, 19, 9,…</span></span>
<span><span class="co">#&gt; $ series  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> site_1_sp_1_rep_1, site_1_sp_1_rep_2, site_1_sp_1_rep_3, site_…</span></span>
<span><span class="co">#&gt; $ cap     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 10…</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">testdat</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="co">#&gt;    site time species truth obs            series cap</span></span>
<span><span class="co">#&gt; 1     1    1    sp_1    28  20 site_1_sp_1_rep_1 100</span></span>
<span><span class="co">#&gt; 2     1    1    sp_1    28  19 site_1_sp_1_rep_2 100</span></span>
<span><span class="co">#&gt; 3     1    1    sp_1    28  23 site_1_sp_1_rep_3 100</span></span>
<span><span class="co">#&gt; 4     1    1    sp_1    28  17 site_1_sp_1_rep_4 100</span></span>
<span><span class="co">#&gt; 5     1    1    sp_1    28  18 site_1_sp_1_rep_5 100</span></span>
<span><span class="co">#&gt; 6     1    2    sp_1    26  21 site_1_sp_1_rep_1 100</span></span>
<span><span class="co">#&gt; 7     1    2    sp_1    26  18 site_1_sp_1_rep_2 100</span></span>
<span><span class="co">#&gt; 8     1    2    sp_1    26  21 site_1_sp_1_rep_3 100</span></span>
<span><span class="co">#&gt; 9     1    2    sp_1    26  19 site_1_sp_1_rep_4 100</span></span>
<span><span class="co">#&gt; 10    1    2    sp_1    26  18 site_1_sp_1_rep_5 100</span></span>
<span><span class="co">#&gt; 11    1    3    sp_1    23  17 site_1_sp_1_rep_1 100</span></span>
<span><span class="co">#&gt; 12    1    3    sp_1    23  16 site_1_sp_1_rep_2 100</span></span></code></pre></div>
<div class="section level3">
<h3 id="setting-up-the-trend_map">Setting up the <code>trend_map</code><a class="anchor" aria-label="anchor" href="#setting-up-the-trend_map"></a>
</h3>
<p>Finally, we need to set up the <code>trend_map</code> object. This is
crucial for allowing multiple observations to be linked to the same
latent process model (see more information about this argument in the <a href="https://nicholasjclark.github.io/mvgam/articles/shared_states.html" target="_blank">Shared latent states vignette</a>). In this case, the
mapping operates by species and site to state that each set of replicate
observations from the same time point should all share the exact same
latent abundance model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testdat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># each unique combination of site*species is a separate process</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>trend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">trend</span>, <span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">trend_map</span></span>
<span><span class="va">trend_map</span></span>
<span><span class="co">#&gt;    trend            series</span></span>
<span><span class="co">#&gt; 1      1 site_1_sp_1_rep_1</span></span>
<span><span class="co">#&gt; 2      1 site_1_sp_1_rep_2</span></span>
<span><span class="co">#&gt; 3      1 site_1_sp_1_rep_3</span></span>
<span><span class="co">#&gt; 4      1 site_1_sp_1_rep_4</span></span>
<span><span class="co">#&gt; 5      1 site_1_sp_1_rep_5</span></span>
<span><span class="co">#&gt; 6      2 site_1_sp_2_rep_1</span></span>
<span><span class="co">#&gt; 7      2 site_1_sp_2_rep_2</span></span>
<span><span class="co">#&gt; 8      2 site_1_sp_2_rep_3</span></span>
<span><span class="co">#&gt; 9      2 site_1_sp_2_rep_4</span></span>
<span><span class="co">#&gt; 10     2 site_1_sp_2_rep_5</span></span></code></pre></div>
<p>Notice how all of the replicates for species 1 in site 1 share the
same process (i.e. the same <code>trend</code>). This will ensure that
all replicates are Binomial draws of the same latent N.</p>
</div>
<div class="section level3">
<h3 id="modelling-with-the-nmix-family">Modelling with the <code>nmix()</code> family<a class="anchor" aria-label="anchor" href="#modelling-with-the-nmix-family"></a>
</h3>
<p>Now we are ready to fit a model using <code><a href="../reference/mvgam.html">mvgam()</a></code>. This
model will allow each species to have different detection probabilities
and different temporal trends. We will use <code>Cmdstan</code> as the
backend, which by default will use Hamiltonian Monte Carlo for full
Bayesian inference</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="co"># the observation formula sets up linear predictors for</span></span>
<span>  <span class="co"># detection probability on the logit scale</span></span>
<span>  formula <span class="op">=</span> <span class="va">obs</span> <span class="op">~</span> <span class="va">species</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># the trend_formula sets up the linear predictors for</span></span>
<span>  <span class="co"># the latent abundance processes on the log scale</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">time</span>, by <span class="op">=</span> <span class="va">trend</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="va">species</span>,</span>
<span></span>
<span>  <span class="co"># the trend_map takes care of the mapping</span></span>
<span>  trend_map <span class="op">=</span> <span class="va">trend_map</span>,</span>
<span></span>
<span>  <span class="co"># nmix() family and data</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">nmix</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">testdat</span>,</span>
<span></span>
<span>  <span class="co"># priors can be set in the usual way</span></span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept_trend</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>View the automatically-generated <code>Stan</code> code to get a
sense of how the marginalization over latent N works</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/code.html">code</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; // Stan model code generated by package mvgam</span></span>
<span><span class="co">#&gt; data {</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; total_obs; // total number of observations</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n; // number of timepoints per series</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_sp_trend; // number of trend smoothing parameters</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_lv; // number of dynamic factors</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_series; // number of series</span></span>
<span><span class="co">#&gt;   matrix[n_series, n_lv] Z; // matrix mapping series to latent states</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; num_basis_trend; // number of trend basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis_trend] zero_trend; // prior locations for trend basis coefficients</span></span>
<span><span class="co">#&gt;   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span></span>
<span><span class="co">#&gt;   matrix[n * n_lv, num_basis_trend] X_trend; // trend model design matrix</span></span>
<span><span class="co">#&gt;   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span></span>
<span><span class="co">#&gt;   array[n, n_lv] int ytimes_trend;</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span></span>
<span><span class="co">#&gt;   array[total_obs] int&lt;lower=0&gt; cap; // upper limits of latent abundances</span></span>
<span><span class="co">#&gt;   array[total_obs] int ytimes_array; // sorted ytimes</span></span>
<span><span class="co">#&gt;   array[n, n_series] int&lt;lower=0&gt; ytimes_pred; // time-ordered matrix for prediction</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; K_groups; // number of unique replicated observations</span></span>
<span><span class="co">#&gt;   int&lt;lower=0&gt; K_reps; // maximum number of replicate observations</span></span>
<span><span class="co">#&gt;   array[K_groups] int&lt;lower=0&gt; K_starts; // col of K_inds where each group starts</span></span>
<span><span class="co">#&gt;   array[K_groups] int&lt;lower=0&gt; K_stops; // col of K_inds where each group ends</span></span>
<span><span class="co">#&gt;   array[K_groups, K_reps] int&lt;lower=0&gt; K_inds; // indices of replicated observations</span></span>
<span><span class="co">#&gt;   matrix[3, 6] S_trend1; // mgcv smooth penalty matrix S_trend1</span></span>
<span><span class="co">#&gt;   matrix[3, 6] S_trend2; // mgcv smooth penalty matrix S_trend2</span></span>
<span><span class="co">#&gt;   array[total_obs] int&lt;lower=0&gt; flat_ys; // flattened observations</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed data {</span></span>
<span><span class="co">#&gt;   matrix[total_obs, num_basis] X_ordered = X[ytimes_array,  : ];</span></span>
<span><span class="co">#&gt;   array[K_groups] int&lt;lower=0&gt; Y_max;</span></span>
<span><span class="co">#&gt;   array[K_groups] int&lt;lower=0&gt; N_max;</span></span>
<span><span class="co">#&gt;   for (k in 1 : K_groups) {</span></span>
<span><span class="co">#&gt;     Y_max[k] = max(flat_ys[K_inds[k, K_starts[k] : K_stops[k]]]);</span></span>
<span><span class="co">#&gt;     N_max[k] = max(cap[K_inds[k, K_starts[k] : K_stops[k]]]);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   // raw basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis] b_raw;</span></span>
<span><span class="co">#&gt;   vector[num_basis_trend] b_raw_trend;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // smoothing parameters</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[n_sp_trend] lambda_trend;</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed parameters {</span></span>
<span><span class="co">#&gt;   // detection probability</span></span>
<span><span class="co">#&gt;   vector[total_obs] p;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent states</span></span>
<span><span class="co">#&gt;   matrix[n, n_lv] LV;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent states and loading matrix</span></span>
<span><span class="co">#&gt;   vector[n * n_lv] trend_mus;</span></span>
<span><span class="co">#&gt;   matrix[n, n_series] trend;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // basis coefficients</span></span>
<span><span class="co">#&gt;   vector[num_basis] b;</span></span>
<span><span class="co">#&gt;   vector[num_basis_trend] b_trend;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // observation model basis coefficients</span></span>
<span><span class="co">#&gt;   b[1 : num_basis] = b_raw[1 : num_basis];</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // process model basis coefficients</span></span>
<span><span class="co">#&gt;   b_trend[1 : num_basis_trend] = b_raw_trend[1 : num_basis_trend];</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // detection probability</span></span>
<span><span class="co">#&gt;   p = X_ordered * b;</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // latent process linear predictors</span></span>
<span><span class="co">#&gt;   trend_mus = X_trend * b_trend;</span></span>
<span><span class="co">#&gt;   for (j in 1 : n_lv) {</span></span>
<span><span class="co">#&gt;     LV[1 : n, j] = trend_mus[ytimes_trend[1 : n, j]];</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // derived latent states</span></span>
<span><span class="co">#&gt;   for (i in 1 : n) {</span></span>
<span><span class="co">#&gt;     for (s in 1 : n_series) {</span></span>
<span><span class="co">#&gt;       trend[i, s] = dot_product(Z[s,  : ], LV[i,  : ]);</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; model {</span></span>
<span><span class="co">#&gt;   // prior for speciessp_1...</span></span>
<span><span class="co">#&gt;   b_raw[1] ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for speciessp_2...</span></span>
<span><span class="co">#&gt;   b_raw[2] ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // dynamic process models</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for (Intercept)_trend...</span></span>
<span><span class="co">#&gt;   b_raw_trend[1] ~ normal(1, 1.5);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for speciessp_2_trend...</span></span>
<span><span class="co">#&gt;   b_raw_trend[2] ~ std_normal();</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(time):trendtrend1_trend...</span></span>
<span><span class="co">#&gt;   b_raw_trend[3 : 5] ~ multi_normal_prec(zero_trend[3 : 5],</span></span>
<span><span class="co">#&gt;                                          S_trend1[1 : 3, 1 : 3]</span></span>
<span><span class="co">#&gt;                                          * lambda_trend[1]</span></span>
<span><span class="co">#&gt;                                          + S_trend1[1 : 3, 4 : 6]</span></span>
<span><span class="co">#&gt;                                            * lambda_trend[2]);</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // prior for s(time):trendtrend2_trend...</span></span>
<span><span class="co">#&gt;   b_raw_trend[6 : 8] ~ multi_normal_prec(zero_trend[6 : 8],</span></span>
<span><span class="co">#&gt;                                          S_trend2[1 : 3, 1 : 3]</span></span>
<span><span class="co">#&gt;                                          * lambda_trend[3]</span></span>
<span><span class="co">#&gt;                                          + S_trend2[1 : 3, 4 : 6]</span></span>
<span><span class="co">#&gt;                                            * lambda_trend[4]);</span></span>
<span><span class="co">#&gt;   lambda_trend ~ normal(5, 30);</span></span>
<span><span class="co">#&gt;   {</span></span>
<span><span class="co">#&gt;     // likelihood functions</span></span>
<span><span class="co">#&gt;     array[total_obs] real flat_trends;</span></span>
<span><span class="co">#&gt;     array[total_obs] real flat_ps;</span></span>
<span><span class="co">#&gt;     flat_trends = to_array_1d(trend);</span></span>
<span><span class="co">#&gt;     flat_ps = to_array_1d(p);</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt;     // loop over replicate sampling window (each site*time*species combination)</span></span>
<span><span class="co">#&gt;     for (k in 1 : K_groups) {</span></span>
<span><span class="co">#&gt;       // all log_lambdas are identical because they represent site*time</span></span>
<span><span class="co">#&gt;       // covariates; so just use the first measurement</span></span>
<span><span class="co">#&gt;       real log_lambda = flat_trends[K_inds[k, 1]];</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;       // logit-scale detection probilities for the replicate observations</span></span>
<span><span class="co">#&gt;       vector[size(K_inds[k, K_starts[k] : K_stops[k]])] logit_p = to_vector(flat_ps[K_inds[k, K_starts[k] : K_stops[k]]]);</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;       // K values and observed counts for these replicates</span></span>
<span><span class="co">#&gt;       int K_max = N_max[k];</span></span>
<span><span class="co">#&gt;       int K_min = Y_max[k];</span></span>
<span><span class="co">#&gt;       array[size(K_inds[k, K_starts[k] : K_stops[k]])] int N_obs = flat_ys[K_inds[k, K_starts[k] : K_stops[k]]];</span></span>
<span><span class="co">#&gt;       int possible_N = K_max - K_min;</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;       // marginalize over possible latent counts analytically</span></span>
<span><span class="co">#&gt;       real ff = exp(log_lambda) * prod(1 - inv_logit(logit_p));</span></span>
<span><span class="co">#&gt;       real prob_n = 1;</span></span>
<span><span class="co">#&gt;       for (i in 1 : possible_N) {</span></span>
<span><span class="co">#&gt;         real N = K_max - i + 1;</span></span>
<span><span class="co">#&gt;         real k_obs = 1;</span></span>
<span><span class="co">#&gt;         for (j in 1 : size(N_obs)) {</span></span>
<span><span class="co">#&gt;           k_obs *= N / (N - N_obs[j]);</span></span>
<span><span class="co">#&gt;         }</span></span>
<span><span class="co">#&gt;         prob_n = 1 + prob_n * ff * k_obs / N;</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;       // add log(pr_n) to prob(K_min)</span></span>
<span><span class="co">#&gt;       target += poisson_log_lpmf(K_min | log_lambda)</span></span>
<span><span class="co">#&gt;                 + binomial_logit_lpmf(N_obs | K_min, logit_p) + log(prob_n);</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; generated quantities {</span></span>
<span><span class="co">#&gt;   vector[n_lv] penalty = rep_vector(1e12, n_lv);</span></span>
<span><span class="co">#&gt;   vector[total_obs] detprob = inv_logit(p);</span></span>
<span><span class="co">#&gt;   vector[n_sp_trend] rho_trend = log(lambda_trend);</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>The posterior summary of this model shows that it has converged
nicely</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM observation formula:</span></span>
<span><span class="co">#&gt; obs ~ species - 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process formula:</span></span>
<span><span class="co">#&gt; ~s(time, by = trend, k = 4) + species</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; nmix</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; log</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; None</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N process models:</span></span>
<span><span class="co">#&gt; 2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 6 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1500; warmup = 500; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;              2.5%   50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; speciessp_1 -0.34 0.710  1.40    1  1454</span></span>
<span><span class="co">#&gt; speciessp_2 -1.20 0.042  0.87    1  1813</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;                               2.5%     50%  97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept)_trend            2.700  3.0000  3.500    1  1348</span></span>
<span><span class="co">#&gt; speciessp_2_trend           -1.200 -0.6400  0.150    1  1491</span></span>
<span><span class="co">#&gt; s(time):trendtrend1.1_trend -0.080  0.0160  0.190    1  1195</span></span>
<span><span class="co">#&gt; s(time):trendtrend1.2_trend -0.220  0.0053  0.250    1  2612</span></span>
<span><span class="co">#&gt; s(time):trendtrend1.3_trend -0.460 -0.2500 -0.042    1  2330</span></span>
<span><span class="co">#&gt; s(time):trendtrend2.1_trend -0.210 -0.0140  0.087    1   567</span></span>
<span><span class="co">#&gt; s(time):trendtrend2.2_trend -0.200  0.0280  0.390    1  1334</span></span>
<span><span class="co">#&gt; s(time):trendtrend2.3_trend  0.056  0.3200  0.610    1  1587</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of GAM process smooths:</span></span>
<span><span class="co">#&gt;                       edf Ref.df Chi.sq p-value</span></span>
<span><span class="co">#&gt; s(time):seriestrend1 1.03      3    2.2    0.79</span></span>
<span><span class="co">#&gt; s(time):seriestrend2 1.14      3    1.1    0.86</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; ✔ No issues with effective samples per iteration</span></span>
<span><span class="co">#&gt; ✔ Rhat looks good for all parameters</span></span>
<span><span class="co">#&gt; ✔ No issues with divergences</span></span>
<span><span class="co">#&gt; ✔ No issues with maximum tree depth</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using sampling(hmc). For each parameter, n_eff is a</span></span>
<span><span class="co">#&gt;   crude measure of effective sample size, and Rhat is the potential scale</span></span>
<span><span class="co">#&gt;   reduction factor on split MCMC chains (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite() to get started describing this model</span></span></code></pre></div>
<p><code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo()</a></code> functionality works just as it does for all
<code>mvgam</code> models to aid in model comparison / selection (though
note that Pareto K values often give warnings for mixture models so
these may not be too helpful)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 4000 by 60 log-likelihood matrix.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate   SE</span></span>
<span><span class="co">#&gt; elpd_loo   -237.6 14.7</span></span>
<span><span class="co">#&gt; p_loo        91.2 13.8</span></span>
<span><span class="co">#&gt; looic       475.2 29.4</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; MCSE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.1]).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                          Count Pct.    Min. ESS</span></span>
<span><span class="co">#&gt; (-Inf, 0.7]   (good)     30    50.0%   438     </span></span>
<span><span class="co">#&gt;    (0.7, 1]   (bad)       4     6.7%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt;    (1, Inf)   (very bad) 26    43.3%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span></code></pre></div>
<p>Plot the estimated smooths of time from each species’ latent
abundance process (on the log scale)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"smooths"</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-11-1.png" width="60%" style="display: block; margin: auto;"></p>
<p><code>marginaleffects</code> support allows for more useful
prediction-based interrogations on different scales (though note that at
the time of writing this Vignette, you must have the development version
of <code>marginaleffects</code> installed for <code><a href="../reference/mvgam_families.html">nmix()</a></code> models
to be supported; use
<code>remotes::install_github('vincentarelbundock/marginaleffects')</code>
to install). Objects that use family <code><a href="../reference/mvgam_families.html">nmix()</a></code> have a few
additional prediction scales that can be used (i.e. <code>link</code>,
<code>response</code>, <code>detection</code> or <code>latent_N</code>).
For example, here are the estimated detection probabilities per species,
which show that the model has done a nice job of estimating these
parameters:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">marginaleffects</span><span class="fu">::</span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>  condition <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"detection"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Pr(detection)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-12-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>A common goal in N-mixture modelling is to estimate the true latent
abundance. The model has automatically generated predictions for the
unknown latent abundance that are conditional on the observations. We
can extract these and produce decent plots using a small function</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hindcast.mvgam.html">hindcast</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"latent_N"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to plot latent abundance estimates vs truth</span></span>
<span><span class="va">plot_latentN</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">hindcasts</span>, <span class="va">data</span>, <span class="va">species</span> <span class="op">=</span> <span class="st">"sp_1"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">all_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Grab the first replicate that represents this series</span></span>
<span>  <span class="co"># so we can get the true simulated values</span></span>
<span>  <span class="va">series</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">all_series</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">truths</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">[</span><span class="va">series</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># In case some replicates have missing observations,</span></span>
<span>  <span class="co"># pull out predictions for ALL replicates and average over them</span></span>
<span>  <span class="va">hcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">all_series</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="../reference/index-mvgam.html">names</a></span><span class="op">(</span><span class="va">hindcasts</span><span class="op">$</span><span class="va">hindcasts</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">hindcasts</span><span class="op">$</span><span class="va">hindcasts</span><span class="op">[[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate posterior empirical quantiles of predictions</span></span>
<span>  <span class="va">pred_quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">hcs</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fl">0.05</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>,</span>
<span>      <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pred_quantiles</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">pred_quantiles</span><span class="op">)</span></span>
<span>  <span class="va">pred_quantiles</span><span class="op">$</span><span class="va">truth</span> <span class="op">&lt;-</span> <span class="va">truths</span></span>
<span></span>
<span>  <span class="co"># Grab observations</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">all_series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">obs</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">observations</span></span>
<span></span>
<span>  <span class="co"># Plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred_quantiles</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">X5.</span>, ymax <span class="op">=</span> <span class="va">X95.</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#DCBCBC"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">X30.</span>, ymax <span class="op">=</span> <span class="va">X70.</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#B97C7C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">truth</span><span class="op">)</span>,</span>
<span>      colour <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">truth</span><span class="op">)</span>,</span>
<span>      shape <span class="op">=</span> <span class="fl">21</span>, colour <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>      size <span class="op">=</span> <span class="fl">2.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">observations</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span>,</span>
<span>      width <span class="op">=</span> <span class="fl">0.06</span>,</span>
<span>      shape <span class="op">=</span> <span class="fl">21</span>, fill <span class="op">=</span> <span class="st">"darkred"</span>, colour <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">2.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      y <span class="op">=</span> <span class="st">"Latent abundance (N)"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>      title <span class="op">=</span> <span class="va">species</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Latent abundance plots vs the simulated truths for each species are
shown below. Here, the red points show the imperfect observations, the
black line shows the true latent abundance, and the ribbons show
credible intervals of our estimates:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_latentN</span><span class="op">(</span><span class="va">hc</span>, <span class="va">testdat</span>, species <span class="op">=</span> <span class="st">"sp_1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-14-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_latentN</span><span class="op">(</span><span class="va">hc</span>, <span class="va">testdat</span>, species <span class="op">=</span> <span class="st">"sp_2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-14-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can see that estimates for both species have correctly captured
the true temporal variation and magnitudes in abundance</p>
</div>
</div>
<div class="section level2">
<h2 id="example-2-a-larger-survey-with-possible-nonlinear-effects">Example 2: a larger survey with possible nonlinear effects<a class="anchor" aria-label="anchor" href="#example-2-a-larger-survey-with-possible-nonlinear-effects"></a>
</h2>
<p>Now for another example with a larger dataset. We will use data from
<a href="https://doserlab.com/files/spabundance-web/articles/nmixturemodels" target="_blank" class="external-link">Jeff Doser’s simulation example from the wonderful
<code>spAbundance</code> package</a>. The simulated data include one
continuous site-level covariate, one factor site-level covariate and two
continuous sample-level covariates. This example will allow us to
examine how we can include possibly nonlinear effects in the latent
process and detection probability models.</p>
<p>Download the data and grab observations / covariate measurements for
one species</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Date link</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://github.com/doserjef/spAbundance/raw/main/data/dataNMixSim.rda"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.one.sp</span> <span class="op">&lt;-</span> <span class="va">dataNMixSim</span></span>
<span></span>
<span><span class="co"># Pull out observations for one species</span></span>
<span><span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span>, , <span class="op">]</span></span>
<span></span>
<span><span class="co"># Abundance covariates that don't change across repeat sampling observations</span></span>
<span><span class="va">abund.cov</span> <span class="op">&lt;-</span> <span class="va">dataNMixSim</span><span class="op">$</span><span class="va">abund.covs</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">abund.factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">dataNMixSim</span><span class="op">$</span><span class="va">abund.covs</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Detection covariates that can change across repeat sampling observations</span></span>
<span><span class="co"># Note that `NA`s are not allowed for covariates in mvgam, so we randomly</span></span>
<span><span class="co"># impute them here</span></span>
<span><span class="va">det.cov</span> <span class="op">&lt;-</span> <span class="va">dataNMixSim</span><span class="op">$</span><span class="va">det.covs</span><span class="op">$</span><span class="va">det.cov.1</span><span class="op">[</span>, <span class="op">]</span></span>
<span><span class="va">det.cov</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">det.cov</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">det.cov</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">det.cov2</span> <span class="op">&lt;-</span> <span class="va">dataNMixSim</span><span class="op">$</span><span class="va">det.covs</span><span class="op">$</span><span class="va">det.cov.2</span></span>
<span><span class="va">det.cov2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">det.cov2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">det.cov2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we wrangle into the appropriate ‘long’ data format, adding
indicators of <code>time</code> and <code>series</code> for working in
<code>mvgam</code>. We also add the <code>cap</code> variable to
represent the maximum latent N to marginalize over for each
observation</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="va">rbind</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      y <span class="op">=</span> <span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>,</span>
<span>      abund_cov <span class="op">=</span> <span class="va">abund.cov</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>      abund_fac <span class="op">=</span> <span class="va">abund.factor</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>,</span>
<span>      det_cov <span class="op">=</span> <span class="va">det.cov</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>,</span>
<span>      det_cov2 <span class="op">=</span> <span class="va">det.cov2</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>,</span>
<span>      replicate <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>      site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="st">"sp_1"</span>,</span>
<span>    series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">site</span>, <span class="st">"_"</span>, <span class="va">species</span>, <span class="st">"_"</span>, <span class="va">replicate</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">site</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">species</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    cap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">data.one.sp</span><span class="op">$</span><span class="va">y</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The data include observations for 225 sites with three replicates per
site, though some observations are missing</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">mod_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 675</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">mod_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 675</span></span>
<span><span class="co">#&gt; Columns: 11</span></span>
<span><span class="co">#&gt; $ y         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, 2, 2, <span style="color: #BB0000;">NA</span>, 1, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, 0, 1, 0, 0, 0, 0, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>…</span></span>
<span><span class="co">#&gt; $ abund_cov <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.3734384, -0.3734384, -0.3734384, 0.7064305, 0.7064305, 0.…</span></span>
<span><span class="co">#&gt; $ abund_fac <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> 3, 3, 3, 4, 4, 4, 9, 9, 9, 2, 2, 2, 3, 3, 3, 2, 2, 2, 1, 1, …</span></span>
<span><span class="co">#&gt; $ det_cov   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.28279990, 0.36376941, 0.01343699, 0.81359850, 0.19548086,…</span></span>
<span><span class="co">#&gt; $ det_cov2  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.03047314, 1.37976746, 0.44161953, -0.29263182, 1.04555361,…</span></span>
<span><span class="co">#&gt; $ replicate <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, …</span></span>
<span><span class="co">#&gt; $ site      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> site1, site1, site1, site2, site2, site2, site3, site3, site…</span></span>
<span><span class="co">#&gt; $ species   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, sp_1, …</span></span>
<span><span class="co">#&gt; $ series    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> site1_sp_1_1, site1_sp_1_2, site1_sp_1_3, site2_sp_1_1, site…</span></span>
<span><span class="co">#&gt; $ time      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></span>
<span><span class="co">#&gt; $ cap       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, …</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mod_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;    y  abund_cov abund_fac     det_cov   det_cov2 replicate  site species</span></span>
<span><span class="co">#&gt; 1  1 -0.3734384         3 -1.28279990  2.0304731         1 site1    sp_1</span></span>
<span><span class="co">#&gt; 2 NA -0.3734384         3  0.36376941  1.3797675         2 site1    sp_1</span></span>
<span><span class="co">#&gt; 3 NA -0.3734384         3  0.01343699  0.4416195         3 site1    sp_1</span></span>
<span><span class="co">#&gt; 4 NA  0.7064305         4  0.81359850 -0.2926318         1 site2    sp_1</span></span>
<span><span class="co">#&gt; 5  2  0.7064305         4  0.19548086  1.0455536         2 site2    sp_1</span></span>
<span><span class="co">#&gt; 6  2  0.7064305         4  0.96730338  1.9197118         3 site2    sp_1</span></span>
<span><span class="co">#&gt;         series time cap</span></span>
<span><span class="co">#&gt; 1 site1_sp_1_1    1  33</span></span>
<span><span class="co">#&gt; 2 site1_sp_1_2    1  33</span></span>
<span><span class="co">#&gt; 3 site1_sp_1_3    1  33</span></span>
<span><span class="co">#&gt; 4 site2_sp_1_1    1  33</span></span>
<span><span class="co">#&gt; 5 site2_sp_1_2    1  33</span></span>
<span><span class="co">#&gt; 6 site2_sp_1_3    1  33</span></span></code></pre></div>
<p>The final step for data preparation is of course the
<code>trend_map</code>, which sets up the mapping between observation
replicates and the latent abundance models. This is done in the same way
as in the example above</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># each unique combination of site*species is a separate process</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>trend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">trend</span>, <span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">trend_map</span></span>
<span></span>
<span><span class="va">trend_map</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">trend</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="co">#&gt;    trend         series</span></span>
<span><span class="co">#&gt; 1      1 site100_sp_1_1</span></span>
<span><span class="co">#&gt; 2      1 site100_sp_1_2</span></span>
<span><span class="co">#&gt; 3      1 site100_sp_1_3</span></span>
<span><span class="co">#&gt; 4      2 site101_sp_1_1</span></span>
<span><span class="co">#&gt; 5      2 site101_sp_1_2</span></span>
<span><span class="co">#&gt; 6      2 site101_sp_1_3</span></span>
<span><span class="co">#&gt; 7      3 site102_sp_1_1</span></span>
<span><span class="co">#&gt; 8      3 site102_sp_1_2</span></span>
<span><span class="co">#&gt; 9      3 site102_sp_1_3</span></span>
<span><span class="co">#&gt; 10     4 site103_sp_1_1</span></span>
<span><span class="co">#&gt; 11     4 site103_sp_1_2</span></span>
<span><span class="co">#&gt; 12     4 site103_sp_1_3</span></span></code></pre></div>
<p>Now we are ready to fit a model using <code><a href="../reference/mvgam.html">mvgam()</a></code>. Here we
will use penalized splines for each of the continuous covariate effects
to detect possible nonlinear associations. We also showcase how
<code>mvgam</code> can make use of the different approximation
algorithms available in <code>Stan</code> by using the meanfield
variational Bayes approximator (this reduces computation time from
around 90 seconds to around 12 seconds for this example)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="co"># effects of covariates on detection probability;</span></span>
<span>  <span class="co"># here we use penalized splines for both continuous covariates</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">det_cov</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">det_cov2</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># effects of the covariates on latent abundance;</span></span>
<span>  <span class="co"># here we use a penalized spline for the continuous covariate and</span></span>
<span>  <span class="co"># hierarchical intercepts for the factor covariate</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">abund_cov</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">abund_fac</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># link multiple observations to each site</span></span>
<span>  trend_map <span class="op">=</span> <span class="va">trend_map</span>,</span>
<span></span>
<span>  <span class="co"># nmix() family and supplied data</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">nmix</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">mod_data</span>,</span>
<span></span>
<span>  <span class="co"># standard normal priors on key regression parameters</span></span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept_trend"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">std_normal</span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sigma_raw_trend"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># use Stan's variational inference for quicker results</span></span>
<span>  algorithm <span class="op">=</span> <span class="st">"meanfield"</span>,</span>
<span></span>
<span>  <span class="co"># no need to compute "series-level" residuals</span></span>
<span>  residuals <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the model summary but don’t bother looking at estimates for
all individual spline coefficients. Notice how we no longer receive
information on convergence because we did not use MCMC sampling for this
model</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span>, include_betas <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM observation formula:</span></span>
<span><span class="co">#&gt; y ~ s(det_cov, k = 3) + s(det_cov2, k = 3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process formula:</span></span>
<span><span class="co">#&gt; ~s(abund_cov, k = 3) + s(abund_fac, bs = "re")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; nmix</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; log</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; None</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N process models:</span></span>
<span><span class="co">#&gt; 225 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 675 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 1 chains, each with iter = 1000; warmup = ; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 1000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; (Intercept) 0.11 0.45  0.77  NaN   NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of GAM observation smooths:</span></span>
<span><span class="co">#&gt;              edf Ref.df Chi.sq p-value    </span></span>
<span><span class="co">#&gt; s(det_cov)  1.01      2    172 2.4e-08 ***</span></span>
<span><span class="co">#&gt; s(det_cov2) 1.03      2    546 6.7e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;                    2.5%  50% 97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; (Intercept)_trend 0.035 0.17   0.3  NaN   NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process model group-level estimates:</span></span>
<span><span class="co">#&gt;                           2.5%   50% 97.5% Rhat n.eff</span></span>
<span><span class="co">#&gt; mean(s(abund_fac))_trend -0.53 -0.33 -0.13  NaN   NaN</span></span>
<span><span class="co">#&gt; sd(s(abund_fac))_trend    0.26  0.39  0.60  NaN   NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of GAM process smooths:</span></span>
<span><span class="co">#&gt;               edf Ref.df Chi.sq p-value  </span></span>
<span><span class="co">#&gt; s(abund_cov) 1.01      2   3.17   0.070 .</span></span>
<span><span class="co">#&gt; s(abund_fac) 8.75     10  17.59   0.036 *</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Posterior approximation used: no diagnostics to compute</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite() to get started describing this model</span></span></code></pre></div>
<p>Again we can make use of <code>marginaleffects</code> support for
interrogating the model through targeted predictions. First, we can
inspect the estimated average detection probability</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">marginaleffects</span><span class="fu">::</span><span class="fu"><a href="https://marginaleffects.com/man/r/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"detection"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;     0.591 0.522  0.655</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Type:  detection</span></span></code></pre></div>
<p>Next investigate estimated effects of covariates on latent abundance
using the <code><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects()</a></code> function and specifying
<code>type = 'link'</code>; this will return plots on the expectation
scale</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abund_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>    effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"abund_cov"</span>,</span>
<span>      <span class="st">"abund_fac"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The effect of the continuous covariate on expected latent
abundance</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abund_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected latent abundance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-24-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The effect of the factor covariate on expected latent abundance,
estimated as a hierarchical random effect</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abund_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected latent abundance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Now we can investigate estimated effects of covariates on detection
probability using <code>type = 'detection'</code></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">det_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"detection"</span>,</span>
<span>    effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"det_cov"</span>,</span>
<span>      <span class="st">"det_cov2"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The covariate smooths were estimated to be somewhat nonlinear on the
logit scale according to the model summary (based on their approximate
significances). But inspecting conditional effects of each covariate on
the probability scale is more intuitive and useful</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">det_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Pr(detection)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-27-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">det_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Pr(detection)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-27-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>More targeted predictions are also easy with
<code>marginaleffects</code> support. For example, we can ask: How does
detection probability change as we change <em>both</em> detection
covariates?</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fivenum_round</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/fivenum.html" class="external-link">fivenum</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">marginaleffects</span><span class="fu">::</span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu">marginaleffects</span><span class="fu">::</span><span class="fu"><a href="https://marginaleffects.com/man/r/datagrid.html" class="external-link">datagrid</a></span><span class="op">(</span></span>
<span>    det_cov <span class="op">=</span> <span class="va">unique</span>,</span>
<span>    det_cov2 <span class="op">=</span> <span class="va">fivenum_round</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"det_cov"</span>, <span class="st">"det_cov2"</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"detection"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Pr(detection)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nmixtures_files/figure-html/unnamed-chunk-28-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The model has found support for some important covariate effects, but
of course we’d want to interrogate how well the model predicts and think
about possible spatial effects to capture unmodelled variation in latent
abundance (which can easily be incorporated into both linear predictors
using spatial smooths).</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>The following papers and resources offer useful material about
N-mixture models for ecological population dynamics investigations:</p>
<p>Guélat, Jérôme, and Kéry, Marc. “<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12983" class="external-link">Effects
of Spatial Autocorrelation and Imperfect Detection on Species
Distribution Models.</a>” <em>Methods in Ecology and Evolution</em> 9
(2018): 1614–25.</p>
<p>Kéry, Marc, and Royle Andrew J. “<a href="https://shop.elsevier.com/books/applied-hierarchical-modeling-in-ecology-analysis-of-distribution-abundance-and-species-richness-in-r-and-bugs/kery/978-0-12-809585-0" class="external-link">Applied
hierarchical modeling in ecology: Analysis of distribution, abundance
and species richness in R and BUGS: Volume 2: Dynamic and advanced
models</a>”. London, UK: Academic Press (2020).</p>
<p>Royle, Andrew J. “<a href="https://onlinelibrary.wiley.com/doi/full/10.1111/j.0006-341X.2004.00142.x" class="external-link">N‐mixture
models for estimating population size from spatially replicated
counts.</a>” <em>Biometrics</em> 60.1 (2004): 108-115.</p>
</div>
<div class="section level2">
<h2 id="interested-in-contributing">Interested in contributing?<a class="anchor" aria-label="anchor" href="#interested-in-contributing"></a>
</h2>
<p>I’m actively seeking PhD students and other researchers to work in
the areas of ecological forecasting, multivariate model evaluation and
development of <code>mvgam</code>. Please see <a href="https://ecogambler.netlify.app/opportunities/" class="external-link">this small list of
opportunities on my website</a> and do reach out if you are interested
(n.clark’at’uq.edu.au)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
