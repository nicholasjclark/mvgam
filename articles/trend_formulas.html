<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>State-Space models in mvgam • mvgam</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="State-Space models in mvgam">
<meta property="og:description" content="mvgam">
<meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>State-Space models in mvgam</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2025-03-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/trend_formulas.Rmd" class="external-link"><code>vignettes/trend_formulas.Rmd</code></a></small>
      <div class="d-none name"><code>trend_formulas.Rmd</code></div>
    </div>

    
    
<p>The purpose of this vignette is to show how the <code>mvgam</code>
package can be used to fit and interrogate State-Space models with
nonlinear effects.</p>
<div class="section level2">
<h2 id="state-space-models">State-Space Models<a class="anchor" aria-label="anchor" href="#state-space-models"></a>
</h2>
<div class="float">
<img src="SS_model.svg" style="width:85.0%" alt="Illustration of a basic State-Space model, which assumes that a latent dynamic process (X) can evolve independently from the way we take observations (Y) of that process"><div class="figcaption">Illustration of a basic State-Space model, which
assumes that a latent dynamic <em>process</em> (X) can evolve
independently from the way we take <em>observations</em> (Y) of that
process</div>
</div>
<p><br></p>
<p>State-Space models allow us to separately make inferences about the
underlying dynamic <em>process model</em> that we are interested in
(i.e. the evolution of a time series or a collection of time series) and
the <em>observation model</em> (i.e. the way that we survey / measure
this underlying process). This is extremely useful in ecology because
our observations are always imperfect / noisy measurements of the thing
we are interested in measuring. It is also helpful because we often know
that some covariates will impact our ability to measure accurately
(i.e. we cannot take accurate counts of rodents if there is a
thunderstorm happening) while other covariates might impact the
underlying process (it is highly unlikely that rodent abundance responds
to one storm, but instead probably responds to longer-term weather and
climate variation). A State-Space model allows us to model both
components in a single unified modelling framework. A major advantage of
<code>mvgam</code> is that it can include nonlinear effects and random
effects in BOTH model components while also capturing dynamic
processes.</p>
<div class="section level3">
<h3 id="lake-washington-plankton-data">Lake Washington plankton data<a class="anchor" aria-label="anchor" href="#lake-washington-plankton-data"></a>
</h3>
<p>The data we will use to illustrate how we can fit State-Space models
in <code>mvgam</code> are from a long-term monitoring study of plankton
counts (cells per mL) taken from Lake Washington in Washington, USA. The
data are available as part of the <code>MARSS</code> package and can be
downloaded using the following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://github.com/atsa-es/MARSS/raw/master/data/lakeWAplankton.rda"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will work with five different groups of plankton:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Greens"</span>, <span class="st">"Bluegreens"</span>, <span class="st">"Diatoms"</span>, <span class="st">"Unicells"</span>, <span class="st">"Other.algae"</span><span class="op">)</span></span></code></pre></div>
<p>As usual, preparing the data into the correct format for
<code>mvgam</code> modelling takes a little bit of wrangling in
<code>dplyr</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># loop across each plankton group to create the long datframe</span></span>
<span><span class="va">plankton_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">outcomes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># create a group-specific dataframe with counts labelled 'y'</span></span>
<span>  <span class="co"># and the group name in the 'series' variable</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">"Year"</span><span class="op">]</span>,</span>
<span>    month <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">"Month"</span><span class="op">]</span>,</span>
<span>    y <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,</span>
<span>    series <span class="op">=</span> <span class="va">x</span>,</span>
<span>    temp <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">"Temp"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># change the 'series' label to a factor</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># filter to only include some years in the data</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1965</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1975</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># z-score the counts so they are approximately standard normal</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># add the time indicator</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Inspect the data structure</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;    year month       y series       temp  time</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.542</span>  Greens      -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.344</span>  Bluegreens  -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.076</span><span style="color: #BB0000; text-decoration: underline;">8</span> Diatoms     -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">1.52</span>   Unicells    -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.491</span>  Other.algae -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">1</span>965     2 <span style="color: #BB0000;">NA</span>      Greens      -<span style="color: #BB0000;">1.32</span>     2</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 600</span></span>
<span><span class="co">#&gt; Columns: 6</span></span>
<span><span class="co">#&gt; $ year   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 196…</span></span>
<span><span class="co">#&gt; $ month  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span>
<span><span class="co">#&gt; $ y      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.54241769, -0.34410776, -0.07684901, -1.52243490, -0.49055442…</span></span>
<span><span class="co">#&gt; $ series <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Greens, Bluegreens, Diatoms, Unicells, Other.algae, Greens, Blu…</span></span>
<span><span class="co">#&gt; $ temp   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.…</span></span>
<span><span class="co">#&gt; $ time   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span></code></pre></div>
<p>Note that we have z-scored the counts in this example as that will
make it easier to specify priors (though this is not completely
necessary; it is often better to build a model that respects the
properties of the actual outcome variables)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plankton_data</span>, series <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-7-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We have some missing observations, but this isn’t an issue for
modelling in <code>mvgam</code>. A useful property to understand about
these counts is that they tend to be highly seasonal. Below are some
plots of z-scored counts against the z-scored temperature measurements
in the lake for each month:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">"Other.algae"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"z-score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Temperature (black) vs Other algae (red)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-8-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">"Diatoms"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">1.1</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"z-score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Temperature (black) vs Diatoms (red)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-9-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We will have to try and capture this seasonality in our process
model, which should be easy to do given the flexibility of GAMs. Next we
will split the data into training and testing splits:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_train</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">112</span><span class="op">)</span></span>
<span><span class="va">plankton_test</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">112</span><span class="op">)</span></span></code></pre></div>
<p>Now time to fit some models. This requires a bit of thinking about
how we can best tackle the seasonal variation and the likely dependence
structure in the data. These algae are interacting as part of a complex
system within the same lake, so we certainly expect there to be some
lagged cross-dependencies underling their dynamics. But if we do not
capture the seasonal variation, our multivariate dynamic model will be
forced to try and capture it, which could lead to poor convergence and
unstable results (we could feasibly capture cyclic dynamics with a more
complex multi-species Lotka-Volterra model, but ordinary differential
equation approaches are beyond the scope of <code>mvgam</code>).</p>
</div>
<div class="section level3">
<h3 id="capturing-seasonality">Capturing seasonality<a class="anchor" aria-label="anchor" href="#capturing-seasonality"></a>
</h3>
<p>First we will fit a model that does not include a dynamic component,
just to see if it can reproduce the seasonal variation in the
observations. This model introduces hierarchical multidimensional
smooths, where all time series share a “global” tensor product of the
<code>month</code> and <code>temp</code> variables, capturing our
expectation that algal seasonality responds to temperature variation.
But this response should depend on when in the year these temperatures
are recorded (i.e. a response to warm temperatures in Spring should be
different to a response to warm temperatures in Autumn). The model also
fits series-specific deviation smooths (i.e. one tensor product per
series) to capture how each algal group’s seasonality differs from the
overall “global” seasonality. Note that we do not include
series-specific intercepts in this model because each series was
z-scored to have a mean of 0.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">notrend_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span></span>
<span>    <span class="co"># tensor of temp and month to capture</span></span>
<span>    <span class="co"># "global" seasonality</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>    <span class="co"># series-specific deviation tensor products</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="st">"None"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The “global” tensor product smooth function can be quickly
visualized:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-12-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>On this plot, red indicates below-average linear predictors and white
indicates above-average. We can then plot the deviation smooths for a
few algal groups to see how they vary from the “global” pattern:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-13-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-14-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These multidimensional smooths have done a good job of capturing the
seasonal variation in our observations:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">"forecast"</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-15-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">"forecast"</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-16-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">"forecast"</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-17-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This basic model gives us confidence that we can capture the seasonal
variation in the observations. But the model has not captured the
remaining temporal dynamics, which is obvious when we inspect Dunn-Smyth
residuals for a few series:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">"residuals"</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-18-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">"residuals"</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-19-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="multiseries-dynamics">Multiseries dynamics<a class="anchor" aria-label="anchor" href="#multiseries-dynamics"></a>
</h3>
<p>Now it is time to get into multivariate State-Space models. We will
fit two models that can both incorporate lagged cross-dependencies in
the latent process models. The first model assumes that the process
errors operate independently from one another, while the second assumes
that there may be contemporaneous correlations in the process errors.
Both models include a Vector Autoregressive component for the process
means, and so both can model complex community dynamics. The models can
be described mathematically as follows:</p>
<p><span class="math display">\[\begin{align*}
\boldsymbol{count}_t &amp; \sim \text{Normal}(\mu_{obs[t]},
\sigma_{obs}) \\
\mu_{obs[t]} &amp; = process_t \\
process_t &amp; \sim \text{MVNormal}(\mu_{process[t]}, \Sigma_{process})
\\
\mu_{process[t]} &amp; = A * process_{t-1} +
f_{global}(\boldsymbol{month},\boldsymbol{temp})_t +
f_{series}(\boldsymbol{month},\boldsymbol{temp})_t \\
f_{global}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{global} * \beta_{global} \\
f_{series}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{series} * \beta_{series} \end{align*}\]</span></p>
<p>Here you can see that there are no terms in the observation model
apart from the underlying process model. But we could easily add
covariates into the observation model if we felt that they could explain
some of the systematic observation errors. We also assume independent
observation processes (there is no covariance structure in the
observation errors <span class="math inline">\(\sigma_{obs}\)</span>).
At present, <code>mvgam</code> does not support multivariate observation
models. But this feature will be added in future versions. However the
underlying process model is multivariate, and there is a lot going on
here. This component has a Vector Autoregressive part, where the process
mean at time <span class="math inline">\(t\)</span> <span class="math inline">\((\mu_{process[t]})\)</span> is a vector that
evolves as a function of where the vector-valued process model was at
time <span class="math inline">\(t-1\)</span>. The <span class="math inline">\(A\)</span> matrix captures these dynamics with
self-dependencies on the diagonal and possibly asymmetric
cross-dependencies on the off-diagonals, while also incorporating the
nonlinear smooth functions that capture seasonality for each series. The
contemporaneous process errors are modeled by <span class="math inline">\(\Sigma_{process}\)</span>, which can be
constrained so that process errors are independent (i.e. setting the
off-diagonals to 0) or can be fully parameterized using a Cholesky
decomposition (using <code>Stan</code>’s <span class="math inline">\(LKJcorr\)</span> distribution to place a prior on
the strength of inter-species correlations). For those that are
interested in the inner-workings, <code>mvgam</code> makes use of a
recent breakthrough by <a href="https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648" class="external-link">Sarah
Heaps to enforce stationarity of Bayesian VAR processes</a>. This is
advantageous as we often don’t expect forecast variance to increase
without bound forever into the future, but many estimated VARs tend to
behave this way.</p>
<p><br> Ok that was a lot to take in. Let’s fit some models to try and
inspect what is going on and what they assume. But first, we need to
update <code>mvgam</code>’s default priors for the observation and
process errors. By default, <code>mvgam</code> uses a fairly wide
Student-T prior on these parameters to avoid being overly informative.
But our observations are z-scored and so we do not expect very large
process or observation errors. However, we also do not expect very small
observation errors either as we know these measurements are not perfect.
So let’s update the priors for these parameters. In doing so, you will
get to see how the formula for the latent process (i.e. trend) model is
used in <code>mvgam</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which has no terms in it</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">VAR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Get names of all parameters whose priors can be modified:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "(Intercept)"                                                                                                                                                                                                                                                           </span></span>
<span><span class="co">#&gt;  [2] "process error sd"                                                                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt;  [3] "diagonal autocorrelation population mean"                                                                                                                                                                                                                              </span></span>
<span><span class="co">#&gt;  [4] "off-diagonal autocorrelation population mean"                                                                                                                                                                                                                          </span></span>
<span><span class="co">#&gt;  [5] "diagonal autocorrelation population variance"                                                                                                                                                                                                                          </span></span>
<span><span class="co">#&gt;  [6] "off-diagonal autocorrelation population variance"                                                                                                                                                                                                                      </span></span>
<span><span class="co">#&gt;  [7] "shape1 for diagonal autocorrelation precision"                                                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt;  [8] "shape1 for off-diagonal autocorrelation precision"                                                                                                                                                                                                                     </span></span>
<span><span class="co">#&gt;  [9] "shape2 for diagonal autocorrelation precision"                                                                                                                                                                                                                         </span></span>
<span><span class="co">#&gt; [10] "shape2 for off-diagonal autocorrelation precision"                                                                                                                                                                                                                     </span></span>
<span><span class="co">#&gt; [11] "observation error sd"                                                                                                                                                                                                                                                  </span></span>
<span><span class="co">#&gt; [12] "te(temp,month) smooth parameters, te(temp,month):trendtrend1 smooth parameters, te(temp,month):trendtrend2 smooth parameters, te(temp,month):trendtrend3 smooth parameters, te(temp,month):trendtrend4 smooth parameters, te(temp,month):trendtrend5 smooth parameters"</span></span></code></pre></div>
<p>And their default prior distributions:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "(Intercept) ~ student_t(3, -0.1, 2.5);"</span></span>
<span><span class="co">#&gt;  [2] "sigma ~ student_t(3, 0, 2.5);"         </span></span>
<span><span class="co">#&gt;  [3] "es[1] = 0;"                            </span></span>
<span><span class="co">#&gt;  [4] "es[2] = 0;"                            </span></span>
<span><span class="co">#&gt;  [5] "fs[1] = sqrt(0.455);"                  </span></span>
<span><span class="co">#&gt;  [6] "fs[2] = sqrt(0.455);"                  </span></span>
<span><span class="co">#&gt;  [7] "gs[1] = 1.365;"                        </span></span>
<span><span class="co">#&gt;  [8] "gs[2] = 1.365;"                        </span></span>
<span><span class="co">#&gt;  [9] "hs[1] = 0.071175;"                     </span></span>
<span><span class="co">#&gt; [10] "hs[2] = 0.071175;"                     </span></span>
<span><span class="co">#&gt; [11] "sigma_obs ~ student_t(3, 0, 2.5);"     </span></span>
<span><span class="co">#&gt; [12] "lambda_trend ~ normal(5, 30);"</span></span></code></pre></div>
<p>Setting priors is easy in <code>mvgam</code> as you can use
<code>brms</code> routines. Here we use more informative Normal priors
for both error components, but we impose a lower bound of 0.2 for the
observation errors:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma_obs</span>, lb <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You may have noticed something else unique about this model: there is
no intercept term in the observation formula. This is because a shared
intercept parameter can sometimes be unidentifiable with respect to the
latent VAR process, particularly if our series have similar long-run
averages (which they do in this case because they were z-scored). We
will often get better convergence in these State-Space models if we drop
this parameter. <code>mvgam</code> accomplishes this by fixing the
coefficient for the intercept to zero. Now we can fit the first model,
which assumes that process errors are contemporaneously uncorrelated</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which is empty</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">VAR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span></span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-ss-models">Inspecting SS models<a class="anchor" aria-label="anchor" href="#inspecting-ss-models"></a>
</h3>
<p>This model’s summary is a bit different to other <code>mvgam</code>
summaries. It separates parameters based on whether they belong to the
observation model or to the latent process model. This is because we may
often have covariates that impact the observations but not the latent
process, so we can have fairly complex models for each component. You
will notice that some parameters have not fully converged, particularly
for the VAR coefficients (called <code>A</code> in the output) and for
the process errors (<code>Sigma</code>). Note that we set
<code>include_betas = FALSE</code> to stop the summary from printing
output for all of the spline coefficients, which can be dense and hard
to interpret:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">var_mod</span>, include_betas <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM observation formula:</span></span>
<span><span class="co">#&gt; y ~ 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process formula:</span></span>
<span><span class="co">#&gt; ~te(temp, month, k = c(4, 4)) + te(temp, month, k = c(4, 4), </span></span>
<span><span class="co">#&gt;     by = trend) - 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; gaussian</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; identity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; VAR()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N process models:</span></span>
<span><span class="co">#&gt; 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 5 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 120 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1500; warmup = 1000; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Observation error parameter estimates:</span></span>
<span><span class="co">#&gt;              2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; sigma_obs[1] 0.20 0.26  0.34 1.02   309</span></span>
<span><span class="co">#&gt; sigma_obs[2] 0.26 0.40  0.54 1.01   232</span></span>
<span><span class="co">#&gt; sigma_obs[3] 0.42 0.63  0.80 1.07    59</span></span>
<span><span class="co">#&gt; sigma_obs[4] 0.26 0.38  0.50 1.01   354</span></span>
<span><span class="co">#&gt; sigma_obs[5] 0.30 0.43  0.54 1.00   267</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5% 50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept)    0   0     0  NaN   NaN</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Process model VAR parameter estimates:</span></span>
<span><span class="co">#&gt;          2.5%    50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; A[1,1]  0.620  0.790 0.910 1.01   355</span></span>
<span><span class="co">#&gt; A[1,2] -0.390 -0.130 0.041 1.01   277</span></span>
<span><span class="co">#&gt; A[1,3] -0.160  0.017 0.180 1.00   600</span></span>
<span><span class="co">#&gt; A[1,4] -0.058  0.064 0.200 1.00   614</span></span>
<span><span class="co">#&gt; A[1,5] -0.038  0.110 0.350 1.01   330</span></span>
<span><span class="co">#&gt; A[2,1] -0.510 -0.200 0.025 1.00   220</span></span>
<span><span class="co">#&gt; A[2,2]  0.079  0.420 0.730 1.00   220</span></span>
<span><span class="co">#&gt; A[2,3] -0.310  0.012 0.350 1.02   161</span></span>
<span><span class="co">#&gt; A[2,4] -0.067  0.130 0.410 1.01   234</span></span>
<span><span class="co">#&gt; A[2,5] -0.034  0.220 0.630 1.01   243</span></span>
<span><span class="co">#&gt; A[3,1] -0.360 -0.036 0.170 1.01   513</span></span>
<span><span class="co">#&gt; A[3,2] -0.500 -0.029 0.350 1.00   416</span></span>
<span><span class="co">#&gt; A[3,3] -0.024  0.480 0.820 1.07    68</span></span>
<span><span class="co">#&gt; A[3,4] -0.091  0.140 0.570 1.03   177</span></span>
<span><span class="co">#&gt; A[3,5] -0.280  0.040 0.410 1.00   680</span></span>
<span><span class="co">#&gt; A[4,1] -0.420 -0.120 0.075 1.01   209</span></span>
<span><span class="co">#&gt; A[4,2] -0.650 -0.180 0.110 1.01   178</span></span>
<span><span class="co">#&gt; A[4,3] -0.270  0.069 0.470 1.02   177</span></span>
<span><span class="co">#&gt; A[4,4]  0.510  0.740 0.960 1.01   272</span></span>
<span><span class="co">#&gt; A[4,5] -0.052  0.190 0.600 1.01   254</span></span>
<span><span class="co">#&gt; A[5,1] -0.096  0.059 0.260 1.00   646</span></span>
<span><span class="co">#&gt; A[5,2] -0.450 -0.120 0.120 1.01   234</span></span>
<span><span class="co">#&gt; A[5,3] -0.200  0.055 0.310 1.01   251</span></span>
<span><span class="co">#&gt; A[5,4] -0.210 -0.036 0.140 1.00   413</span></span>
<span><span class="co">#&gt; A[5,5]  0.470  0.740 0.930 1.00   507</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Process error parameter estimates:</span></span>
<span><span class="co">#&gt;             2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; Sigma[1,1] 0.068 0.11  0.18 1.01   541</span></span>
<span><span class="co">#&gt; Sigma[1,2] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[1,3] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[1,4] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[1,5] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[2,1] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[2,2] 0.054 0.16  0.30 1.02   168</span></span>
<span><span class="co">#&gt; Sigma[2,3] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[2,4] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[2,5] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[3,1] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[3,2] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[3,3] 0.045 0.30  0.68 1.09    43</span></span>
<span><span class="co">#&gt; Sigma[3,4] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[3,5] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[4,1] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[4,2] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[4,3] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[4,4] 0.098 0.21  0.34 1.01   400</span></span>
<span><span class="co">#&gt; Sigma[4,5] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[5,1] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[5,2] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[5,3] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[5,4] 0.000 0.00  0.00  NaN   NaN</span></span>
<span><span class="co">#&gt; Sigma[5,5] 0.060 0.13  0.26 1.01   243</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of GAM process smooths:</span></span>
<span><span class="co">#&gt;                              edf Ref.df Chi.sq p-value  </span></span>
<span><span class="co">#&gt; te(temp,month)              4.98     15  33.02   0.038 *</span></span>
<span><span class="co">#&gt; te(temp,month):seriestrend1 1.16     15   7.33   0.998  </span></span>
<span><span class="co">#&gt; te(temp,month):seriestrend2 2.71     15  64.58   0.471  </span></span>
<span><span class="co">#&gt; te(temp,month):seriestrend3 1.55     15   1.50   1.000  </span></span>
<span><span class="co">#&gt; te(temp,month):seriestrend4 1.32     15   5.55   0.999  </span></span>
<span><span class="co">#&gt; te(temp,month):seriestrend5 1.62     15  12.47   0.977  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; Rhats above 1.05 found for 8 parameters</span></span>
<span><span class="co">#&gt;  *Diagnose further to investigate why the chains have not mixed</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations ended with a divergence (0%)</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations saturated the maximum tree depth of 10 (0%)</span></span>
<span><span class="co">#&gt; E-FMI indicated no pathological behavior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sun Mar 09 03:57:32 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split MCMC chains</span></span>
<span><span class="co">#&gt; (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite(var_mod) to get started describing this model</span></span></code></pre></div>
<p>The convergence of this model isn’t fabulous (more on this in a
moment). But we can again plot the smooth functions, which this time
operate on the process model. We can see the same plot using
<code>trend_effects = TRUE</code> in the plotting functions:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, <span class="st">"smooths"</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-26-1.png" width="60%" style="display: block; margin: auto;"><img src="trend_formulas_files/figure-html/unnamed-chunk-26-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>The VAR matrix is of particular interest here, as it captures lagged
dependencies and cross-dependencies in the latent process model.
Unfortunately <code>bayesplot</code> doesn’t know this is a matrix of
parameters so what we see is actually the transpose of the VAR matrix. A
little bit of wrangling gives us these histograms in the correct
order:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">A_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"A["</span>, <span class="va">i</span>, <span class="st">","</span>, <span class="va">j</span>, <span class="st">"]"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span><span class="va">var_mod</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A_pars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"hist"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-27-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>There is a lot happening in this matrix. Each cell captures the
lagged effect of the process in the column on the process in the row in
the next timestep. So for example, the effect in cell [1,3] shows how an
<em>increase</em> in the process for series 3 (Greens) at time <span class="math inline">\(t\)</span> is expected to impact the process for
series 1 (Bluegreens) at time <span class="math inline">\(t+1\)</span>.
The latent process model is now capturing these effects and the smooth
seasonal effects.</p>
<p>The process error <span class="math inline">\((\Sigma)\)</span>
captures unmodelled variation in the process models. Again, we fixed the
off-diagonals to 0, so the histograms for these will look like flat
boxes:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Sigma["</span>, <span class="va">i</span>, <span class="st">","</span>, <span class="va">j</span>, <span class="st">"]"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span><span class="va">var_mod</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"hist"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-28-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The observation error estimates <span class="math inline">\((\sigma_{obs})\)</span> represent how much the
model thinks we might miss the true count when we take our imperfect
measurements:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span><span class="va">var_mod</span>, variable <span class="op">=</span> <span class="st">"sigma_obs"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-29-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These are still a bit hard to identify overall, especially when
trying to estimate both process and observation error. Often we need to
make some strong assumptions about which of these is more important for
determining unexplained variation in our observations.</p>
</div>
<div class="section level3">
<h3 id="correlated-process-errors">Correlated process errors<a class="anchor" aria-label="anchor" href="#correlated-process-errors"></a>
</h3>
<p>Let’s see if these estimates improve when we allow the process errors
to be correlated. Once again, we need to first update the priors for the
observation errors:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma_obs</span>, lb <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And now we can fit the correlated process error model</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">varcor_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which remains empty</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span></span>
<span>  <span class="co"># VAR1 model with correlated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">VAR</a></span><span class="op">(</span>cor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span></span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <span class="math inline">\((\Sigma)\)</span> matrix now captures
any evidence of contemporaneously correlated process error:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Sigma["</span>, <span class="va">i</span>, <span class="st">","</span>, <span class="va">j</span>, <span class="st">"]"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>,</span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"hist"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-32-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This symmetric matrix tells us there is support for correlated
process errors, as several of the off-diagonal entries are strongly
non-zero. But it is easier to interpret these estimates if we convert
the covariance matrix to a correlation matrix. Here we compute the
posterior median process error correlations:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">varcor_mod</span>, variable <span class="op">=</span> <span class="st">"Sigma"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">median_correlations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Sigma_post</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">median_correlations</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">median_correlations</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">plankton_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">median_correlations</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;             Bluegreens Diatoms Greens Other.algae Unicells</span></span>
<span><span class="co">#&gt; Bluegreens        1.00   -0.20  -0.03        0.17     0.50</span></span>
<span><span class="co">#&gt; Diatoms          -0.20    1.00   0.19        0.46     0.19</span></span>
<span><span class="co">#&gt; Greens           -0.03    0.19   1.00        0.35    -0.04</span></span>
<span><span class="co">#&gt; Other.algae       0.17    0.46   0.35        1.00     0.27</span></span>
<span><span class="co">#&gt; Unicells          0.50    0.19  -0.04        0.27     1.00</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="impulse-response-functions">Impulse response functions<a class="anchor" aria-label="anchor" href="#impulse-response-functions"></a>
</h3>
<p>Because Vector Autoregressions can capture complex lagged
dependencies, it is often difficult to understand how the member time
series are thought to interact with one another. A method that is
commonly used to directly test for possible interactions is to compute
an <a href="https://en.wikipedia.org/wiki/Impulse_response" class="external-link">Impulse
Response Function</a> (IRF). If <span class="math inline">\(h\)</span>
represents the simulated forecast horizon, an IRF asks how each of the
remaining series might respond over times <span class="math inline">\((t+1):h\)</span> if a focal series is given an
innovation “shock” at time <span class="math inline">\(t = 0\)</span>.
<code>mvgam</code> can compute Generalized and Orthogonalized IRFs from
models that included latent VAR dynamics. We simply feed the fitted
model to the <code><a href="../reference/irf.mvgam.html">irf()</a></code> function and then use the S3
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function to view the estimated responses. By
default, <code><a href="../reference/irf.mvgam.html">irf()</a></code> will compute IRFs by separately imposing
positive shocks of one standard deviation to each series in the VAR
process. Here we compute Generalized IRFs over a horizon of 12
timesteps:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irf.mvgam.html">irf</a></span><span class="op">(</span><span class="va">varcor_mod</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p>A summary of the IRFs can be computed using the
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">irfs</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 300 × 5</span></span></span>
<span><span class="co">#&gt;    shock                horizon irf_median irf_Qlower irf_Qupper</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Process1 -&gt; Process1       1     0.353      0.270       0.446</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Process1 -&gt; Process1       2     0.298      0.236       0.371</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Process1 -&gt; Process1       3     0.252      0.196       0.318</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Process1 -&gt; Process1       4     0.214      0.159       0.280</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Process1 -&gt; Process1       5     0.181      0.126       0.250</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Process1 -&gt; Process1       6     0.153      0.097<span style="text-decoration: underline;">1</span>      0.227</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Process1 -&gt; Process1       7     0.130      0.073<span style="text-decoration: underline;">4</span>      0.204</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Process1 -&gt; Process1       8     0.111      0.054<span style="text-decoration: underline;">1</span>      0.184</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Process1 -&gt; Process1       9     0.095<span style="text-decoration: underline;">1</span>     0.039<span style="text-decoration: underline;">6</span>      0.169</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Process1 -&gt; Process1      10     0.080<span style="text-decoration: underline;">8</span>     0.028<span style="text-decoration: underline;">8</span>      0.155</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 290 more rows</span></span></span></code></pre></div>
<p>But it is easier to understand these responses using plots. For
example, we can plot the expected responses of the remaining series to a
positive shock for series 3 (Greens) using the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
function:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">irfs</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-36-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This series of plots makes it clear that some of the other series
would be expected to show both instantaneous responses to a shock for
the Greens (due to their correlated process errors) as well as delayed
and nonlinear responses over time (due to the complex lagged dependence
structure captured by the <span class="math inline">\(A\)</span>
matrix). This hopefully makes it clear why IRFs are an important tool in
the analysis of multivariate autoregressive models. You can also use
these IRFs to calculate a relative contribution from each shock to the
forecast error variance for a focal series. This method, known as a <a href="https://en.wikipedia.org/wiki/Variance_decomposition_of_forecast_errors" class="external-link">Forecast
Error Variance Decomposition</a> (FEVD), is useful to get an idea about
the amount of information that each series contributes to the evolution
of all other series in a Vector Autoregression:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fevds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fevd.mvgam.html">fevd</a></span><span class="op">(</span><span class="va">varcor_mod</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fevds</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-37-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The plot above shows the median contribution to forecast error
variance for each series.</p>
</div>
<div class="section level3">
<h3 id="comparing-forecast-scores">Comparing forecast scores<a class="anchor" aria-label="anchor" href="#comparing-forecast-scores"></a>
</h3>
<p>But which model is better? We can compute the variogram score for out
of sample forecasts to get a sense of which model does a better job of
capturing the dependence structure in the true evaluation set:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create forecast objects for each model</span></span>
<span><span class="va">fcvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">var_mod</span><span class="op">)</span></span>
<span><span class="va">fcvarcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the difference in variogram scores; a negative value means the VAR1cor model is better, while a positive value means the VAR1 model is better</span></span>
<span><span class="va">diff_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvarcor</span>, score <span class="op">=</span> <span class="st">"variogram"</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span> <span class="op">-</span></span>
<span>  <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvar</span>, score <span class="op">=</span> <span class="st">"variogram"</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_scores</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.25</span>, col <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  bty <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Forecast horizon"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">variogram</span><span class="op">[</span><span class="va">VAR1cor</span><span class="op">]</span> <span class="op">~</span> <span class="op">-</span><span class="op">~</span> <span class="va">variogram</span><span class="op">[</span><span class="va">VAR1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-38-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>And we can also compute the energy score for out of sample forecasts
to get a sense of which model provides forecasts that are better
calibrated:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot the difference in energy scores; a negative value means the VAR1cor model is better, while a positive value means the VAR1 model is better</span></span>
<span><span class="va">diff_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvarcor</span>, score <span class="op">=</span> <span class="st">"energy"</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span> <span class="op">-</span></span>
<span>  <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvar</span>, score <span class="op">=</span> <span class="st">"energy"</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_scores</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.25</span>, col <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  bty <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Forecast horizon"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">energy</span><span class="op">[</span><span class="va">VAR1cor</span><span class="op">]</span> <span class="op">~</span> <span class="op">-</span><span class="op">~</span> <span class="va">energy</span><span class="op">[</span><span class="va">VAR1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-39-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The models tend to provide similar forecasts, though the correlated
error model does slightly better overall. We would probably need to use
a more extensive rolling forecast evaluation exercise if we felt like we
needed to only choose one for production. <code>mvgam</code> offers some
utilities for doing this (i.e. see <code><a href="../reference/lfo_cv.mvgam.html">?lfo_cv</a></code> for guidance).
Alternatively, we could use forecasts from <em>both</em> models by
creating an evenly-weighted ensemble forecast distribution. This
capability is available using the <code><a href="../reference/ensemble.mvgam_forecast.html">ensemble()</a></code> function in
<code>mvgam</code> (see <code><a href="../reference/ensemble.mvgam_forecast.html">?ensemble</a></code> for guidance).</p>
<p>Using <code><a href="../reference/how_to_cite.mvgam.html">how_to_cite()</a></code> for models with VAR dynamics will
give you information on how they are restricted to remain
stationary:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">description</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/how_to_cite.mvgam.html">how_to_cite</a></span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">description</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Methods text skeleton</span></span>
<span><span class="co">#&gt; We used the R package mvgam (version 1.1.5001; Clark &amp; Wells, 2023) to</span></span>
<span><span class="co">#&gt;   construct, fit and interrogate the model. mvgam fits Bayesian</span></span>
<span><span class="co">#&gt;   State-Space models that can include flexible predictor effects in both</span></span>
<span><span class="co">#&gt;   the process and observation components by incorporating functionalities</span></span>
<span><span class="co">#&gt;   from the brms (Burkner 2017), mgcv (Wood 2017) and splines2 (Wang &amp; Yan,</span></span>
<span><span class="co">#&gt;   2023) packages. To encourage stability and prevent forecast variance</span></span>
<span><span class="co">#&gt;   from increasing indefinitely, we enforced stationarity of the Vector</span></span>
<span><span class="co">#&gt;   Autoregressive process following methods described by Heaps (2023) and</span></span>
<span><span class="co">#&gt;   Clark et al. (2025). The mvgam-constructed model and observed data were</span></span>
<span><span class="co">#&gt;   passed to the probabilistic programming environment Stan (version</span></span>
<span><span class="co">#&gt;   2.36.0; Carpenter et al. 2017, Stan Development Team 2025), specifically</span></span>
<span><span class="co">#&gt;   through the cmdstanr interface (Gabry &amp; Cesnovar, 2021). We ran 4</span></span>
<span><span class="co">#&gt;   Hamiltonian Monte Carlo chains for 1000 warmup iterations and 500</span></span>
<span><span class="co">#&gt;   sampling iterations for joint posterior estimation. Rank normalized</span></span>
<span><span class="co">#&gt;   split Rhat (Vehtari et al. 2021) and effective sample sizes were used to</span></span>
<span><span class="co">#&gt;   monitor convergence.</span></span></code></pre>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Primary references</span></span>
<span><span class="co">#&gt; Clark, NJ and Wells K (2023). Dynamic Generalized Additive Models</span></span>
<span><span class="co">#&gt;   (DGAMs) for forecasting discrete ecological time series. Methods in</span></span>
<span><span class="co">#&gt;   Ecology and Evolution, 14, 771-784. doi.org/10.1111/2041-210X.13974</span></span>
<span><span class="co">#&gt; Burkner, PC (2017). brms: An R Package for Bayesian Multilevel Models</span></span>
<span><span class="co">#&gt;   Using Stan. Journal of Statistical Software, 80(1), 1-28.</span></span>
<span><span class="co">#&gt;   doi:10.18637/jss.v080.i01</span></span>
<span><span class="co">#&gt; Wood, SN (2017). Generalized Additive Models: An Introduction with R</span></span>
<span><span class="co">#&gt;   (2nd edition). Chapman and Hall/CRC.</span></span>
<span><span class="co">#&gt; Wang W and Yan J (2021). Shape-Restricted Regression Splines with R</span></span>
<span><span class="co">#&gt;   Package splines2. Journal of Data Science, 19(3), 498-517.</span></span>
<span><span class="co">#&gt;   doi:10.6339/21-JDS1020 https://doi.org/10.6339/21-JDS1020.</span></span>
<span><span class="co">#&gt; Heaps, SE (2023). Enforcing stationarity through the prior in vector</span></span>
<span><span class="co">#&gt;   autoregressions. Journal of Computational and Graphical Statistics 32,</span></span>
<span><span class="co">#&gt;   74-83.</span></span>
<span><span class="co">#&gt; Clark NJ, Ernest SKM, Senyondo H, Simonis J, White EP, Yenni GM,</span></span>
<span><span class="co">#&gt;   Karunarathna KANK (2025). Beyond single-species models: leveraging</span></span>
<span><span class="co">#&gt;   multispecies forecasts to navigate the dynamics of ecological</span></span>
<span><span class="co">#&gt;   predictability. PeerJ 13:e18929.</span></span>
<span><span class="co">#&gt; Carpenter, B, Gelman, A, Hoffman, MD, Lee, D, Goodrich, B, Betancourt,</span></span>
<span><span class="co">#&gt;   M, Brubaker, M, Guo, J, Li, P and Riddell, A (2017). Stan: A</span></span>
<span><span class="co">#&gt;   probabilistic programming language. Journal of Statistical Software 76.</span></span>
<span><span class="co">#&gt; Gabry J, Cesnovar R, Johnson A, and Bronder S (2025). cmdstanr: R</span></span>
<span><span class="co">#&gt;   Interface to 'CmdStan'. https://mc-stan.org/cmdstanr/,</span></span>
<span><span class="co">#&gt;   https://discourse.mc-stan.org.</span></span>
<span><span class="co">#&gt; Vehtari A, Gelman A, Simpson D, Carpenter B, and Burkner P (2021).</span></span>
<span><span class="co">#&gt;   Rank-normalization, folding, and localization: An improved Rhat for</span></span>
<span><span class="co">#&gt;   assessing convergence of MCMC (with discussion). Bayesian Analysis 16(2)</span></span>
<span><span class="co">#&gt;   667-718. https://doi.org/10.1214/20-BA1221.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Other useful references</span></span>
<span><span class="co">#&gt; Arel-Bundock, V, Greifer, N, and Heiss, A (2024). How to interpret</span></span>
<span><span class="co">#&gt;   statistical models using marginaleffects for R and Python. Journal of</span></span>
<span><span class="co">#&gt;   Statistical Software, 111(9), 1-32.</span></span>
<span><span class="co">#&gt;   https://doi.org/10.18637/jss.v111.i09</span></span>
<span><span class="co">#&gt; Gabry J, Simpson D, Vehtari A, Betancourt M, and Gelman A (2019).</span></span>
<span><span class="co">#&gt;   Visualization in Bayesian workflow. Journal of the Royal Statatistical</span></span>
<span><span class="co">#&gt;   Society A, 182, 389-402. doi:10.1111/rssa.12378.</span></span>
<span><span class="co">#&gt; Vehtari A, Gelman A, and Gabry J (2017). Practical Bayesian model</span></span>
<span><span class="co">#&gt;   evaluation using leave-one-out cross-validation and WAIC. Statistics and</span></span>
<span><span class="co">#&gt;   Computing, 27, 1413-1432. doi:10.1007/s11222-016-9696-4.</span></span>
<span><span class="co">#&gt; Burkner, PC, Gabry, J, and Vehtari, A. (2020). Approximate</span></span>
<span><span class="co">#&gt;   leave-future-out cross-validation for Bayesian time series models.</span></span>
<span><span class="co">#&gt;   Journal of Statistical Computation and Simulation, 90(14), 2499-2523.</span></span>
<span><span class="co">#&gt;   https://doi.org/10.1080/00949655.2020.1783262</span></span></code></pre>
<p>More advanced hierarchical panel VAR models can also be handled by
using the <code>gr</code> and <code>subgr</code> arguments in
<code><a href="../reference/RW.html">VAR()</a></code>. These models are useful if you have a data for the
same set of series (<code>subgr</code>) that are measured in different
regions (<code>gr</code>), such as species measured in different
sampling regions or financial series measured in different
countries.</p>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>The following papers and resources offer a lot of useful material
about multivariate State-Space models and how they can be applied in
practice:</p>
<p>Auger‐Méthé, Marie, et al. <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecm.1470" class="external-link">“A
guide to state–space modeling of ecological time series.</a>”
<em>Ecological Monographs</em> 91.4 (2021): e01470.</p>
<p>Clark, Nicholas J., et al. <a href="https://peerj.com/articles/18929/" class="external-link">Beyond single-species models:
leveraging multispecies forecasts to navigate the dynamics of ecological
predictability</a>. <em>PeerJ</em>. (2025): 13:e18929</p>
<p>Heaps, Sarah E. “<a href="https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648" class="external-link">Enforcing
stationarity through the prior in vector autoregressions.</a>”
<em>Journal of Computational and Graphical Statistics</em> 32.1 (2023):
74-83.</p>
<p>Hannaford, Naomi E., et al. “<a href="https://doi.org/10.1016/j.csda.2022.107659" class="external-link">A sparse Bayesian
hierarchical vector autoregressive model for microbial dynamics in a
wastewater treatment plant.</a>” <em>Computational Statistics &amp; Data
Analysis</em> 179 (2023): 107659.</p>
<p>Holmes, Elizabeth E., Eric J. Ward, and Wills Kellie. “<a href="https://journal.r-project.org/archive/2012/RJ-2012-002/index.html" class="external-link">MARSS:
multivariate autoregressive state-space models for analyzing time-series
data.</a>” <em>R Journal</em>. 4.1 (2012): 11.</p>
<p>Ward, Eric J., et al. “<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2664.2009.01745.x" class="external-link">Inferring
spatial structure from time‐series data: using multivariate state‐space
models to detect metapopulation structure of California sea lions in the
Gulf of California, Mexico.</a>” <em>Journal of Applied Ecology</em>
47.1 (2010): 47-56.</p>
</div>
<div class="section level2">
<h2 id="interested-in-contributing">Interested in contributing?<a class="anchor" aria-label="anchor" href="#interested-in-contributing"></a>
</h2>
<p>I’m actively seeking PhD students and other researchers to work in
the areas of ecological forecasting, multivariate model evaluation and
development of <code>mvgam</code>. Please see <a href="https://ecogambler.netlify.app/opportunities/" class="external-link">this small list of
opportunities on my website</a> and do reach out if you are interested
(n.clark’at’uq.edu.au)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
