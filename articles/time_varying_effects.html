<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>Time-varying effects in mvgam • mvgam</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Time-varying effects in mvgam">
<meta property="og:description" content="mvgam">
<meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5003</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Time-varying effects in mvgam</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2025-03-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/time_varying_effects.Rmd" class="external-link"><code>vignettes/time_varying_effects.Rmd</code></a></small>
      <div class="d-none name"><code>time_varying_effects.Rmd</code></div>
    </div>

    
    
<p>The purpose of this vignette is to show how the <code>mvgam</code>
package can be used to estimate and forecast regression coefficients
that vary through time.</p>
<div class="section level2">
<h2 id="time-varying-effects">Time-varying effects<a class="anchor" aria-label="anchor" href="#time-varying-effects"></a>
</h2>
<p>Dynamic fixed-effect coefficients (often referred to as dynamic
linear models) can be readily incorporated into GAMs / DGAMs. In
<code>mvgam</code>, the <code><a href="../reference/dynamic.html">dynamic()</a></code> formula wrapper offers a
convenient interface to set these up. The plan is to incorporate a range
of dynamic options (such as random walk, AR1 etc…) but for the moment
only low-rank Gaussian Process (GP) smooths are allowed (making use
either of the <code>gp</code> basis in <code>mgcv</code> of of Hilbert
space approximate GPs). These are advantageous over splines or random
walk effects for several reasons. First, GPs will force the time-varying
effect to be smooth. This often makes sense in reality, where we would
not expect a regression coefficient to change rapidly from one time
point to the next. Second, GPs provide information on the ‘global’
dynamics of a time-varying effect through their length-scale parameters.
This means we can use them to provide accurate forecasts of how an
effect is expected to change in the future, something that we couldn’t
do well if we used splines to estimate the effect. An example below
illustrates.</p>
<div class="section level3">
<h3 id="simulating-time-varying-effects">Simulating time-varying effects<a class="anchor" aria-label="anchor" href="#simulating-time-varying-effects"></a>
</h3>
<p>Simulate a time-varying coefficient using a squared exponential
Gaussian Process function with length scale <span class="math inline">\(\rho\)</span>=10. We will do this using an
internal function from <code>mvgam</code> (the <code>sim_gp</code>
function):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1111</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">beta_temp</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="fu">:::</span><span class="fu">sim_gp</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  alpha_gp <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>  rho_gp <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  h <span class="op">=</span> <span class="va">N</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span></span></code></pre></div>
<p>A plot of the time-varying coefficient shows that it changes smoothly
through time:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">beta_temp</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  bty <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Coefficient"</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"darkred"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span>bty <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-3-1.png" alt="Simulating time-varying effects in mvgam and R" width="60%" style="display: block; margin: auto;"></p>
<p>Next we need to simulate the values of the covariate, which we will
call <code>temp</code> (to represent <span class="math inline">\(temperature\)</span>). In this case we just use a
standard normal distribution to simulate this covariate:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Finally, simulate the outcome variable, which is a Gaussian
observation process (with observation error) over the time-varying
effect of <span class="math inline">\(temperature\)</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">4</span> <span class="op">+</span> <span class="va">beta_temp</span> <span class="op">*</span> <span class="va">temp</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  bty <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Outcome"</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"darkred"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span>bty <span class="op">=</span> <span class="st">"l"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-5-1.png" alt="Simulating time-varying effects in mvgam and R" width="60%" style="display: block; margin: auto;"></p>
<p>Gather the data into a <code>data.frame</code> for fitting models,
and split the data into training and testing folds.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">temp</span>, <span class="va">time</span><span class="op">)</span></span>
<span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">190</span>, <span class="op">]</span></span>
<span><span class="va">data_test</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">191</span><span class="op">:</span><span class="fl">200</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-dynamic-function">The <code>dynamic()</code> function<a class="anchor" aria-label="anchor" href="#the-dynamic-function"></a>
</h3>
<p>Time-varying coefficients can be fairly easily set up using the
<code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code> or <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> wrapper functions in
<code>mvgam</code> formulae by fitting a nonlinear effect of
<code>time</code> and using the covariate of interest as the numeric
<code>by</code> variable (see <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">?mgcv::s</a></code> or
<code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">?brms::gp</a></code> for more details). The <code><a href="../reference/dynamic.html">dynamic()</a></code>
formula wrapper offers a way to automate this process, and will
eventually allow for a broader variety of time-varying effects (such as
random walk or AR processes). Depending on the arguments that are
specified to <code>dynamic</code>, it will either set up a low-rank GP
smooth function using <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code> with <code>bs = 'gp'</code> and a
fixed value of the length scale parameter <span class="math inline">\(\rho\)</span>, or it will set up a Hilbert space
approximate GP using the <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> function with
<code>c=5/4</code> so that <span class="math inline">\(\rho\)</span> is
estimated (see <code><a href="../reference/dynamic.html">?dynamic</a></code> for more details). In this first
example we will use the <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code> option, and will mis-specify
the <span class="math inline">\(\rho\)</span> parameter here as, in
practice, it is never known. This call to <code><a href="../reference/dynamic.html">dynamic()</a></code> will
set up the following smooth:
<code>s(time, by = temp, bs = "gp", m = c(-2, 8, 2), k = 40)</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">out</span> <span class="op">~</span> <span class="fu"><a href="../reference/dynamic.html">dynamic</a></span><span class="op">(</span><span class="va">temp</span>, rho <span class="op">=</span> <span class="fl">8</span>, stationary <span class="op">=</span> <span class="cn">TRUE</span>, k <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_train</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the model summary, which shows how the <code><a href="../reference/dynamic.html">dynamic()</a></code>
wrapper was used to construct a low-rank Gaussian Process smooth
function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span>, include_betas <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM formula:</span></span>
<span><span class="co">#&gt; out ~ s(time, by = temp, bs = "gp", m = c(-2, 8, 2), k = 40)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; gaussian</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; identity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; None</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 190 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1000; warmup = 500; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Observation error parameter estimates:</span></span>
<span><span class="co">#&gt;              2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; sigma_obs[1] 0.23 0.25  0.28    1  2624</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5% 50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept)    4   4   4.1    1  2881</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of GAM smooths:</span></span>
<span><span class="co">#&gt;              edf Ref.df Chi.sq p-value    </span></span>
<span><span class="co">#&gt; s(time):temp  16     40    171  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; Rhat looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; 5 of 2000 iterations ended with a divergence (0.25%)</span></span>
<span><span class="co">#&gt;  *Try running with larger adapt_delta to remove the divergences</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations saturated the maximum tree depth of 10 (0%)</span></span>
<span><span class="co">#&gt; E-FMI indicated no pathological behavior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Mar 11 05:28:38 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split MCMC chains</span></span>
<span><span class="co">#&gt; (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite(mod) to get started describing this model</span></span></code></pre></div>
<p>Because this model used a spline with a <code>gp</code> basis, it’s
smooths can be visualised just like any other <code>gam</code>. We can
plot the estimates for the in-sample and out-of-sample periods to see
how the Gaussian Process function produces sensible smooth forecasts.
Here we supply the full dataset to the <code>newdata</code> argument in
<code><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth()</a></code> to inspect posterior forecasts of the
time-varying smooth function. Overlay the true simulated function to see
that the model has adequately estimated it’s dynamics in both the
training and testing data partitions</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">mod</span>, smooth <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">190</span>, lty <span class="op">=</span> <span class="st">"dashed"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">beta_temp</span>, lwd <span class="op">=</span> <span class="fl">2.5</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">beta_temp</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-10-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can also use <code><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions()</a></code> from the
<code>marginaleffects</code> package to visualise the time-varying
coefficient for what the effect would be estimated to be at different
values of <span class="math inline">\(temperature\)</span>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/" class="external-link">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="va">range_round</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://marginaleffects.com/man/r/datagrid.html" class="external-link">datagrid</a></span><span class="op">(</span></span>
<span>    time <span class="op">=</span> <span class="va">unique</span>,</span>
<span>    temp <span class="op">=</span> <span class="va">range_round</span></span>
<span>  <span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"temp"</span>, <span class="st">"temp"</span><span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"link"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-11-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This results in sensible forecasts of the observations as well</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">data_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-12-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The syntax is very similar if we wish to estimate the parameters of
the underlying Gaussian Process, this time using a Hilbert space
approximation. We simply omit the <code>rho</code> argument in
<code><a href="../reference/dynamic.html">dynamic()</a></code> to make this happen. This will set up a call
similar to <code>gp(time, by = 'temp', c = 5/4, k = 40)</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">out</span> <span class="op">~</span> <span class="fu"><a href="../reference/dynamic.html">dynamic</a></span><span class="op">(</span><span class="va">temp</span>, k <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_train</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This model summary now contains estimates for the marginal deviation
and length scale parameters of the underlying Gaussian Process
function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span>, include_betas <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM formula:</span></span>
<span><span class="co">#&gt; out ~ gp(time, by = temp, c = 5/4, k = 40, scale = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; gaussian</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; identity</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; None</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 190 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1000; warmup = 500; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Observation error parameter estimates:</span></span>
<span><span class="co">#&gt;              2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; sigma_obs[1] 0.24 0.26  0.29    1  2778</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5% 50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept)    4   4   4.1    1  4328</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM gp term marginal deviation (alpha) and length scale (rho) estimates:</span></span>
<span><span class="co">#&gt;                      2.5%   50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; alpha_gp(time):temp 0.620 0.880 1.400 1.01   803</span></span>
<span><span class="co">#&gt; rho_gp(time):temp   0.025 0.051 0.068 1.01   656</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; Rhat looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations ended with a divergence (0%)</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations saturated the maximum tree depth of 10 (0%)</span></span>
<span><span class="co">#&gt; E-FMI indicated no pathological behavior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Mar 11 05:29:08 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split MCMC chains</span></span>
<span><span class="co">#&gt; (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite(mod) to get started describing this model</span></span></code></pre></div>
<p>Effects for <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> terms can also be plotted as
smooths:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">mod</span>, smooth <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">190</span>, lty <span class="op">=</span> <span class="st">"dashed"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">beta_temp</span>, lwd <span class="op">=</span> <span class="fl">2.5</span>, col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">beta_temp</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-16-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="salmon-survival-example">Salmon survival example<a class="anchor" aria-label="anchor" href="#salmon-survival-example"></a>
</h2>
<p>Here we will use openly available data on marine survival of Chinook
salmon to illustrate how time-varying effects can be used to improve
ecological time series models. <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1365-2419.2005.00346.x" class="external-link">Scheuerell
and Williams (2005)</a> used a dynamic linear model to examine the
relationship between marine survival of Chinook salmon and an index of
ocean upwelling strength along the west coast of the USA. The authors
hypothesized that stronger upwelling in April should create better
growing conditions for phytoplankton, which would then translate into
more zooplankton and provide better foraging opportunities for juvenile
salmon entering the ocean. The data on survival is measured as a
proportional variable over 42 years (1964–2005) and is available in the
<code>MARSS</code> package:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://github.com/atsa-es/MARSS/raw/master/data/SalmonSurvCUI.rda"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">SalmonSurvCUI</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 42</span></span>
<span><span class="co">#&gt; Columns: 3</span></span>
<span><span class="co">#&gt; $ year    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1964, 1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 19…</span></span>
<span><span class="co">#&gt; $ logit.s <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -3.46, -3.32, -3.58, -3.03, -3.61, -3.35, -3.93, -4.19, -4.82,…</span></span>
<span><span class="co">#&gt; $ CUI.apr <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 57, 5, 43, 11, 47, -21, 25, -2, -1, 43, 2, 35, 0, 1, -1, 6, -7…</span></span></code></pre></div>
<p>First we need to prepare the data for modelling. The variable
<code>CUI.apr</code> will be standardized to make it easier for the
sampler to estimate underlying GP parameters for the time-varying
effect. We also need to convert the survival back to a proportion, as in
its current form it has been logit-transformed (this is because most
time series packages cannot handle proportional data). As usual, we also
need to create a <code>time</code> indicator and a <code>series</code>
indicator for working in <code>mvgam</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SalmonSurvCUI</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># create a time variable</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># create a series variable</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="st">"salmon"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># z-score the covariate CUI.apr</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>CUI.apr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">CUI.apr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># convert logit-transformed survival back to proportional</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>survival <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">logit.s</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_data</span></span></code></pre></div>
<p>Inspect the data</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 42</span></span>
<span><span class="co">#&gt; Columns: 6</span></span>
<span><span class="co">#&gt; $ year     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1964, 1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 1…</span></span>
<span><span class="co">#&gt; $ logit.s  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -3.46, -3.32, -3.58, -3.03, -3.61, -3.35, -3.93, -4.19, -4.82…</span></span>
<span><span class="co">#&gt; $ CUI.apr  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.37949804, 0.03330223, 1.74782994, 0.30401713, 1.92830654, -…</span></span>
<span><span class="co">#&gt; $ time     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…</span></span>
<span><span class="co">#&gt; $ series   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> salmon, salmon, salmon, salmon, salmon, salmon, salmon, salmo…</span></span>
<span><span class="co">#&gt; $ survival <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.030472033, 0.034891409, 0.027119717, 0.046088827, 0.0263393…</span></span></code></pre></div>
<p>Plot features of the outcome variable, which shows that it is a
proportional variable with particular restrictions that we want to
model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">model_data</span>, y <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-20-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="section level3">
<h3 id="a-state-space-beta-regression">A State-Space Beta regression<a class="anchor" aria-label="anchor" href="#a-state-space-beta-regression"></a>
</h3>
<p><code>mvgam</code> can easily handle data that are bounded at 0 and 1
with a Beta observation model (using the <code>mgcv</code> function
<code><a href="../reference/mvgam_families.html">betar()</a></code>, see <code><a href="https://rdrr.io/pkg/mgcv/man/Beta.html" class="external-link">?mgcv::betar</a></code> for details). First
we will fit a simple State-Space model that uses an AR1 dynamic process
model with no predictors and a Beta observation model:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">survival</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="op">-</span><span class="fl">3.5</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">betar</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">model_data</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The summary of this model shows good behaviour of the Hamiltonian
Monte Carlo sampler and provides useful summaries on the Beta
observation model parameters:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod0</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM formula:</span></span>
<span><span class="co">#&gt; survival ~ 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; beta</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; logit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; AR()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 42 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1000; warmup = 500; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Observation precision parameter estimates:</span></span>
<span><span class="co">#&gt;        2.5% 50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; phi[1]   81 230   590 1.02   175</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept) -4.6 -4.3    -4 1.01   386</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent trend parameter AR estimates:</span></span>
<span><span class="co">#&gt;            2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; ar1[1]   -0.530 0.66  0.98 1.01   285</span></span>
<span><span class="co">#&gt; sigma[1]  0.026 0.43  0.70 1.03   124</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; Rhat looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; 9 of 2000 iterations ended with a divergence (0.45%)</span></span>
<span><span class="co">#&gt;  *Try running with larger adapt_delta to remove the divergences</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations saturated the maximum tree depth of 10 (0%)</span></span>
<span><span class="co">#&gt; E-FMI indicated no pathological behavior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Mar 11 05:29:36 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split MCMC chains</span></span>
<span><span class="co">#&gt; (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite(mod0) to get started describing this model</span></span></code></pre></div>
<p>A plot of the underlying dynamic component shows how it has easily
handled the temporal evolution of the time series:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod0</span>, type <span class="op">=</span> <span class="st">"trend"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-24-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="including-time-varying-upwelling-effects">Including time-varying upwelling effects<a class="anchor" aria-label="anchor" href="#including-time-varying-upwelling-effects"></a>
</h3>
<p>Now we can increase the complexity of our model by constructing and
fitting a State-Space model with a time-varying effect of the coastal
upwelling index in addition to the autoregressive dynamics. We again use
a Beta observation model to capture the restrictions of our proportional
observations, but this time will include a <code><a href="../reference/dynamic.html">dynamic()</a></code> effect
of <code>CUI.apr</code> in the latent process model. We do not specify
the <span class="math inline">\(\rho\)</span> parameter, instead opting
to estimate it using a Hilbert space approximate GP:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">survival</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/dynamic.html">dynamic</a></span><span class="op">(</span><span class="va">CUI.apr</span>, k <span class="op">=</span> <span class="fl">25</span>, scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="fu"><a href="../reference/RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  priors <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="op">-</span><span class="fl">3.5</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="../reference/mvgam_families.html">betar</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">model_data</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The summary for this model now includes estimates for the
time-varying GP parameters:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1</span>, include_betas <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; GAM observation formula:</span></span>
<span><span class="co">#&gt; survival ~ 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process formula:</span></span>
<span><span class="co">#&gt; ~dynamic(CUI.apr, k = 25, scale = FALSE) - 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family:</span></span>
<span><span class="co">#&gt; beta</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Link function:</span></span>
<span><span class="co">#&gt; logit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Trend model:</span></span>
<span><span class="co">#&gt; AR()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N process models:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N series:</span></span>
<span><span class="co">#&gt; 1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N timepoints:</span></span>
<span><span class="co">#&gt; 42 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status:</span></span>
<span><span class="co">#&gt; Fitted using Stan </span></span>
<span><span class="co">#&gt; 4 chains, each with iter = 1000; warmup = 500; thin = 1 </span></span>
<span><span class="co">#&gt; Total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Observation precision parameter estimates:</span></span>
<span><span class="co">#&gt;        2.5% 50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; phi[1]  170 350   680    1   734</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">#&gt;             2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; (Intercept) -4.5 -3.8    -3    1   698</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Process model AR parameter estimates:</span></span>
<span><span class="co">#&gt;        2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; ar1[1] 0.51 0.92     1 1.01   450</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Process error parameter estimates:</span></span>
<span><span class="co">#&gt;          2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; sigma[1] 0.18 0.34  0.55    1   694</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; GAM process model gp term marginal deviation (alpha) and length scale (rho) estimates:</span></span>
<span><span class="co">#&gt;                         2.5%  50% 97.5% Rhat n_eff</span></span>
<span><span class="co">#&gt; alpha_gp(time):CUI.apr 0.034 0.32   1.3 1.00   990</span></span>
<span><span class="co">#&gt; rho_gp(time):CUI.apr   1.400 5.90  40.0 1.01   654</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Stan MCMC diagnostics:</span></span>
<span><span class="co">#&gt; n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; Rhat looks reasonable for all parameters</span></span>
<span><span class="co">#&gt; 1 of 2000 iterations ended with a divergence (0.05%)</span></span>
<span><span class="co">#&gt;  *Try running with larger adapt_delta to remove the divergences</span></span>
<span><span class="co">#&gt; 0 of 2000 iterations saturated the maximum tree depth of 10 (0%)</span></span>
<span><span class="co">#&gt; E-FMI indicated no pathological behavior</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Mar 11 05:30:18 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split MCMC chains</span></span>
<span><span class="co">#&gt; (at convergence, Rhat = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use how_to_cite(mod1) to get started describing this model</span></span></code></pre></div>
<p>The estimates for the underlying dynamic process, and for the
hindcasts, haven’t changed much:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"trend"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-28-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"forecast"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-29-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>But the process error parameter <span class="math inline">\(\sigma\)</span> is slightly smaller for this model
than for the first model:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract estimates of the process error 'sigma' for each model</span></span>
<span><span class="va">mod0_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod0</span>, variable <span class="op">=</span> <span class="st">"sigma"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Mod0"</span><span class="op">)</span></span>
<span><span class="va">mod1_sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod1</span>, variable <span class="op">=</span> <span class="st">"sigma"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Mod1"</span><span class="op">)</span></span>
<span><span class="va">sigmas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">mod0_sigma</span>, <span class="va">mod1_sigma</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot using ggplot2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sigmas</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">`sigma[1]`</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-30-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Why does the process error not need to be as flexible in the second
model? Because the estimates of this dynamic process are now informed
partly by the time-varying effect of upwelling, which we can visualise
on the link scale using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"smooths"</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-31-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="comparing-model-predictive-performances">Comparing model predictive performances<a class="anchor" aria-label="anchor" href="#comparing-model-predictive-performances"></a>
</h3>
<p>A key question when fitting multiple time series models is whether
one of them provides better predictions than the other. There are
several options in <code>mvgam</code> for exploring this quantitatively.
First, we can compare models based on in-sample approximate
leave-one-out cross-validation as implemented in the popular
<code>loo</code> package:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="va">mod0</span>, <span class="va">mod1</span><span class="op">)</span></span>
<span><span class="co">#&gt;      elpd_diff se_diff</span></span>
<span><span class="co">#&gt; mod1  0.0       0.0   </span></span>
<span><span class="co">#&gt; mod0 -7.6       3.1</span></span></code></pre></div>
<p>The second model has the larger Expected Log Predictive Density
(ELPD), meaning that it is slightly favoured over the simpler model that
did not include the time-varying upwelling effect. However, the two
models certainly do not differ by much. But this metric only compares
in-sample performance, and we are hoping to use our models to produce
reasonable forecasts. Luckily, <code>mvgam</code> also has routines for
comparing models using approximate leave-future-out cross-validation.
Here we refit both models to a reduced training set (starting at time
point 30) and produce approximate 1-step ahead forecasts. These
forecasts are used to estimate forecast ELPD before expanding the
training set one time point at a time. We use Pareto-smoothed importance
sampling to reweight posterior predictions, acting as a kind of particle
filter so that we don’t need to refit the model too often (you can read
more about how this process works in Bürkner et al. 2020).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lfo_mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lfo_cv.mvgam.html">lfo_cv</a></span><span class="op">(</span><span class="va">mod0</span>, min_t <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">lfo_mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lfo_cv.mvgam.html">lfo_cv</a></span><span class="op">(</span><span class="va">mod1</span>, min_t <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>The model with the time-varying upwelling effect tends to provides
better 1-step ahead forecasts, with a higher total forecast ELPD</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">lfo_mod0</span><span class="op">$</span><span class="va">elpds</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 35.82746</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">lfo_mod1</span><span class="op">$</span><span class="va">elpds</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 36.90719</span></span></code></pre></div>
<p>We can also plot the ELPDs for each model as a contrast. Here, values
less than zero suggest the time-varying predictor model (Mod1) gives
better 1-step ahead forecasts:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lfo_mod0</span><span class="op">$</span><span class="va">elpds</span><span class="op">)</span> <span class="op">+</span> <span class="fl">30</span>,</span>
<span>  y <span class="op">=</span> <span class="va">lfo_mod0</span><span class="op">$</span><span class="va">elpds</span> <span class="op">-</span> <span class="va">lfo_mod1</span><span class="op">$</span><span class="va">elpds</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"ELPDmod0 - ELPDmod1"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Evaluation time point"</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>  bty <span class="op">=</span> <span class="st">"l"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_effects_files/figure-html/unnamed-chunk-36-1.png" alt="Comparing forecast skill for dynamic beta regression models in mvgam and R" width="60%" style="display: block; margin: auto;"></p>
<p>A useful exercise to further expand this model would be to think
about what kinds of predictors might impact measurement error, which
could easily be implemented into the observation formula in
<code><a href="../reference/mvgam.html">mvgam()</a></code>. But for now, we will leave the model as-is.</p>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>The following papers and resources offer a lot of useful material
about dynamic linear models and how they can be applied / evaluated in
practice:</p>
<p>Bürkner, PC, Gabry, J and Vehtari, A <a href="https://www.tandfonline.com/doi/full/10.1080/00949655.2020.1783262" class="external-link">Approximate
leave-future-out cross-validation for Bayesian time series models</a>.
<em>Journal of Statistical Computation and Simulation</em>. 90:14 (2020)
2499-2523.</p>
<p>Herrero, Asier, et al. <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2745.12527" class="external-link">From
the individual to the landscape and back: time‐varying effects of
climate and herbivory on tree sapling growth at distribution limits</a>.
<em>Journal of Ecology</em> 104.2 (2016): 430-442.</p>
<p>Holmes, Elizabeth E., Eric J. Ward, and Wills Kellie. “<a href="https://journal.r-project.org/archive/2012/RJ-2012-002/index.html" class="external-link">MARSS:
multivariate autoregressive state-space models for analyzing time-series
data.</a>” <em>R Journal</em>. 4.1 (2012): 11.</p>
<p>Scheuerell, Mark D., and John G. Williams. <a href="https://onlinelibrary.wiley.com/doi/10.1111/j.1365-2419.2005.00346.x" class="external-link">Forecasting
climate induced changes in the survival of Snake River Spring/Summer
Chinook Salmon (<em>Oncorhynchus Tshawytscha</em>)</a> <em>Fisheries
Oceanography</em> 14 (2005): 448–57.</p>
</div>
<div class="section level2">
<h2 id="interested-in-contributing">Interested in contributing?<a class="anchor" aria-label="anchor" href="#interested-in-contributing"></a>
</h2>
<p>I’m actively seeking PhD students and other researchers to work in
the areas of ecological forecasting, multivariate model evaluation and
development of <code>mvgam</code>. Please see <a href="https://ecogambler.netlify.app/opportunities/" class="external-link">this small list of
opportunities on my website</a> and do reach out if you are interested
(n.clark’at’uq.edu.au)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
