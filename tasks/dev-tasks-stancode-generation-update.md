# Stan Code Generation System - Critical Issues

- Use parallel general purpose agents to systematically analyze current_stancode* vs target_stancode* in the tasks/ directory
- After proposing fixes, currents can be regenerated by running target_generation.R
- TDD approach is crucial, no fix is verified until ALL currents have been compared to their respective targets

## IMMEDIATE PRIORITIES

1. **PRIORITY: Legacy Pipeline Removal** - Examine `assemble_mvgam_stan_code()` (line 1836) and related legacy functions to determine if they can be safely removed. This legacy pipeline is not actively used but contains deduplication logic that should be in the modern pipeline.

2. **CRITICAL: File 3 Double Curly Brace Syntax Error** - Fix double curly braces `{{` in transformed data section (lines 239-255). This is a NEW regression introduced by recent parsing changes that prevents compilation.

3. **CRITICAL: File 8 Variable Computation Order** - Fix `gp_pred_1_trend` undefined variable error on line 79. Variable is used before being defined, causing compilation failure.

4. **CRITICAL: File 8 Missing GP Trend Prior** - Add missing `target += std_normal_lpdf(zgp_1_trend);` prior in model block.

5. **HIGH: File 4 Mathematical Ordering Issue** - Move `mu_biomass = inv(mu_biomass);` to occur AFTER trend effects are added, not before. Currently mathematically incorrect.

6. **MEDIUM: File 7 Missing Prior** - Add missing `to_vector(innovations_trend) ~ std_normal();` prior statement.

## COMPILATION STATUS

- **Will Compile**: Files 1, 2, 5, 6 (4/8 files)
- **Will NOT Compile**: Files 3, 4, 7, 8 (4/8 files)
- **Critical Blockers**: 4 files have compilation-preventing issues

## RESOLVED ISSUES

- Function closing braces missing (Files 5, 8) - FIXED
- GP function deduplication working correctly - FIXED  
- PW linear_trend() function missing (File 5) - FIXED
- Functions block structure corruption - FIXED

## MINOR SYNTAX ISSUES (Non-blocking)

### File 1 (RW Basic)
- Variable ordering: lprior statements scattered instead of grouped early

### File 2 (RW Shared)  
- Unused variable: `matrix[N_lv_trend, N_lv_trend] Sigma_trend` declared but never used

## SYSTEM STATUS

The deduplication system is now working correctly. Function parsing properly preserves closing braces and handles multi-line signatures. Main remaining issues are variable computation order problems and missing priors that prevent Stan compilation.

## NEXT ACTIONS

1. Investigate legacy pipeline removal potential
2. Fix File 3 double curly brace syntax error (immediate compilation blocker)
3. Address File 8 variable ordering and missing priors
4. Resolve File 4 mathematical ordering issue
