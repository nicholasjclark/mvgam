<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function estimates the posterior distribution for Generalised Additive
Models (GAMs) that can include smooth spline functions, specified in the GAM
formula, as well as latent temporal processes, specified by trend_model.
Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing
observation-level effects. Prior specifications are flexible and explicitly
encourage users to apply prior distributions that actually reflect their beliefs.
In addition, model fits can easily be assessed and compared with posterior
predictive checks, forecast comparisons and leave-one-out / leave-future-out
cross-validation."><title>Fit a Bayesian Dynamic GAM to Univariate or Multivariate Time Series — mvgam • mvgam</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Fit a Bayesian Dynamic GAM to Univariate or Multivariate Time Series — mvgam"><meta property="og:description" content="This function estimates the posterior distribution for Generalised Additive
Models (GAMs) that can include smooth spline functions, specified in the GAM
formula, as well as latent temporal processes, specified by trend_model.
Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing
observation-level effects. Prior specifications are flexible and explicitly
encourage users to apply prior distributions that actually reflect their beliefs.
In addition, model fits can easily be assessed and compared with posterior
predictive checks, forecast comparisons and leave-one-out / leave-future-out
cross-validation."><meta property="og:image" content="https://nicholasjclark.github.io/mvgam/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.594</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/forecast_evaluation.html">Forecasting and forecast evaluation in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/nmixtures.html">N-mixtures in mvgam</a>
    <a class="dropdown-item" href="../articles/shared_states.html">Shared latent states in mvgam</a>
    <a class="dropdown-item" href="../articles/time_varying_effects.html">Time-varying effects in mvgam</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in mvgam</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit a Bayesian Dynamic GAM to Univariate or Multivariate Time Series</h1>
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/R/mvgam.R" class="external-link"><code>R/mvgam.R</code></a></small>
      <div class="d-none name"><code>mvgam.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function estimates the posterior distribution for Generalised Additive
Models (GAMs) that can include smooth spline functions, specified in the GAM
formula, as well as latent temporal processes, specified by <code>trend_model</code>.</p>
<p>Further modelling options include State-Space representations to allow covariates
and dynamic processes to occur on the latent 'State' level while also capturing
observation-level effects. Prior specifications are flexible and explicitly
encourage users to apply prior distributions that actually reflect their beliefs.</p>
<p>In addition, model fits can easily be assessed and compared with posterior
predictive checks, forecast comparisons and leave-one-out / leave-future-out
cross-validation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mvgam</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  <span class="va">trend_formula</span>,</span>
<span>  <span class="va">knots</span>,</span>
<span>  <span class="va">trend_knots</span>,</span>
<span>  trend_model <span class="op">=</span> <span class="st">"None"</span>,</span>
<span>  noncentred <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  share_obs_params <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">newdata</span>,</span>
<span>  use_lv <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">n_lv</span>,</span>
<span>  <span class="va">trend_map</span>,</span>
<span>  <span class="va">priors</span>,</span>
<span>  run_model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prior_simulation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  residuals <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_model_data <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.backend"</span>, <span class="st">"cmdstanr"</span><span class="op">)</span>,</span>
<span>  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"brms.algorithm"</span>, <span class="st">"sampling"</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max_treedepth <span class="op">=</span> <span class="fl">10</span>, adapt_delta <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  samples <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  save_all_pars <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  autoformat <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  lfo <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>A <code>formula</code> object specifying the GAM observation model formula.
These are exactly like the formula for a GLM except that smooth terms, <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s()</a></code>,
<code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/t2.html" class="external-link">t2()</a></code>, as well as time-varying <code><a href="dynamic.html">dynamic()</a></code> terms,
nonparametric <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp()</a></code> terms and offsets using <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code>, can be added to the
right hand side to specify that the linear predictor depends on smooth
functions of predictors (or linear functionals of these).</p>
<p>In <code><a href="mvgam_families.html">nmix()</a></code> family models, the <code>formula</code> is used to set up a linear predictor
for the detection probability. Details of the formula syntax used by
<span class="pkg">mvgam</span> can be found in <code><a href="mvgam_formulae.html">mvgam_formulae</a></code></p></dd>


<dt>trend_formula</dt>
<dd><p>An optional <code>formula</code> object specifying the GAM process
model formula. If supplied, a linear predictor will be modelled for the
latent trends to capture process model evolution separately from the
observation model.</p>
<p><strong>Important notes:</strong></p><ul><li><p>Should not have a response variable specified on the left-hand side
(e.g., <code>~ season + s(year)</code>)</p></li>
<li><p>Use <code>trend</code> instead of <code>series</code> for effects that vary across time series</p></li>
<li><p>Only available for <code><a href="RW.html">RW()</a></code>, <code><a href="RW.html">AR()</a></code> and <code><a href="RW.html">VAR()</a></code> trend models</p></li>
<li><p>In <code><a href="mvgam_families.html">nmix()</a></code> family models, sets up linear predictor for latent abundance</p></li>
<li><p>Consider dropping one intercept using <code>- 1</code> convention to avoid
estimation challenges</p></li>
</ul></dd>


<dt>knots</dt>
<dd><p>An optional <code>list</code> containing user specified knot values for
basis construction. For most bases the user simply supplies the knots to be
used, which must match up with the <code>k</code> value supplied. Different terms can
use different numbers of knots, unless they share a covariate.</p></dd>


<dt>trend_knots</dt>
<dd><p>As for <code>knots</code> above, this is an optional <code>list</code> of knot
values for smooth functions within the <code>trend_formula</code>.</p></dd>


<dt>trend_model</dt>
<dd><p><code>character</code> or <code>function</code> specifying the time series dynamics
for the latent trend.</p>
<p><strong>Available options:</strong></p><ul><li><p><code>None</code>: No latent trend component (GAM component only, like <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></code>)</p></li>
<li><p><code>ZMVN</code> or <code><a href="ZMVN.html">ZMVN()</a></code>: Zero-Mean Multivariate Normal (Stan only)</p></li>
<li><p><code>'RW'</code> or <code><a href="RW.html">RW()</a></code>: Random Walk</p></li>
<li><p><code>'AR1'</code>, <code>'AR2'</code>, <code>'AR3'</code> or <code>AR(p = 1, 2, 3)</code>: Autoregressive models</p></li>
<li><p><code>'CAR1'</code> or <code>CAR(p = 1)</code>: Continuous-time AR (Ornstein–Uhlenbeck process)</p></li>
<li><p><code>'VAR1'</code> or <code><a href="RW.html">VAR()</a></code>: Vector Autoregressive (Stan only)</p></li>
<li><p><code>'PWlogistic'</code>, <code>'PWlinear'</code> or <code><a href="piecewise_trends.html">PW()</a></code>: Piecewise trends (Stan only)</p></li>
<li><p><code>'GP'</code> or <code><a href="GP.html">GP()</a></code>: Gaussian Process with squared exponential kernel (Stan only)</p></li>
</ul><p><strong>Additional features:</strong></p><ul><li><p>Moving average and/or correlated process error terms available for most types
(e.g., <code>RW(cor = TRUE)</code> for multivariate Random Walk)</p></li>
<li><p>Hierarchical correlations possible for structured data</p></li>
<li><p>See <a href="mvgam_trends.html">mvgam_trends</a> for details and <code><a href="ZMVN.html">ZMVN()</a></code> for examples</p></li>
</ul></dd>


<dt>noncentred</dt>
<dd><p><code>logical</code>. Use non-centred parameterisation for autoregressive
trend models? Can improve efficiency by avoiding degeneracies in latent dynamic
random effects estimation. Benefits vary by model - highly informative data
may perform worse with this option. Available for <code><a href="RW.html">RW()</a></code>, <code><a href="RW.html">AR()</a></code>, <code><a href="RW.html">CAR()</a></code>,
or <code>trend = 'None'</code> with <code>trend_formula</code>. Not available for moving average
or correlated error models.</p></dd>


<dt>family</dt>
<dd><p><code>family</code> specifying the exponential observation family for the series.</p>
<p><strong>Supported families:</strong></p><ul><li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code>: Real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">betar()</a></code>: Proportional data on <code>(0,1)</code></p></li>
<li><p><code><a href="mvgam_families.html">lognormal()</a></code>: Non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">student_t()</a></code>: Real-valued data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma()</a></code>: Non-negative real-valued data</p></li>
<li><p><code><a href="mvgam_families.html">bernoulli()</a></code>: Binary data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson()</a></code>: Count data (default)</p></li>
<li><p><code><a href="mvgam_families.html">nb()</a></code>: Overdispersed count data</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code>: Count data with imperfect detection when number of trials is known
(use <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind()</a></code> to bind observations and trials)</p></li>
<li><p><code><a href="mvgam_families.html">beta_binomial()</a></code>: As <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial()</a></code> but allows for overdispersion</p></li>
<li><p><code><a href="mvgam_families.html">nmix()</a></code>: Count data with imperfect detection when number of trials is unknown
(State-Space N-Mixture model with Poisson latent states and Binomial observations)</p></li>
</ul><p>See <code><a href="mvgam_families.html">mvgam_families</a></code> for more details.</p></dd>


<dt>share_obs_params</dt>
<dd><p><code>logical</code>. If <code>TRUE</code> and the <code>family</code> has additional
family-specific observation parameters (e.g., variance components, dispersion
parameters), these will be shared across all outcome variables. Useful when
multiple outcomes share properties. Default is <code>FALSE</code>.</p></dd>


<dt>data</dt>
<dd><p>A <code>dataframe</code> or <code>list</code> containing the model response variable
and covariates required by the GAM <code>formula</code> and optional <code>trend_formula</code>.</p>
<p><strong>Required columns for most models:</strong></p><ul><li><p><code>series</code>: A <code>factor</code> index of the series IDs (number of levels should equal
number of unique series labels)</p></li>
<li><p><code>time</code>: <code>numeric</code> or <code>integer</code> index of time points. For most dynamic trend
types, time should be measured in discrete, regularly spaced intervals
(i.e., <code>c(1, 2, 3, ...)</code>). Irregular spacing is allowed for <code>trend_model = CAR(1)</code>,
but zero intervals are adjusted to <code>1e-12</code> to prevent sampling errors.</p></li>
</ul><p><strong>Special cases:</strong></p><ul><li><p>Models with hierarchical temporal correlation (e.g., <code>AR(gr = region, subgr = species)</code>)
should NOT include a <code>series</code> identifier</p></li>
<li><p>Models without temporal dynamics (<code>trend_model = 'None'</code> or <code>trend_model = ZMVN()</code>)
don't require a <code>time</code> variable</p></li>
</ul></dd>


<dt>newdata</dt>
<dd><p>Optional <code>dataframe</code> or <code>list</code> of test data containing the same
variables as in <code>data</code>. If included, observations in variable <code>y</code> will be
set to <code>NA</code> when fitting the model so that posterior simulations can be obtained.</p></dd>


<dt>use_lv</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, use dynamic factors to estimate series'
latent trends in a reduced dimension format. Only available for <code><a href="RW.html">RW()</a></code>,
<code><a href="RW.html">AR()</a></code> and <code><a href="GP.html">GP()</a></code> trend models. Default is <code>FALSE</code>.
See <code><a href="lv_correlations.html">lv_correlations</a></code> for examples.</p></dd>


<dt>n_lv</dt>
<dd><p><code>integer</code> specifying the number of latent dynamic factors to use
if <code>use_lv == TRUE</code>. Cannot exceed <code>n_series</code>. Default is
<code>min(2, floor(n_series / 2))</code>.</p></dd>


<dt>trend_map</dt>
<dd><p>Optional <code>data.frame</code> specifying which series should depend on
which latent trends. Enables multiple series to depend on the same latent
trend process with different observation processes.</p>
<p><strong>Required structure:</strong></p><ul><li><p>Column <code>series</code>: Single unique entry for each series (matching factor levels in data)</p></li>
<li><p>Column <code>trend</code>: Integer values indicating which trend each series depends on</p></li>
</ul><p><strong>Notes:</strong></p><ul><li><p>Sets up latent factor model by enabling <code>use_lv = TRUE</code></p></li>
<li><p>Process model intercept is NOT automatically suppressed</p></li>
<li><p>Not yet supported for continuous time models (<code><a href="RW.html">CAR()</a></code>)</p></li>
</ul></dd>


<dt>priors</dt>
<dd><p>An optional <code>data.frame</code> with prior definitions or, preferably,
a vector of <code>brmsprior</code> objects (see <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a>()</code>).
See <code><a href="get_mvgam_priors.html">get_mvgam_priors()</a></code> and Details for more information.</p></dd>


<dt>run_model</dt>
<dd><p><code>logical</code>. If <code>FALSE</code>, the model is not fitted but instead
the function returns the model file and the data/initial values needed to
fit the model outside of <code>mvgam</code>.</p></dd>


<dt>prior_simulation</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, no observations are fed to the
model, and instead simulations from prior distributions are returned.</p></dd>


<dt>residuals</dt>
<dd><p><code>logical</code>. Whether to compute series-level randomized quantile
residuals. Default is <code>TRUE</code>. Set to <code>FALSE</code> to save time and reduce object
size (can add later using <a href="add_residuals.mvgam.html">add_residuals</a>).</p></dd>


<dt>return_model_data</dt>
<dd><p><code>logical</code>. If <code>TRUE</code>, the list of data needed to fit
the model is returned, along with initial values for smooth and AR parameters,
once the model is fitted. Helpful for users who wish to modify the model file
to add other stochastic elements. Default is <code>FALSE</code> unless <code>run_model == FALSE</code>.</p></dd>


<dt>backend</dt>
<dd><p>Character string naming the package for Stan model fitting.
Options are <code>"cmdstanr"</code> (default) or <code>"rstan"</code>. Can be set globally via
<code>"brms.backend"</code> option. See https://mc-stan.org/rstan/ and
https://mc-stan.org/cmdstanr/ for details.</p></dd>


<dt>algorithm</dt>
<dd><p>Character string naming the estimation approach:</p><ul><li><p><code>"sampling"</code>: MCMC (default)</p></li>
<li><p><code>"meanfield"</code>: Variational inference with factorized normal distributions</p></li>
<li><p><code>"fullrank"</code>: Variational inference with multivariate normal distribution</p></li>
<li><p><code>"laplace"</code>: Laplace approximation (cmdstanr only)</p></li>
<li><p><code>"pathfinder"</code>: Pathfinder algorithm (cmdstanr only)</p></li>
</ul><p>Can be set globally via <code>"brms.algorithm"</code> option. Limited testing suggests
<code>"meanfield"</code> performs best among non-MCMC approximations for dynamic GAMs.</p></dd>


<dt>control</dt>
<dd><p>Named <code>list</code> for controlling sampler behaviour. Valid elements
include <code>max_treedepth</code>, <code>adapt_delta</code> and <code>init</code>.</p></dd>


<dt>chains</dt>
<dd><p><code>integer</code> specifying the number of parallel chains for the model.
Ignored for variational inference algorithms.</p></dd>


<dt>burnin</dt>
<dd><p><code>integer</code> specifying the number of warmup iterations to tune
sampling algorithms. Ignored for variational inference algorithms.</p></dd>


<dt>samples</dt>
<dd><p><code>integer</code> specifying the number of post-warmup iterations for
sampling the posterior distribution.</p></dd>


<dt>thin</dt>
<dd><p>Thinning interval for monitors. Ignored for variational inference
algorithms.</p></dd>


<dt>parallel</dt>
<dd><p><code>logical</code> specifying whether to use multiple cores for parallel
MCMC simulation. If <code>TRUE</code>, uses <code>min(c(chains, parallel::detectCores() - 1))</code> cores.</p></dd>


<dt>threads</dt>
<dd><p><code>integer</code>. Experimental option for within-chain parallelisation
in Stan using <code>reduce_sum</code>. Recommended only for experienced Stan users with
slow models. Currently works for all families except <code><a href="mvgam_families.html">nmix()</a></code> and when using
Cmdstan backend.</p></dd>


<dt>save_all_pars</dt>
<dd><p><code>logical</code>. Save draws from all variables defined in Stan's
<code>parameters</code> block. Default is <code>FALSE</code>.</p></dd>


<dt>silent</dt>
<dd><p>Verbosity level between <code>0</code> and <code>2</code>. If <code>1</code> (default), most
informational messages are suppressed. If <code>2</code>, even more messages are
suppressed. Sampling progress is still printed - set <code>refresh = 0</code> to
disable. For <code>backend = "rstan"</code>, also set <code>open_progress = FALSE</code> to
prevent additional progress bars.</p></dd>


<dt>autoformat</dt>
<dd><p><code>logical</code>. Use <code>stanc</code> parser to automatically format Stan
code and check for deprecations. For development purposes - leave as <code>TRUE</code>.</p></dd>


<dt>refit</dt>
<dd><p><code>logical</code>. Indicates whether this is a refit called using
<code><a href="update.mvgam.html">update.mvgam()</a></code>. Users should leave as <code>FALSE</code>.</p></dd>


<dt>lfo</dt>
<dd><p><code>logical</code>. Indicates whether this is part of <a href="lfo_cv.mvgam.html">lfo_cv.mvgam</a> call.
Returns lighter model version for speed. Users should leave as <code>FALSE</code>.</p></dd>


<dt>...</dt>
<dd><p>Further arguments passed to Stan:</p><ul><li><p>For <code>backend = "rstan"</code>: passed to <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a>()</code> or
<code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-vb.html" class="external-link">vb</a>()</code></p></li>
<li><p>For <code>backend = "cmdstanr"</code>: passed to <code><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">cmdstanr::sample</a></code>,
<code><a href="https://mc-stan.org/cmdstanr/reference/model-method-variational.html" class="external-link">cmdstanr::variational</a></code>, <code><a href="https://mc-stan.org/cmdstanr/reference/model-method-laplace.html" class="external-link">cmdstanr::laplace</a></code> or <code><a href="https://mc-stan.org/cmdstanr/reference/model-method-pathfinder.html" class="external-link">cmdstanr::pathfinder</a></code> methods</p></li>
</ul></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A <code>list</code> object of class <code>mvgam</code> containing model output, the text
representation of the model file, the mgcv model output (for easily generating
simulations at unsampled covariate values), Dunn-Smyth residuals for each
series and key information needed for other functions in the package. See
<code><a href="mvgam-class.html">mvgam-class</a></code> for details. Use <code>methods(class = "mvgam")</code> for an
overview on available methods.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Dynamic GAMs are useful when we wish to predict future values from time series
that show temporal dependence but we do not want to rely on extrapolating from
a smooth term (which can sometimes lead to unpredictable and unrealistic behaviours).
In addition, smooths can often try to wiggle excessively to capture any
autocorrelation that is present in a time series, which exacerbates the problem
of forecasting ahead.</p>
<p>As GAMs are very naturally viewed through a Bayesian lens, and we often must
model time series that show complex distributional features and missing data,
parameters for <span class="pkg">mvgam</span> models are estimated in a Bayesian framework using
Markov Chain Monte Carlo by default.</p>
<p><strong>Getting Started Resources:</strong></p><ul><li><p>General overview: <code><a href="../articles/mvgam_overview.html">vignette("mvgam_overview")</a></code> and <code><a href="../articles/data_in_mvgam.html">vignette("data_in_mvgam")</a></code></p></li>
<li><p>Full list of vignettes: <code>vignette(package = "mvgam")</code></p></li>
<li><p>Real-world examples: <code><a href="mvgam_use_cases.html">mvgam_use_cases</a></code></p></li>
<li><p>Quick reference: <a href="https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.pdf" class="external-link">mvgam cheatsheet</a></p></li>
</ul></div>
    <div class="section level2">
    <h2 id="model-specification-details">Model Specification Details<a class="anchor" aria-label="anchor" href="#model-specification-details"></a></h2>
    


<p><strong>Formula Syntax:</strong> Details of the formula syntax used by <span class="pkg">mvgam</span> can be
found in <code><a href="mvgam_formulae.html">mvgam_formulae</a></code>. Note that it is possible to supply an
empty formula where there are no predictors or intercepts in the observation
model (i.e. <code>y ~ 0</code> or <code>y ~ -1</code>). In this case, an intercept-only observation
model will be set up but the intercept coefficient will be fixed at zero. This
can be handy if you wish to fit pure State-Space models where the variation in
the dynamic trend controls the average expectation, and/or where intercepts are
non-identifiable (as in piecewise trends).</p>
<p><strong>Families and Link Functions:</strong> Details of families supported by <span class="pkg">mvgam</span>
can be found in <code><a href="mvgam_families.html">mvgam_families</a></code>.</p>
<p><strong>Trend Models:</strong> Details of latent error process models supported by <span class="pkg">mvgam</span>
can be found in <code><a href="mvgam_trends.html">mvgam_trends</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="prior-specifications">Prior Specifications<a class="anchor" aria-label="anchor" href="#prior-specifications"></a></h2>
    

<p>Default priors for intercepts and any variance parameters are chosen to be
vaguely informative, but these should always be checked by the user. Prior
distributions for most important model parameters can be altered (see
<code><a href="get_mvgam_priors.html">get_mvgam_priors()</a></code> for details). Note that latent trends are estimated on
the link scale so choose priors accordingly.</p>
<p>However more control over the model specification can be accomplished by setting
<code>run_model = FALSE</code> and then editing the model code (found in the
<code>model_file</code> slot in the returned object) before running the model using either
<span class="pkg">rstan</span> or <span class="pkg">cmdstanr</span>. This is encouraged for complex modelling tasks.</p>
<p><strong>Important:</strong> No priors are formally checked to ensure they are in the right
syntax so it is up to the user to ensure these are correct.</p>
    </div>
    <div class="section level2">
    <h2 id="model-components">Model Components<a class="anchor" aria-label="anchor" href="#model-components"></a></h2>
    


<p><strong>Random Effects:</strong> For any smooth terms using the random effect basis
(<code><a href="https://rdrr.io/pkg/mgcv/man/smooth.construct.re.smooth.spec.html" class="external-link">smooth.construct.re.smooth.spec</a></code>), a non-centred
parameterisation is automatically employed to avoid degeneracies that are common
in hierarchical models. Note however that centred versions may perform better
for series that are particularly informative, so as with any foray into Bayesian
modelling, it is worth building an understanding of the model's assumptions and
limitations by following a principled workflow. Also note that models are
parameterised using <code>drop.unused.levels = FALSE</code> in <code><a href="https://rdrr.io/pkg/mgcv/man/jagam.html" class="external-link">jagam</a></code>
to ensure predictions can be made for all levels of the supplied factor variable.</p>
<p><strong>Observation Level Parameters:</strong> When more than one series is included in
<code>data</code> and an observation family that contains more than one parameter is
used, additional observation family parameters (i.e. <code>phi</code> for <code><a href="mvgam_families.html">nb()</a></code> or <code>sigma</code>
for <code><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian()</a></code>) are by default estimated independently for each series. But if
you wish for the series to share the same observation parameters, set
<code>share_obs_params = TRUE</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="model-diagnostics">Model Diagnostics<a class="anchor" aria-label="anchor" href="#model-diagnostics"></a></h2>
    


<p><strong>Residuals:</strong> For each series, randomized quantile (i.e. Dunn-Smyth) residuals
are calculated for inspecting model diagnostics. If the fitted model is
appropriate then Dunn-Smyth residuals will be standard normal in distribution
and no autocorrelation will be evident. When a particular observation is missing,
the residual is calculated by comparing independent draws from the model's
posterior distribution.</p>
    </div>
    <div class="section level2">
    <h2 id="computational-backend">Computational Backend<a class="anchor" aria-label="anchor" href="#computational-backend"></a></h2>
    


<p><strong>Using Stan:</strong> <span class="pkg">mvgam</span> is primarily designed to use Hamiltonian Monte Carlo
for parameter estimation via the software <code>Stan</code> (using either the <code>cmdstanr</code>
or <code>rstan</code> interface). There are great advantages when using <code>Stan</code> over Gibbs /
Metropolis Hastings samplers, which includes the option to estimate nonlinear
effects via <a href="https://arxiv.org/abs/2004.11408" class="external-link">Hilbert space approximate Gaussian Processes</a>,
the availability of a variety of inference algorithms (i.e. variational inference,
laplacian inference etc...) and <a href="https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648" class="external-link">capabilities to enforce stationarity for complex Vector Autoregressions</a>.</p>
<p>Because of the many advantages of <code>Stan</code> over <code>JAGS</code>, <strong>further development of
the package will only be applied to <code>Stan</code></strong>. This includes the planned addition
of more response distributions, plans to handle zero-inflation, and plans to
incorporate a greater variety of trend models. Users are strongly encouraged to
opt for <code>Stan</code> over <code>JAGS</code> in any proceeding workflows.</p>
    </div>
    <div class="section level2">
    <h2 id="recommended-workflow">Recommended Workflow<a class="anchor" aria-label="anchor" href="#recommended-workflow"></a></h2>
    


<p><strong>How to Start:</strong> The <a href="https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.pdf" class="external-link"><code>mvgam</code> cheatsheet</a>
is a good starting place if you are just learning to use the package. It gives
an overview of the package's key functions and objects, as well as providing a
reasonable workflow that new users can follow.</p>
<p><strong>Recommended Steps:</strong></p><ol><li><p><strong>Data Preparation:</strong> Check that your data are in a suitable tidy format for
<span class="pkg">mvgam</span> modeling (see the <a href="https://nicholasjclark.github.io/mvgam/articles/data_in_mvgam.html">data formatting vignette</a>
for guidance)</p></li>
<li><p><strong>Data Exploration:</strong> Inspect features of the data using <code><a href="plot_mvgam_series.html">plot_mvgam_series</a></code>.
Now is also a good time to familiarise yourself with the package's example
workflows that are detailed in the vignettes:</p><ul><li><p><a href="https://nicholasjclark.github.io/mvgam/articles/mvgam_overview.html">Getting started vignette</a></p></li>
<li><p><a href="https://nicholasjclark.github.io/mvgam/articles/shared_states.html">Shared latent states vignette</a></p></li>
<li><p><a href="https://nicholasjclark.github.io/mvgam/articles/time_varying_effects.html">Time-varying effects vignette</a></p></li>
<li><p><a href="https://nicholasjclark.github.io/mvgam/articles/trend_formulas.html">State-Space models vignette</a></p></li>
<li><p><a href="https://nicholasjclark.github.io/mvgam/articles/nmixtures.html">"Fitting N-mixture models in <code>mvgam</code>"</a></p></li>
<li><p><a href="https://nicholasjclark.github.io/mvgam/reference/jsdgam.html">"Joint Species Distribution Models in <code>mvgam</code>"</a></p></li>
<li><p><a href="https://ecogambler.netlify.app/blog/time-varying-seasonality/" class="external-link">"Incorporating time-varying seasonality in forecast models"</a></p></li>
<li><p><a href="https://ecogambler.netlify.app/blog/autocorrelated-gams/" class="external-link">"Temporal autocorrelation in GAMs and the <code>mvgam</code> package"</a></p></li>
</ul></li>
<li><p><strong>Model Structure:</strong> Carefully think about how to structure linear predictor
effects (i.e. smooth terms using <code><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a>()</code>, <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">te</a>()</code>
or <code><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a>()</code>, GPs using <code><a href="https://paulbuerkner.com/brms/reference/gp.html" class="external-link">gp</a>()</code>, dynamic
time-varying effects using <code><a href="dynamic.html">dynamic()</a></code>, and parametric terms), latent temporal
trend components (see <code><a href="mvgam_trends.html">mvgam_trends</a></code>) and the appropriate
observation family (see <code><a href="mvgam_families.html">mvgam_families</a></code>). Use <code><a href="get_mvgam_priors.html">get_mvgam_priors()</a></code>
to see default prior distributions for stochastic parameters.</p></li>
<li><p><strong>Prior Specification:</strong> Change default priors using appropriate prior knowledge
(see <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a>()</code>). When using State-Space models with a
<code>trend_formula</code>, pay particular attention to priors for any variance parameters
such as process errors and observation errors. Default priors on these parameters
are chosen to be vaguely informative and to avoid zero (using Inverse Gamma
priors), but more informative priors will often help with model efficiency
and convergence.</p></li>
<li><p><strong>Model Fitting:</strong> Fit the model using either Hamiltonian Monte Carlo or an
approximation algorithm (i.e. change the <code>backend</code> argument) and use
<code><a href="summary.mvgam.html">summary.mvgam()</a></code>, <code><a href="conditional_effects.mvgam.html">conditional_effects.mvgam()</a></code>, <code><a href="mcmc_plot.mvgam.html">mcmc_plot.mvgam()</a></code>,
<code><a href="pp_check.mvgam.html">pp_check.mvgam()</a></code>, <code><a href="pairs.mvgam.html">pairs.mvgam()</a></code> and <code><a href="plot.mvgam.html">plot.mvgam()</a></code> to inspect /
interrogate the model.</p></li>
<li><p><strong>Model Comparison:</strong> Update the model as needed and use <code><a href="loo.mvgam.html">loo_compare.mvgam()</a></code>
for in-sample model comparisons, or alternatively use <code><a href="forecast.mvgam.html">forecast.mvgam()</a></code>,
<code><a href="lfo_cv.mvgam.html">lfo_cv.mvgam()</a></code> and <code><a href="score.mvgam_forecast.html">score.mvgam_forecast()</a></code> to compare models based on
out-of-sample forecasts (see the <a href="https://nicholasjclark.github.io/mvgam/articles/forecast_evaluation.html">forecast evaluation vignette</a>
for guidance).</p></li>
<li><p><strong>Inference and Prediction:</strong> When satisfied with the model structure, use
<code><a href="predict.mvgam.html">predict.mvgam()</a></code>, <code><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a>()</code> and/or
<code><a href="https://marginaleffects.com/man/r/plot_slopes.html" class="external-link">plot_slopes</a>()</code> for more targeted simulation-based
inferences (see <a href="https://ecogambler.netlify.app/blog/interpreting-gams/" class="external-link">"How to interpret and report nonlinear effects from Generalized Additive Models"</a>
for some guidance on interpreting GAMs). For time series models, use
<code><a href="hindcast.mvgam.html">hindcast.mvgam()</a></code>, <code><a href="fitted.mvgam.html">fitted.mvgam()</a></code>, <code><a href="augment.mvgam.html">augment.mvgam()</a></code> and <code><a href="forecast.mvgam.html">forecast.mvgam()</a></code>
to inspect posterior hindcast / forecast distributions.</p></li>
<li><p><strong>Documentation:</strong> Use <code><a href="how_to_cite.mvgam.html">how_to_cite()</a></code> to obtain a scaffold methods section
(with full references) to begin describing this model in scientific publications.</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Nicholas J Clark &amp; Konstans Wells (2023). Dynamic generalised additive models
(DGAMs) for forecasting discrete ecological time series. Methods in Ecology and
Evolution. 14:3, 771-784.</p>
<p>Nicholas J Clark, SK Morgan Ernest, Henry Senyondo, Juniper Simonis, Ethan P White,
Glenda M Yenni, KANK Karunarathna (2025). Beyond single-species models: leveraging
multispecies forecasts to navigate the dynamics of ecological predictability.
PeerJ. 13:e18929 https://doi.org/10.7717/peerj.18929</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/pkg/mgcv/man/jagam.html" class="external-link">jagam</a>()</code>, <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a>()</code>,
<code><a href="https://rdrr.io/pkg/mgcv/man/gam.models.html" class="external-link">gam.models</a></code>, <code><a href="get_mvgam_priors.html">get_mvgam_priors()</a></code>, <code><a href="jsdgam.html">jsdgam()</a></code>,
<code><a href="hindcast.mvgam.html">hindcast.mvgam()</a></code>, <code><a href="forecast.mvgam.html">forecast.mvgam()</a></code>, <code><a href="predict.mvgam.html">predict.mvgam()</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Nicholas J Clark</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Basic Multi-Series Time Series Modeling</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate three time series that have shared seasonal dynamics,</span></span></span>
<span class="r-in"><span><span class="co"># independent AR(1) trends, and Poisson observations</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  T <span class="op">=</span> <span class="fl">80</span>,</span></span>
<span class="r-in"><span>  n_series <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>  mu <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  prop_missing <span class="op">=</span> <span class="fl">0.1</span>,</span></span>
<span class="r-in"><span>  prop_trend <span class="op">=</span> <span class="fl">0.6</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot key summary statistics for a single series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot all series together</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>, series <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Formulate a model using Stan where series share a cyclic smooth for</span></span></span>
<span class="r-in"><span><span class="co"># seasonality and each series has an independent AR1 temporal process.</span></span></span>
<span class="r-in"><span><span class="co"># Note that 'noncentred = TRUE' will likely give performance gains.</span></span></span>
<span class="r-in"><span><span class="co"># Set run_model = FALSE to inspect the returned objects</span></span></span>
<span class="r-in"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">"cc"</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  run_model <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View the model code in Stan language</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">stancode</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># View the data objects needed to fit the model in Stan</span></span></span>
<span class="r-in"><span><span class="va">sdata1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/standata.html" class="external-link">standata</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">sdata1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now fit the model</span></span></span>
<span class="r-in"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">"cc"</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  noncentred <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract the model summary</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the historical trend and hindcast distributions for one series</span></span></span>
<span class="r-in"><span><span class="va">hc_trend</span> <span class="op">&lt;-</span> <span class="fu"><a href="hindcast.mvgam.html">hindcast</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"trend"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc_trend</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">hc_predicted</span> <span class="op">&lt;-</span> <span class="fu"><a href="hindcast.mvgam.html">hindcast</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hc_predicted</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Residual diagnostics</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"residuals"</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">resids</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fitted values and residuals can be added directly to the training data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute the forecast using covariate information in data_test</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">mod1</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fc_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fc_summary</span>, <span class="fl">12</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the estimated seasonal smooth function</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"smooths"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot estimated first derivatives of the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"smooths"</span>, derivatives <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot partial residuals of the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"smooths"</span>, residuals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot posterior realisations for the smooth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1</span>, type <span class="op">=</span> <span class="st">"smooths"</span>, realisations <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot conditional response predictions using marginaleffects</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod1</span>, condition <span class="op">=</span> <span class="st">"season"</span>, points <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate posterior predictive checks using bayesplot</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Extract observation model beta coefficient draws as a data.frame</span></span></span>
<span class="r-in"><span><span class="va">beta_draws_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod1</span>, variable <span class="op">=</span> <span class="st">"betas"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">beta_draws_df</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">beta_draws_df</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Investigate model fit</span></span></span>
<span class="r-in"><span><span class="va">mc.cores.def</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="va">mc.cores.def</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Vector Autoregressive (VAR) Models</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a model to the portal time series that uses a latent</span></span></span>
<span class="r-in"><span><span class="co"># Vector Autoregression of order 1</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">captures</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span>,</span></span>
<span class="r-in"><span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="va">trend</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">VAR</a></span><span class="op">(</span>cor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">portal_data</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the autoregressive coefficient distributions;</span></span></span>
<span class="r-in"><span><span class="co"># use 'dir = "v"' to arrange the order of facets correctly</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">mod</span>,</span></span>
<span class="r-in"><span>  variable <span class="op">=</span> <span class="st">'A'</span>,</span></span>
<span class="r-in"><span>  regex <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">'hist'</span>,</span></span>
<span class="r-in"><span>  facet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">'v'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the process error variance-covariance matrix in the same way</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/mcmc_plot.brmsfit.html" class="external-link">mcmc_plot</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">mod</span>,</span></span>
<span class="r-in"><span>  variable <span class="op">=</span> <span class="st">'Sigma'</span>,</span></span>
<span class="r-in"><span>  regex <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">'hist'</span>,</span></span>
<span class="r-in"><span>  facet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="st">'v'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate Generalized Impulse Response Functions for each series</span></span></span>
<span class="r-in"><span><span class="va">irfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="irf.mvgam.html">irf</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">mod</span>,</span></span>
<span class="r-in"><span>  h <span class="op">=</span> <span class="fl">12</span>,</span></span>
<span class="r-in"><span>  cumulative <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot some of them</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">irfs</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">irfs</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate forecast error variance decompositions for each series</span></span></span>
<span class="r-in"><span><span class="va">fevds</span> <span class="op">&lt;-</span> <span class="fu"><a href="fevd.mvgam.html">fevd</a></span><span class="op">(</span><span class="va">mod</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot median contributions to forecast error variance</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fevds</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Dynamic Factor Models</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now fit a model that uses two RW dynamic factors to model</span></span></span>
<span class="r-in"><span><span class="co"># the temporal dynamics of the four rodent species</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">captures</span> <span class="op">~</span> <span class="va">series</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">RW</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  use_lv <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  n_lv <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">portal_data</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the factors</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'factors'</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the hindcast distributions</span></span></span>
<span class="r-in"><span><span class="va">hcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="hindcast.mvgam.html">hindcast</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hcs</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hcs</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hcs</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hcs</span>, series <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use residual_cor() to calculate temporal correlations among the series</span></span></span>
<span class="r-in"><span><span class="co"># based on the factor loadings</span></span></span>
<span class="r-in"><span><span class="va">lvcors</span> <span class="op">&lt;-</span> <span class="fu"><a href="residual_cor.jsdgam.html">residual_cor</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="index-mvgam.html">names</a></span><span class="op">(</span><span class="va">lvcors</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lvcors</span><span class="op">$</span><span class="va">cor</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># For those correlations whose credible intervals did not include</span></span></span>
<span class="r-in"><span><span class="co"># zero, plot them as a correlation matrix (all other correlations</span></span></span>
<span class="r-in"><span><span class="co"># are shown as zero on this plot)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lvcors</span>, cluster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Shared Latent Trends with Custom Trend Mapping</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example of supplying a trend_map so that some series can share</span></span></span>
<span class="r-in"><span><span class="co"># latent trend processes</span></span></span>
<span class="r-in"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span>n_series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mod_data</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">data_train</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Here, we specify only two latent trends; series 1 and 2 share a trend,</span></span></span>
<span class="r-in"><span><span class="co"># while series 3 has its own unique latent trend</span></span></span>
<span class="r-in"><span><span class="va">trend_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">mod_data</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  trend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit the model using AR1 trends</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">"cc"</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  trend_map <span class="op">=</span> <span class="va">trend_map</span>,</span></span>
<span class="r-in"><span>  trend_model <span class="op">=</span> <span class="fu"><a href="RW.html">AR</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">mod_data</span>,</span></span>
<span class="r-in"><span>  return_model_data <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The mapping matrix is now supplied as data to the model in the 'Z' element</span></span></span>
<span class="r-in"><span><span class="va">mod</span><span class="op">$</span><span class="va">model_data</span><span class="op">$</span><span class="va">Z</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The first two series share an identical latent trend; the third is different</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="residual_cor.jsdgam.html">residual_cor</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"trend"</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"trend"</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"trend"</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Time-Varying (Dynamic) Coefficients</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example of how to use dynamic coefficients</span></span></span>
<span class="r-in"><span><span class="co"># Simulate a time-varying coefficient for the effect of temperature</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">200</span></span></span>
<span class="r-in"><span><span class="va">beta_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">beta_temp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.4</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">beta_temp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="va">beta_temp</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.0025</span>, sd <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">beta_temp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate a covariate called 'temp'</span></span></span>
<span class="r-in"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simulate some noisy Gaussian observations</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,</span></span>
<span class="r-in"><span>  mean <span class="op">=</span> <span class="fl">4</span> <span class="op">+</span> <span class="va">beta_temp</span> <span class="op">*</span> <span class="va">temp</span>,</span></span>
<span class="r-in"><span>  sd <span class="op">=</span> <span class="fl">0.5</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Gather necessary data into a data.frame; split into training / testing</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">temp</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">180</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">data_test</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fl">181</span><span class="op">:</span><span class="fl">200</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit the model using the dynamic() function</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">out</span> <span class="op">~</span> <span class="fu"><a href="dynamic.html">dynamic</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="va">temp</span>,</span></span>
<span class="r-in"><span>    scale <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>    k <span class="op">=</span> <span class="fl">40</span></span></span>
<span class="r-in"><span>  <span class="op">)</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">data_train</span>,</span></span>
<span class="r-in"><span>  newdata <span class="op">=</span> <span class="va">data_test</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect the model summary, forecast and time-varying coefficient distribution</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"smooths"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Propagating the smooth term shows how the coefficient is expected to evolve</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">mod</span>, smooth <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">180</span>, lty <span class="op">=</span> <span class="st">"dashed"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">beta_temp</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Working with Offset Terms</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example showing how to incorporate an offset; simulate some count data</span></span></span>
<span class="r-in"><span><span class="co"># with different means per series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  prop_trend <span class="op">=</span> <span class="fl">0</span>,</span></span>
<span class="r-in"><span>  mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  seasonality <span class="op">=</span> <span class="st">"hierarchical"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Add offset terms to the training and testing data</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a model that includes the offset in the linear predictor as well as</span></span></span>
<span class="r-in"><span><span class="co"># hierarchical seasonal smooths</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">offset</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">series</span>, bs <span class="op">=</span> <span class="st">"re"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, bs <span class="op">=</span> <span class="st">"cc"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">season</span>, by <span class="op">=</span> <span class="va">series</span>, m <span class="op">=</span> <span class="fl">1</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_train</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Inspect the model file to see the modification to the linear predictor (eta)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/stancode.html" class="external-link">stancode</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Forecasts for the first two series will differ in magnitude</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span>, series <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span>, series <span class="op">=</span> <span class="fl">2</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Changing the offset for the testing data should lead to changes in</span></span></span>
<span class="r-in"><span><span class="co"># the forecast</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">-</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fc</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Relative Risks can be computed by fixing the offset to the same value</span></span></span>
<span class="r-in"><span><span class="co"># for each series</span></span></span>
<span class="r-in"><span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">preds_rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">"link"</span>,</span></span>
<span class="r-in"><span>  newdata <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">data_test</span>,</span></span>
<span class="r-in"><span>  summary <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">series1_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span> <span class="op">==</span> <span class="st">"series_1"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">series2_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">data_test</span><span class="op">$</span><span class="va">series</span> <span class="op">==</span> <span class="st">"series_2"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Relative Risks are now more comparable among series</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="fl">1</span>, <span class="va">series1_inds</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"grey75"</span>,</span></span>
<span class="r-in"><span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  ylab <span class="op">=</span> <span class="st">"Series1 Relative Risk"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="va">i</span>, <span class="va">series1_inds</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"grey75"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="fl">1</span>, <span class="va">series2_inds</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"darkred"</span>,</span></span>
<span class="r-in"><span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  ylab <span class="op">=</span> <span class="st">"Series2 Relative Risk"</span>, xlab <span class="op">=</span> <span class="st">"Time"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">preds_rr</span><span class="op">[</span><span class="va">i</span>, <span class="va">series2_inds</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html" class="external-link">layout</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span><span class="co"># Binomial Family Models</span></span></span>
<span class="r-in"><span><span class="co"># =============================================================================</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example showcasing how cbind() is needed for Binomial observations</span></span></span>
<span class="r-in"><span><span class="co"># Simulate two time series of Binomial trials</span></span></span>
<span class="r-in"><span><span class="va">trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">detprob1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.9</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">detprob2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">-</span> <span class="fl">0.7</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">detprob1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>    series <span class="op">=</span> <span class="st">"series1"</span>,</span></span>
<span class="r-in"><span>    x <span class="op">=</span> <span class="va">x</span>,</span></span>
<span class="r-in"><span>    ntrials <span class="op">=</span> <span class="va">trials</span></span></span>
<span class="r-in"><span>  <span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">detprob2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span></span>
<span class="r-in"><span>    series <span class="op">=</span> <span class="st">"series2"</span>,</span></span>
<span class="r-in"><span>    x <span class="op">=</span> <span class="va">x</span>,</span></span>
<span class="r-in"><span>    ntrials <span class="op">=</span> <span class="va">trials</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dat</span>, series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">time</span>, <span class="va">series</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, series <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a model using the binomial() family; must specify observations</span></span></span>
<span class="r-in"><span><span class="co"># and number of trials in the cbind() wrapper</span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">mvgam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">ntrials</span><span class="op">)</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">dat</span>,</span></span>
<span class="r-in"><span>  chains <span class="op">=</span> <span class="fl">2</span>,</span></span>
<span class="r-in"><span>  silent <span class="op">=</span> <span class="fl">2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">"bars_grouped"</span>,</span></span>
<span class="r-in"><span>  group <span class="op">=</span> <span class="st">"series"</span>, ndraws <span class="op">=</span> <span class="fl">50</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pp_check.mvgam.html">pp_check</a></span><span class="op">(</span><span class="va">mod</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">"ecdf_overlay_grouped"</span>,</span></span>
<span class="r-in"><span>  group <span class="op">=</span> <span class="st">"series"</span>, ndraws <span class="op">=</span> <span class="fl">50</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To view predictions on the probability scale,</span></span></span>
<span class="r-in"><span><span class="co"># use ntrials = 1 in datagrid()</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">mod</span>,</span></span>
<span class="r-in"><span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'series'</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  newdata <span class="op">=</span> <span class="fu"><a href="https://marginaleffects.com/man/r/datagrid.html" class="external-link">datagrid</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    series <span class="op">=</span> <span class="va">unique</span>,</span></span>
<span class="r-in"><span>    ntrials <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  <span class="op">)</span>,</span></span>
<span class="r-in"><span>  type <span class="op">=</span> <span class="st">'expected'</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Not needed for general use; cleans up connections for automated testing</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/showConnections.html" class="external-link">closeAllConnections</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

